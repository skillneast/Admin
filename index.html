<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillNeast Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { padding: 10px; background-color: #f0f2f5; font-family: 'Open Sans', sans-serif; color: #333; }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h2, h5 { color: #007bff; font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .btn-primary { background-color: #007bff; border-color: #007bff; border-radius: 20px; padding: 8px 20px; }
        .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; border-radius: 15px; padding: 5px 12px; }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; border-radius: 15px; padding: 5px 12px; }
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
        .btn-success { background-color: #28a745; border-color: #28a745; border-radius: 15px; padding: 5px 12px; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; border-radius: 15px; padding: 5px 12px; }
        .btn-info:hover { background-color: #138496; border-color: #117a8b; }
        .form-control { border-radius: 8px; border: 1px solid #ced4da; padding: 10px; }
        .form-label { font-weight: 600; margin-bottom: 5px; }
        .alert { margin-top: 15px; border-radius: 8px; }
        .card { border-radius: 10px; border: 1px solid #e9ecef; margin-bottom: 20px; background-color: #fdfdfd; }
        .card-body { padding: 20px; }
        .cat-name, .batch-title, .module-name, .lecture-name { cursor: text; font-weight: 600; } 
        .batches-list, .modules-list, .lectures-list { margin-left: 20px; padding-left: 15px; border-left: 3px solid #e9ecef; margin-top: 10px; }
        img.thumbnail-preview { border-radius: 8px; object-fit: cover; width: 100px; height: 70px; margin-right: 15px; border: 1px solid #ddd; }
        input.form-control-sm { max-width: 300px; } 
        textarea.form-control { min-height: 80px; resize: vertical; }

        /* Custom Modal Styling (for alert/confirm replacements) */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060; /* Higher than Bootstrap modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-modal-content h5 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #343a40;
        }
        .custom-modal-content .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        /* Loading Spinner */
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1070;
            color: white;
            font-size: 1.2em;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .loading-spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-message {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">SkillNeast Admin Panel</h2>
        <div id="alerts"></div>

        <!-- Create Category Section -->
        <div class="mb-3 p-3 border rounded bg-light">
            <h5>Create Category</h5>
            <div class="mb-3">
                <label for="categoryName" class="form-label">Category Name</label>
                <input id="categoryName" type="text" class="form-control" placeholder="e.g., JEE Mains, NEET, Editing">
            </div>
            <div class="mb-3">
                <label for="categoryImageUrl" class="form-label">Category Image URL</label>
                <input type="url" class="form-control" id="categoryImageUrl" placeholder="e.g., https://example.com/image.jpg">
            </div>
            <button id="addCategory" class="btn btn-primary mt-2 w-100">Add Category</button>
        </div>

        <!-- Categories List Section -->
        <div id="categoriesList" class="mt-4"></div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div class="custom-modal-overlay" id="customConfirmModal">
        <div class="custom-modal-content">
            <h5 id="customConfirmMessage"></h5>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="customConfirmCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="customConfirmOK">OK</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner Overlay -->
    <div class="loading-spinner-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-message">Processing...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as dbRef, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";


        const firebaseConfig = {
          apiKey: "AIzaSyChwpbFb6M4HtG6zwjg0AXh7Lz9KjnrGZk",
          authDomain: "adminneast.firebaseapp.com",
          databaseURL: "https://adminneast-default-rtdb.firebaseio.com",
          projectId: "adminneast",
          storageBucket: "adminneast.appspot.com", 
          messagingSenderId: "883877553418",
          appId: "1:883877553418:web:84ce8200f4b471bfffc6f3",
          measurementId: "G-PCH99BDF1S"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let isAuthenticated = false;

        const authenticateFirebase = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    isAuthenticated = true;
                    console.log("Admin Panel: Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    isAuthenticated = true;
                    console.log("Admin Panel: Signed in anonymously.");
                }
            } catch (error) {
                console.error("Admin Panel Firebase authentication error:", error);
                msg(`Authentication failed: ${error.message}. Please check Firebase config & authorized domains.`, 'danger');
                isAuthenticated = false;
            }
        };


        const msg = (text, type = 'success') => {
            const alertsDiv = document.getElementById('alerts');
            const el = document.createElement('div');
            el.className = `alert alert-${type} fade show`;
            el.textContent = text;
            alertsDiv.append(el);
            setTimeout(() => {
                el.classList.remove('show');
                el.classList.add('fade');
                el.addEventListener('transitionend', () => el.remove(), { once: true });
            }, 3000);
        };

        const showConfirm = (message) => {
            return new Promise((resolve) => {
                const modalOverlay = document.getElementById('customConfirmModal');
                const modalMessage = document.getElementById('customConfirmMessage');
                const okButton = document.getElementById('customConfirmOK');
                const cancelButton = document.getElementById('customConfirmCancel');

                modalMessage.textContent = message;
                modalOverlay.classList.add('active');

                const handleConfirm = () => {
                    modalOverlay.classList.remove('active');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modalOverlay.classList.remove('active');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                okButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', handleCancel);
            });
        };

        const showLoading = (message = "Processing...") => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.querySelector('.loading-message').textContent = message;
            loadingOverlay.classList.add('active');
        };

        const hideLoading = () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('active');
        };

        const loadCategories = () => {
            const catRef = dbRef(db, 'categories');
            onValue(catRef, snapshot => {
                const data = snapshot.val() || {};
                renderCategories(data);
            }, (error) => {
                msg(`Error loading categories: ${error.message}`, 'danger');
            });
        };

        const renderCategories = (cats) => {
            const container = document.getElementById('categoriesList');
            container.innerHTML = ''; // Clear container for fresh render

            if (Object.keys(cats).length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No categories added yet. Start by creating one above!</p>';
                return;
            }

            const accordionId = 'categoriesAccordion';
            let accordionHtml = `<div class="accordion" id="${accordionId}">`;

            Object.entries(cats).forEach(([catId, cat]) => {
                accordionHtml += `
                    <div class="accordion-item card">
                        <h2 class="accordion-header" id="heading-${catId}">
                            <button class="accordion-button ${cat.collapsed ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${catId}" aria-expanded="${!cat.collapsed}" aria-controls="collapse-${catId}">
                                <span contenteditable="true" data-id="${catId}" class="cat-name flex-grow-1 me-2">${cat.name}</span>
                                <button class="btn btn-danger btn-sm delete-cat me-2" data-id="${catId}">Delete Category</button>
                            </button>
                        </h2>
                        <div id="collapse-${catId}" class="accordion-collapse collapse ${cat.collapsed ? '' : 'show'}" aria-labelledby="heading-${catId}" data-bs-parent="#${accordionId}">
                            <div class="accordion-body card-body">
                                <div class="mb-3">
                                    <label for="categoryImageUrl-${catId}" class="form-label">Category Image URL:</label>
                                    ${cat.imageUrl ? `<img src="${cat.imageUrl}" alt="Category Image" class="thumbnail-preview">` : '<p class="text-muted">No image selected.</p>'}
                                    <input type="url" class="form-control form-control-sm mt-2 category-image-url" id="categoryImageUrl-${catId}" data-id="${catId}" value="${cat.imageUrl || ''}" placeholder="e.g., https://example.com/image.jpg">
                                </div>
                                <hr>
                                <h6 class="mb-2 text-muted">Batches:</h6>
                                <div>
                                    <button class="btn btn-secondary btn-sm mb-2 add-batch" data-id="${catId}">+ Add Batch</button>
                                    <div class="batches-list" id="batches-list-${catId}"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            accordionHtml += `</div>`;
            container.innerHTML = accordionHtml;

            // Setup events for dynamically added accordion items
            Object.entries(cats).forEach(([catId, cat]) => {
                const cardElement = container.querySelector(`#heading-${catId}`).closest('.card');
                setupCategoryEvents(cardElement, catId, cat.imageUrl);
            });
        };

        const setupCategoryEvents = (card, catId, currentImageUrl) => {
            const nameEl = card.querySelector('.cat-name');
            nameEl.addEventListener('blur', async () => {
                const newName = nameEl.textContent.trim();
                if (newName && newName !== nameEl.dataset.originalName) {
                    try {
                        await update(dbRef(db, `categories/${catId}`), { name: newName });
                        msg('Category name updated', 'info');
                    } catch (error) {
                        msg(`Error updating category name: ${error.message}`, 'danger');
                    }
                }
                nameEl.dataset.originalName = newName;
            });
            nameEl.dataset.originalName = nameEl.textContent.trim();

            const imageUrlInput = card.querySelector('.category-image-url');
            imageUrlInput.addEventListener('change', async (e) => {
                const newImageUrl = e.target.value.trim();
                try {
                    await update(dbRef(db, `categories/${catId}`), { imageUrl: newImageUrl });
                    msg('Category image URL updated successfully!', 'success');
                } catch (error) {
                    msg(`Error updating category image URL: ${error.message}`, 'danger');
                }
            });

            card.querySelector('.delete-cat').addEventListener('click', async (e) => {
                const confirmDelete = await showConfirm('Are you sure you want to delete this category and all its contents (batches, modules, lectures)?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting category and content...');
                        await remove(dbRef(db, `categories/${catId}`));
                        msg('Category and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting category: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            card.querySelector('.add-batch').onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const title = prompt('Enter Batch title:');
                if (!title) { msg('Batch title is required!', 'warning'); return; }
                
                const thumbnailUrl = prompt('Enter Thumbnail URL (e.g., https://via.placeholder.com/150):');
                if (!thumbnailUrl) { msg('Thumbnail URL is required!', 'warning'); return; }

                const description = prompt('Enter Batch description (max 100 words):');
                if (!description) { msg('Batch description is required!', 'warning'); return; }
                if (description.split(/\s+/).length > 100) { msg('Description exceeds 100 words! Please re-enter.', 'warning'); return; }

                let originalPrice = prompt('Enter Original Price (e.g., 999 or leave empty if free):');
                let discountedPrice = prompt('Enter Discounted Price (e.g., 499 or 0 for FREE):');
                
                originalPrice = originalPrice ? parseFloat(originalPrice) : null;
                discountedPrice = discountedPrice ? parseFloat(discountedPrice) : null;
                const isFree = (discountedPrice === 0) || (originalPrice === null && discountedPrice === null);

                try {
                    showLoading('Adding batch...');
                    const newRef = push(dbRef(db, `categories/${catId}/batches`));
                    await set(newRef, { 
                        title, 
                        thumbnail: thumbnailUrl, 
                        description,
                        originalPrice: originalPrice,
                        discountedPrice: discountedPrice,
                        isFree: isFree,
                        isNew: true,
                        isCompleted: false 
                    });
                    msg('Batch added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding batch: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };

            const batchesListContainer = card.querySelector(`#batches-list-${catId}`);
            // This onValue listener needs to be set up after the accordion is rendered
            onValue(dbRef(db, `categories/${catId}/batches`), snapshot => {
                batchesListContainer.innerHTML = '';
                const batchData = snapshot.val() || {};
                if (Object.keys(batchData).length === 0) {
                    batchesListContainer.innerHTML = '<p class="text-muted fst-italic">No batches in this category.</p>';
                }
                Object.entries(batchData).forEach(([bId, batch]) => {
                    const item = createBatchItem(catId, bId, batch);
                    batchesListContainer.append(item);
                });
            }, (error) => {
                msg(`Error loading batches for category ${catId}: ${error.message}`, 'danger');
            });
        };

        const createBatchItem = (catId, bId, batch) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 bg-light';
            
            const displayPrice = (batch.isFree || (batch.originalPrice === null && batch.discountedPrice === null)) ? '<span class="fw-bold text-success">FREE</span>' :
                                 (batch.discountedPrice !== null ? `₹${batch.discountedPrice}` : (batch.originalPrice !== null ? `₹${batch.originalPrice}` : 'Price N/A'));
            const originalPriceStrikethrough = (batch.originalPrice !== null && batch.discountedPrice !== null && batch.discountedPrice < batch.originalPrice) ? `<s class="text-muted ms-2">₹${batch.originalPrice}</s>` : '';


            div.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <img src="${batch.thumbnail}" alt="Thumbnail" width="60" height="40" class="thumbnail-preview" onerror="this.onerror=null;this.src='https://via.placeholder.com/60x40/cccccc/333333?text=NoImg';" />
                        <input class="form-control form-control-sm batch-title flex-grow-1 me-2" data-cat="${catId}" data-bid="${bId}" value="${batch.title}">
                        <button class="btn btn-sm btn-danger delete-batch" data-cat="${catId}" data-bid="${bId}">Delete</button>
                    </div>
                    <div class="mb-2">
                        <label for="batchDescription-${bId}" class="form-label visually-hidden">Description</label>
                        <textarea class="form-control form-control-sm batch-description" id="batchDescription-${bId}" data-cat="${catId}" data-bid="${bId}" placeholder="Batch Description (max 100 words)">${batch.description || ''}</textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="w-50 me-2">
                            <label for="batchOriginalPrice-${bId}" class="form-label">Original Price</label>
                            <input type="number" class="form-control form-control-sm batch-original-price" id="batchOriginalPrice-${bId}" data-cat="${catId}" data-bid="${bId}" value="${batch.originalPrice !== null ? batch.originalPrice : ''}" placeholder="e.g., 999">
                        </div>
                        <div class="w-50">
                            <label for="batchDiscountedPrice-${bId}" class="form-label">Discounted Price</label>
                            <input type="number" class="form-control form-control-sm batch-discounted-price" id="batchDiscountedPrice-${bId}" data-cat="${catId}" data-bid="${bId}" value="${batch.discountedPrice !== null ? batch.discountedPrice : ''}" placeholder="e.g., 499 (0 for FREE)">
                        </div>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input batch-is-free" type="checkbox" role="switch" id="isFreeSwitch-${bId}" data-cat="${catId}" data-bid="${bId}" ${batch.isFree ? 'checked' : ''}>
                        <label class="form-check-label" for="isFreeSwitch-${bId}">Mark as FREE</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input batch-is-completed" type="checkbox" role="switch" id="isCompletedSwitch-${bId}" data-cat="${catId}" data-bid="${bId}" ${batch.isCompleted ? 'checked' : ''}>
                        <label class="form-check-label" for="isCompletedSwitch-${bId}">Mark as Completed</label>
                    </div>
                    <div class="text-end fw-bold mb-2">
                        Current Price: ${displayPrice} ${originalPriceStrikethrough}
                    </div>

                    <hr class="my-2">
                    <h6 class="mb-2 text-muted">Modules:</h6>
                    <button class="btn btn-sm btn-info toggle-modules-btn mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#modules-collapse-${bId}" aria-expanded="${!batch.isCompleted}" aria-controls="modules-collapse-${bId}">
                        ${batch.isCompleted ? 'View Modules' : 'Hide Modules'} <i class="fas ${batch.isCompleted ? 'fa-chevron-down' : 'fa-chevron-up'}"></i>
                    </button>
                    <div class="modules-list collapse ${batch.isCompleted ? '' : 'show'}" id="modules-collapse-${bId}"></div>
                </div>`;
            setupBatchEvents(div);
            return div;
        };

        const setupBatchEvents = (div) => {
            const batchTitleInput = div.querySelector('.batch-title');
            const batchDescriptionInput = div.querySelector('.batch-description');
            const batchOriginalPriceInput = div.querySelector('.batch-original-price');
            const batchDiscountedPriceInput = div.querySelector('.batch-discounted-price');
            const batchIsFreeSwitch = div.querySelector('.batch-is-free');
            const batchIsCompletedSwitch = div.querySelector('.batch-is-completed'); 
            const toggleModulesBtn = div.querySelector('.toggle-modules-btn');
            const modulesListContainer = div.querySelector('.modules-list');

            const { cat, bid } = batchTitleInput.dataset;

            batchTitleInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { title: e.target.value });
                msg('Batch title updated', 'info');
            });

            batchDescriptionInput.addEventListener('change', async e => {
                if (e.target.value.split(/\s+/).length > 100) {
                    msg('Description exceeds 100 words! Changes not saved.', 'warning');
                    return; 
                }
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { description: e.target.value });
                msg('Batch description updated', 'info');
            });

            batchOriginalPriceInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { originalPrice: parseFloat(e.target.value) || null });
                msg('Batch original price updated', 'info');
            });

            batchDiscountedPriceInput.addEventListener('change', async e => {
                const newDiscountedPrice = parseFloat(e.target.value);
                const isFree = newDiscountedPrice === 0;
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { 
                    discountedPrice: newDiscountedPrice || null,
                    isFree: isFree
                });
                batchIsFreeSwitch.checked = isFree; 
                msg('Batch discounted price updated', 'info');
            });

            batchIsFreeSwitch.addEventListener('change', async e => {
                const isFree = e.target.checked;
                let updateData = { isFree: isFree };
                if (isFree) {
                    updateData.discountedPrice = 0; 
                    batchDiscountedPriceInput.value = '0'; 
                    msg('Batch marked as FREE', 'info');
                } else {
                    if (parseFloat(batchDiscountedPriceInput.value) === 0) {
                        updateData.discountedPrice = null; 
                        batchDiscountedPriceInput.value = '';
                    }
                    msg('Batch FREE status updated', 'info');
                }
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), updateData);
            });

            // Handle isCompleted switch change
            batchIsCompletedSwitch.addEventListener('change', async e => {
                const isCompleted = e.target.checked;
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { isCompleted: isCompleted });
                msg(`Batch marked as ${isCompleted ? 'Completed' : 'Incomplete'}`, 'info');

                // Toggle visibility/collapse of modules list
                if (isCompleted) {
                    modulesListContainer.classList.remove('show');
                    toggleModulesBtn.innerHTML = 'View Modules <i class="fas fa-chevron-down"></i>';
                    toggleModulesBtn.setAttribute('aria-expanded', 'false');
                } else {
                    modulesListContainer.classList.add('show');
                    toggleModulesBtn.innerHTML = 'Hide Modules <i class="fas fa-chevron-up"></i>';
                    toggleModulesBtn.setAttribute('aria-expanded', 'true');
                }
            });

            // Set initial state for toggle button based on isCompleted
            if (batchIsCompletedSwitch.checked) {
                modulesListContainer.classList.remove('show'); // Hide if completed
                toggleModulesBtn.innerHTML = 'View Modules <i class="fas fa-chevron-down"></i>';
                toggleModulesBtn.setAttribute('aria-expanded', 'false');
            } else {
                modulesListContainer.classList.add('show'); // Show if not completed
                toggleModulesBtn.innerHTML = 'Hide Modules <i class="fas fa-chevron-up"></i>';
                toggleModulesBtn.setAttribute('aria-expanded', 'true');
            }


            div.querySelector('.delete-batch').onclick = async e => {
                const confirmDelete = await showConfirm('Delete this batch and all its modules/lectures?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting batch and content...');
                        await remove(dbRef(db, `categories/${cat}/batches/${bid}`));
                        msg('Batch deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting batch: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            };

            div.querySelector('.add-module').onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const moduleName = prompt('Enter Module name:');
                if (!moduleName) { msg('Module name is required!', 'warning'); return; }
                
                showLoading('Adding module...');
                try {
                    const newModRef = push(dbRef(db, `categories/${cat}/batches/${bid}/modules`));
                    await set(newModRef, { name: moduleName });
                    msg('Module added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding module: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };

            // This onValue listener is inside setupBatchEvents, so it will be called for each batch
            onValue(dbRef(db, `categories/${cat}/batches/${bid}/modules`), snap => {
                modulesListContainer.innerHTML = '';
                const mods = snap.val() || {};
                if (Object.keys(mods).length === 0) {
                    modulesListContainer.innerHTML = '<p class="text-muted fst-italic">No modules in this batch.</p>';
                }
                Object.entries(mods).forEach(([mId, mod]) => {
                    const modEl = createModuleItem(cat, bid, mId, mod);
                    modulesListContainer.append(modEl);
                });
            }, (error) => {
                msg(`Error loading modules for batch ${bid}: ${error.message}`, 'danger');
            });
        };

        const createModuleItem = (cat, bid, mid, mod) => {
            const d = document.createElement('div');
            d.className = 'card mb-1 bg-white';
            d.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <input class="form-control form-control-sm module-name flex-grow-1 me-2" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" value="${mod.name}">
                        <button class="btn btn-sm btn-danger delete-module me-1" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}">Delete</button>
                        <button class="btn btn-sm btn-success add-lecture" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}">+ Add Lecture</button>
                    </div>
                    <div class="lectures-list mt-2" id="lectures-list-${mid}"></div>
                </div>`;
            setupModuleEvents(d);
            return d;
        };

        const setupModuleEvents = (d) => {
            const moduleNameInput = d.querySelector('.module-name');
            const { cat, bid, mid } = moduleNameInput.dataset;

            moduleNameInput.addEventListener('change', async () => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}`), { name: moduleNameInput.value });
                msg('Module name updated', 'info');
            });

            d.querySelector('.delete-module').onclick = async () => {
                const confirmDelete = await showConfirm('Delete this module and all its lectures?');
                if (confirmDelete) {
                    await remove(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}`));
                    msg('Module deleted!', 'danger');
                }
            };

            d.querySelector('.add-lecture').onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const lname = prompt('Enter Lecture name:');
                if (!lname) { msg('Lecture name is required!', 'warning'); return; }
                const link = prompt('Enter Google Drive or YouTube Link (e.g., https://drive.google.com/file/d/YOUR_ID/preview or https://www.youtube.com/watch?v=YOUR_ID):');
                if (!link) { msg('Lecture link is required!', 'warning'); return; }
                
                showLoading('Adding lecture...');
                try {
                    const newLRef = push(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures`));
                    await set(newLRef, { name: lname, link });
                    msg('Lecture added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding lecture: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };

            const lecturesListContainer = d.querySelector(`#lectures-list-${mid}`);
            onValue(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures`), snap => {
                lecturesListContainer.innerHTML = '';
                const lcs = snap.val() || {};
                if (Object.keys(lcs).length === 0) {
                    lecturesListContainer.innerHTML = '<p class="text-muted fst-italic">No lectures in this module.</p>';
                }
                Object.entries(lcs).forEach(([lId, lec]) => {
                    const item = document.createElement('div');
                    item.className = 'd-flex align-items-center bg-light p-1 rounded mb-1';
                    item.innerHTML = `
                        <span class="flex-grow-1 lecture-name" contenteditable="true" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" data-lid="${lId}">${lec.name}</span>
                        <a href="${lec.link}" target="_blank" class="btn btn-sm btn-info mx-1 lecture-link" title="View Lecture" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" data-lid="${lId}" data-current-link="${lec.link}">🔗</a>
                        <button class="btn btn-sm btn-danger delete-lecture" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" data-lid="${lId}">X</button>
                    `;
                    // Setup events for lecture name and link
                    const lectureNameEl = item.querySelector('.lecture-name');
                    lectureNameEl.addEventListener('blur', async () => {
                        const newName = lectureNameEl.textContent.trim();
                        if (newName) {
                            try {
                                await update(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures/${lId}`), { name: newName });
                                msg('Lecture name updated', 'info');
                            } catch (error) {
                                msg(`Error updating lecture name: ${error.message}`, 'danger');
                            }
                        } else {
                            msg('Lecture name cannot be empty!', 'warning');
                            lectureNameEl.textContent = lec.name; // Revert if empty
                        }
                    });

                    const lectureLinkEl = item.querySelector('.lecture-link');
                    lectureLinkEl.addEventListener('click', async (e) => {
                        e.preventDefault(); // Prevent default link behavior initially
                        const currentLink = e.target.dataset.currentLink;
                        const newLink = prompt('Update Lecture Link:', currentLink);
                        if (newLink && newLink !== currentLink) {
                            try {
                                await update(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures/${lId}`), { link: newLink });
                                msg('Lecture link updated', 'info');
                                e.target.dataset.currentLink = newLink; // Update dataset
                                e.target.href = newLink; // Update href
                            } catch (error) {
                                msg(`Error updating lecture link: ${error.message}`, 'danger');
                            }
                        } else if (newLink === currentLink) {
                            // If link is the same, just open it normally
                             window.open(newLink, '_blank');
                        }
                    });

                    item.querySelector('.delete-lecture').onclick = async e => {
                        const ds = e.target.dataset;
                        const confirmDelete = await showConfirm('Delete this lecture?');
                        if (confirmDelete) {
                            await remove(dbRef(db, `categories/${ds.cat}/batches/${ds.bid}/modules/${ds.mid}/lectures/${ds.lid}`))
                                .then(() => msg('Lecture deleted!', 'danger'))
                                .catch(error => msg(`Error deleting lecture: ${error.message}`, 'danger'));
                        }
                    };
                    lecturesListContainer.append(item);
                });
            }, (error) => {
                msg(`Error loading lectures: ${error.message}`, 'danger');
            });
        };

        // Add Category event
        document.getElementById('addCategory').onclick = async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

            const name = document.getElementById('categoryName').value.trim();
            if (!name) return msg('Category name required!', 'warning');
            
            const imageUrl = document.getElementById('categoryImageUrl').value.trim();
            if (!imageUrl) { msg('Category Image URL is required!', 'warning'); return; }

            showLoading('Adding category...');
            try {
                const newRef = push(dbRef(db, 'categories'));
                await set(newRef, { name, imageUrl: imageUrl, collapsed: false }); // Default to expanded
                msg('Category added!', 'success');
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryImageUrl').value = '';
            } catch (error) {
                msg(`Error adding category: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Initial load
        authenticateFirebase().then(() => {
            loadCategories();
        });
    </script>
</body>
</html>
