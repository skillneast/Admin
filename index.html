<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillNeast Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { padding: 10px; background-color: #f0f2f5; font-family: 'Open Sans', sans-serif; color: #333; }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h2, h5 { color: #007bff; font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .btn-primary { background-color: #007bff; border-color: #007bff; border-radius: 20px; padding: 8px 20px; }
        .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
        .form-label { font-weight: 500; }
        .card { border: none; border-radius: 10px; margin-bottom: 15px; }
        .card-header { background-color: #e9ecef; border-bottom: none; border-radius: 10px 10px 0 0; padding: 10px 15px; font-weight: 600; }
        .card-body { padding: 15px; }
        .list-group-item { background-color: #f8f9fa; border: 1px solid #e9ecef; margin-bottom: 5px; border-radius: 8px; }
        .form-control-sm { border-radius: 5px; }
        .badge { font-size: 0.8em; padding: 0.4em 0.7em; border-radius: 12px; }
        .thumbnail-preview {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            min-width: 200px;
            background-color: #28a745; /* Success default */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
        }
        .toast.warning { background-color: #ffc107; }
        .toast.danger { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        .modal-dialog { max-width: 500px; }
        .modal-content { border-radius: 10px; }
        .btn-outline-secondary { border-radius: 20px; }
        .btn-success { background-color: #28a745; border-color: #28a745; border-radius: 20px; padding: 8px 20px; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; border-radius: 20px; padding: 5px 15px; font-size: 0.9em; }
        .site-config-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }
        .category-card, .batch-card, .module-card, .lecture-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="loading-spinner"></div>
        <p class="mt-3" id="loadingMessage">Loading...</p>
    </div>
    <div class="toast-container"></div>

    <div class="container mt-4">
        <h2 class="mb-4 text-center">SkillNeast Admin Panel</h2>

        <div id="authSection" class="mb-4">
            <h5 class="mb-3">Admin Login</h5>
            <div class="mb-3">
                <label for="adminEmail" class="form-label">Email address</label>
                <input type="email" class="form-control" id="adminEmail" placeholder="Enter email">
            </div>
            <div class="mb-3">
                <label for="adminPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="adminPassword" placeholder="Password">
            </div>
            <button id="loginButton" class="btn btn-primary">Login</button>
            <button id="logoutButton" class="btn btn-outline-secondary d-none ms-2">Logout</button>
        </div>

        <div id="mainContent" class="d-none">
            <div class="site-config-section mb-4">
                <h5 class="mb-3">Site Configuration</h5>
                <div class="mb-3">
                    <label for="siteName" class="form-label">Site Name</label>
                    <input type="text" class="form-control" id="siteName" placeholder="e.g., SkillNeast">
                </div>
                <div class="mb-3">
                    <label for="telegramLink" class="form-label">Telegram Link</label>
                    <input type="url" class="form-control" id="telegramLink" placeholder="e.g., https://t.me/yourskillneast">
                </div>
                <div class="mb-3">
                    <label for="contactEmail" class="form-label">Contact Email</label>
                    <input type="email" class="form-control" id="contactEmail" placeholder="e.g., info@skillneast.com">
                </div>
                <div class="mb-3">
                    <label for="instagramLink" class="form-label">Instagram Link</label>
                    <input type="url" class="form-control" id="instagramLink" placeholder="e.g., https://instagram.com/skillneast">
                </div>
                <button id="saveSiteConfig" class="btn btn-primary">Save Site Config</button>
            </div>

            <h5 class="mb-3">Category Management</h5>
            <div class="mb-3 d-flex">
                <input type="text" class="form-control me-2" id="categoryName" placeholder="New Category Name">
                <input type="url" class="form-control me-2" id="categoryImageUrl" placeholder="Category Image URL">
                <button id="addCategory" class="btn btn-primary">Add Category</button>
            </div>
            <div id="categoriesList" class="mb-4">
                </div>
        </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationMessage">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as dbRef, onValue, set, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        // Your Firebase client configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyChwpbFb6M4HtG6zwjg0AXh7Lz9KjnrGZk",
            authDomain: "adminneast.firebaseapp.com",
            databaseURL: "https://adminneast-default-rtdb.firebaseio.com",
            projectId: "adminneast",
            storageBucket: "adminneast.firebasestorage.app",
            messagingSenderId: "883877553418",
            appId: "1:883877553418:web:84ce8200f4b471bfffc6f3",
            measurementId: "G-PCH99BDF1S"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let isAuthenticated = false;
        let confirmActionResolve;

        // Utility functions
        const showLoading = (message = 'Loading...') => {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        };

        const hideLoading = () => {
            document.getElementById('loadingOverlay').style.display = 'none';
        };

        const msg = (message, type = 'success') => {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        };

        const showConfirm = (message) => {
            return new Promise((resolve) => {
                document.getElementById('confirmationMessage').textContent = message;
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                confirmModal.show();
                confirmActionResolve = resolve;
            });
        };

        document.getElementById('confirmActionButton').addEventListener('click', () => {
            if (confirmActionResolve) {
                confirmActionResolve(true);
                bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
            }
        });
        document.getElementById('confirmationModal').addEventListener('hide.bs.modal', () => {
            if (confirmActionResolve) {
                confirmActionResolve(false); // Resolve with false if modal is closed without confirming
                confirmActionResolve = null;
            }
        });

        // Authentication logic
        const authenticateFirebase = async () => {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthenticated = true;
                        document.getElementById('authSection').classList.add('d-none');
                        document.getElementById('mainContent').classList.remove('d-none');
                        document.getElementById('logoutButton').classList.remove('d-none');
                        msg('Logged in successfully!', 'success');
                    } else {
                        isAuthenticated = false;
                        document.getElementById('authSection').classList.remove('d-none');
                        document.getElementById('mainContent').classList.add('d-none');
                        document.getElementById('logoutButton').classList.add('d-none');
                        msg('Please log in to manage content.', 'info');
                    }
                    resolve();
                });
            });
        };

        document.getElementById('loginButton').onclick = async () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                msg('Please enter both email and password.', 'warning');
                return;
            }

            showLoading('Logging in...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI update
            } catch (error) {
                msg(`Login failed: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        document.getElementById('logoutButton').onclick = async () => {
            showLoading('Logging out...');
            try {
                await signOut(auth);
                msg('Logged out successfully!', 'info');
            } catch (error) {
                msg(`Logout failed: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Site Config Management
        const siteConfigRef = dbRef(db, 'siteConfig');

        const loadSiteConfig = () => {
            onValue(siteConfigRef, (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    document.getElementById('siteName').value = config.siteName || '';
                    document.getElementById('telegramLink').value = config.telegramLink || '';
                    document.getElementById('contactEmail').value = config.contactEmail || '';
                    document.getElementById('instagramLink').value = config.instagramLink || '';
                }
            });
        };

        const setupSiteConfigEvents = () => {
            document.getElementById('saveSiteConfig').onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const siteName = document.getElementById('siteName').value.trim();
                const telegramLink = document.getElementById('telegramLink').value.trim();
                const contactEmail = document.getElementById('contactEmail').value.trim();
                const instagramLink = document.getElementById('instagramLink').value.trim();

                showLoading('Saving site configuration...');
                try {
                    await set(siteConfigRef, {
                        siteName: siteName,
                        telegramLink: telegramLink,
                        contactEmail: contactEmail,
                        instagramLink: instagramLink
                    });
                    msg('Site configuration saved!', 'success');
                } catch (error) {
                    msg(`Error saving config: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };
        };

        // Category & Batch Management
        const categoriesRef = dbRef(db, 'categories');

        const loadCategories = () => {
            onValue(categoriesRef, (snapshot) => {
                const categories = snapshot.val();
                const categoriesList = document.getElementById('categoriesList');
                categoriesList.innerHTML = '';
                if (categories) {
                    Object.entries(categories).forEach(([catId, category]) => {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'card mb-3';
                        categoryDiv.innerHTML = `
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span class="category-name-display">${category.name}</span>
                                <input type="text" class="form-control form-control-sm category-name-input d-none flex-grow-1 me-2" value="${category.name}" data-cat="${catId}">
                                <div class="d-flex align-items-center">
                                    <img src="${category.imageUrl}" alt="Category Thumbnail" width="40" height="25" class="thumbnail-preview me-2" onerror="this.onerror=null;this.src='https://via.placeholder.com/40x25/cccccc/333333?text=NoImg';"/>
                                    <input type="url" class="form-control form-control-sm category-image-input d-none me-2" value="${category.imageUrl}" data-cat="${catId}" placeholder="Image URL">
                                    <button class="btn btn-sm btn-info edit-category-image me-2" data-cat="${catId}">Edit Img</button>
                                    <button class="btn btn-sm btn-warning edit-category me-2" data-cat="${catId}">Edit</button>
                                    <button class="btn btn-sm btn-danger delete-category" data-cat="${catId}">Delete</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="mb-2 text-muted">Batches:</h6>
                                <button class="btn btn-sm btn-success add-batch mb-3" data-cat="${catId}">+ Add Batch</button>
                                <div class="batches-list" id="batches-list-${catId}"></div>
                            </div>
                        `;
                        categoriesList.appendChild(categoryDiv);

                        loadBatches(catId);
                        setupCategoryEvents(categoryDiv, catId);
                    });
                }
            });
        };

        const setupCategoryEvents = (div, catId) => {
            const categoryNameDisplay = div.querySelector('.category-name-display');
            const categoryNameInput = div.querySelector('.category-name-input');
            const categoryImageInput = div.querySelector('.category-image-input');
            const editButton = div.querySelector('.edit-category');
            const editImageButton = div.querySelector('.edit-category-image');
            const deleteButton = div.querySelector('.delete-category');
            const addBatchButton = div.querySelector('.add-batch');

            editButton.onclick = () => {
                if (editButton.textContent === 'Edit') {
                    categoryNameDisplay.classList.add('d-none');
                    categoryNameInput.classList.remove('d-none');
                    editButton.textContent = 'Save';
                } else {
                    const newName = categoryNameInput.value.trim();
                    if (newName && newName !== categoryNameDisplay.textContent) {
                        update(dbRef(db, `categories/${catId}`), { name: newName })
                            .then(() => msg('Category name updated!', 'success'))
                            .catch(error => msg(`Error updating category name: ${error.message}`, 'danger'));
                    }
                    categoryNameDisplay.textContent = newName;
                    categoryNameDisplay.classList.remove('d-none');
                    categoryNameInput.classList.add('d-none');
                    editButton.textContent = 'Edit';
                }
            };

            editImageButton.onclick = () => {
                if (editImageButton.textContent === 'Edit Img') {
                    div.querySelector('.thumbnail-preview').classList.add('d-none');
                    categoryImageInput.classList.remove('d-none');
                    editImageButton.textContent = 'Save Img';
                } else {
                    const newImageUrl = categoryImageInput.value.trim();
                    if (newImageUrl) {
                        update(dbRef(db, `categories/${catId}`), { imageUrl: newImageUrl })
                            .then(() => msg('Category image updated!', 'success'))
                            .catch(error => msg(`Error updating category image: ${error.message}`, 'danger'));
                    }
                    div.querySelector('.thumbnail-preview').src = newImageUrl;
                    div.querySelector('.thumbnail-preview').classList.remove('d-none');
                    categoryImageInput.classList.add('d-none');
                    editImageButton.textContent = 'Edit Img';
                }
            };

            deleteButton.onclick = async () => {
                const confirmDelete = await showConfirm('Delete this category and all its batches, modules, and lectures?');
                if (confirmDelete) {
                    showLoading('Deleting category...');
                    try {
                        await remove(dbRef(db, `categories/${catId}`));
                        msg('Category deleted!', 'success');
                    } catch (error) {
                        msg(`Error deleting category: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            };

            addBatchButton.onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const title = prompt('Enter Batch Title:');
                if (!title) return;
                const thumbnail = prompt('Enter Batch Thumbnail URL:');
                if (!thumbnail) return;
                const headerColor = prompt('Enter Batch Header Color (e.g., #FF5733):') || '#00ADB5'; // Default color
                const originalPrice = prompt('Enter Original Price (optional, leave blank if not applicable):');
                const discountedPrice = prompt('Enter Discounted Price (optional, leave blank if not applicable):');
                const isFree = confirm('Mark as FREE?');

                showLoading('Adding batch...');
                try {
                    const newRef = push(dbRef(db, `categories/${catId}/batches`));
                    await set(newRef, {
                        title: title,
                        thumbnail: thumbnail,
                        headerColor: headerColor,
                        originalPrice: originalPrice ? parseFloat(originalPrice) : null,
                        discountedPrice: discountedPrice ? parseFloat(discountedPrice) : null,
                        isFree: isFree,
                        isNew: true,
                        sellerTelegramLink: prompt('Enter Seller Telegram Link (optional):') || ''
                    });
                    msg('Batch added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding batch: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };
        };

        const loadBatches = (catId) => {
            const batchesRef = dbRef(db, `categories/${catId}/batches`);
            onValue(batchesRef, (snapshot) => {
                const batches = snapshot.val();
                const batchesList = document.getElementById(`batches-list-${catId}`);
                batchesList.innerHTML = '';
                if (batches) {
                    Object.entries(batches).forEach(([bId, batch]) => {
                        const div = createBatchItem(catId, bId, batch);
                        batchesList.appendChild(div);
                    });
                }
            });
        };

        const createBatchItem = (catId, bId, batch) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 bg-light';
            
            // Determine the display for the price/button
            let priceOrButtonHTML = '';
            if (batch.isFree || (batch.originalPrice === null && batch.discountedPrice === null)) {
                priceOrButtonHTML = '<span class="fw-bold text-success">FREE</span>';
            } else if (batch.discountedPrice !== null) {
                priceOrButtonHTML = `₹${batch.discountedPrice}`;
            } else if (batch.originalPrice !== null) {
                priceOrButtonHTML = `₹${batch.originalPrice}`;
            } else {
                priceOrButtonHTML = 'Price N/A';
            }

            const originalPriceStrikethrough = (batch.originalPrice !== null && batch.discountedPrice !== null && batch.discountedPrice < batch.originalPrice) ? `<s class="text-muted ms-2">₹${batch.originalPrice}</s>` : '';

            div.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <img src="${batch.thumbnail}" alt="Thumbnail" width="60" height="40" class="thumbnail-preview" onerror="this.onerror=null;this.src='https://via.placeholder.com/60x40/cccccc/333333?text=NoImg';"
 />
                        <input class="form-control form-control-sm batch-title flex-grow-1 me-2" data-cat="${catId}" data-bid="${bId}" value="${batch.title}">
                        <button class="btn btn-sm btn-danger delete-batch" data-cat="${catId}" data-bid="${bId}">Delete</button>
                    </div>
                  
                    <div class="mb-2">
                        <label for="batchDescription-${bId}" class="form-label visually-hidden">Description</label>
                        <textarea class="form-control form-control-sm batch-description" id="batchDescription-${bId}" data-cat="${catId}" data-bid="${bId}" placeholder="Batch Description (max 100 words)">${batch.description ||
''}</textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="w-50 me-2">
                            <label for="batchOriginalPrice-${bId}" 
class="form-label">Original Price</label>
                            <input type="number" class="form-control form-control-sm batch-original-price" id="batchOriginalPrice-${bId}" data-cat="${catId}" data-bid="${bId}" value="${batch.originalPrice !== null ? batch.originalPrice : ''}" placeholder="e.g., 999">
                        </div>
                        <div class="w-50">
      
                            <label for="batchDiscountedPrice-${bId}" class="form-label">Discounted Price</label>
                            <input type="number" class="form-control form-control-sm batch-discounted-price" id="batchDiscountedPrice-${bId}" data-cat="${catId}" data-bid="${bId}" value="${batch.discountedPrice !== null ? batch.discountedPrice : ''}" placeholder="e.g., 499 (0 for FREE)">
                        </div>
    
                    </div>
                    <div class="mb-2">
                        <label for="sellerTelegramLink-${bId}" class="form-label">Seller Telegram Link</label>
                        <input type="url" class="form-control form-control-sm seller-telegram-link" id="sellerTelegramLink-${bId}" data-cat="${catId}" data-bid="${bId}" value="${batch.sellerTelegramLink || ''}" placeholder="e.g., https://t.me/yourusername">
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input batch-is-free" type="checkbox" role="switch" id="isFreeSwitch-${bId}" data-cat="${catId}" data-bid="${bId}" ${batch.isFree ?
'checked' : ''}>
                        <label class="form-check-label" for="isFreeSwitch-${bId}">Mark as FREE</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input batch-is-completed" 
type="checkbox" role="switch" id="isCompletedSwitch-${bId}" data-cat="${catId}" data-bid="${bId}" ${batch.isCompleted ? 'checked' : ''}>
                        <label class="form-check-label" for="isCompletedSwitch-${bId}">Mark as Completed</label>
                    </div>
                    <div class="text-end fw-bold">
                     
    Current Price: ${priceOrButtonHTML} ${originalPriceStrikethrough}
                    </div>

                    <hr class="my-2">
                    <h6 class="mb-2 text-muted">Modules:</h6>
                    <button class="btn btn-sm btn-success add-module mb-2" data-cat="${catId}" data-bid="${bId}">+ Add Module</button>
  
                    <div class="modules-list" id="modules-list-${bId}"></div>
                </div>`;
            setupBatchEvents(div);
            return div;
        };

        const setupBatchEvents = (div) => {
            const batchTitleInput = div.querySelector('.batch-title');
            const batchDescriptionInput = div.querySelector('.batch-description');
            const batchOriginalPriceInput = div.querySelector('.batch-original-price');
            const batchDiscountedPriceInput = div.querySelector('.batch-discounted-price');
            const batchIsFreeSwitch = div.querySelector('.batch-is-free');
            const batchIsCompletedSwitch = div.querySelector('.batch-is-completed');
            const sellerTelegramLinkInput = div.querySelector('.seller-telegram-link'); // New input

            const { cat, bid } = batchTitleInput.dataset;

            batchTitleInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { title: e.target.value.trim() });
                msg('Batch title updated!', 'info');
            });

            batchDescriptionInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { description: e.target.value.trim() });
                msg('Batch description updated!', 'info');
            });

            batchOriginalPriceInput.addEventListener('change', async e => {
                const price = e.target.value.trim();
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { originalPrice: price ? parseFloat(price) : null });
                msg('Batch original price updated!', 'info');
            });

            batchDiscountedPriceInput.addEventListener('change', async e => {
                const price = e.target.value.trim();
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { discountedPrice: price ? parseFloat(price) : null });
                msg('Batch discounted price updated!', 'info');
            });

            batchIsFreeSwitch.addEventListener('change', async e => {
                const isFree = e.target.checked;
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { isFree: isFree });
                msg(`Batch marked as ${isFree ? 'FREE' : 'Paid'}`, 'info');
            });

            batchIsCompletedSwitch.addEventListener('change', async e => {
                const isCompleted = e.target.checked;
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { isCompleted: isCompleted });
                msg(`Batch marked as ${isCompleted ? 'Completed' : 'Incomplete'}`, 'info');
            });
            sellerTelegramLinkInput.addEventListener('change', async e => { // New listener
                await update(dbRef(db, `categories/${cat}/batches/${bid}`), { sellerTelegramLink: e.target.value.trim() });
                msg('Seller Telegram Link updated', 'info');
            });
            div.querySelector('.delete-batch').onclick = async e => {
                const confirmDelete = await showConfirm('Delete this batch and all its modules/lectures?');
                if (confirmDelete) {
                    showLoading('Deleting batch...');
                    try {
                        await remove(dbRef(db, `categories/${cat}/batches/${bid}`));
                        msg('Batch deleted!', 'success');
                    } catch (error) {
                        msg(`Error deleting batch: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            };

            // Module Management
            const addModuleButton = div.querySelector('.add-module');
            addModuleButton.onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const moduleName = prompt('Enter Module Name:');
                if (!moduleName) return;

                showLoading('Adding module...');
                try {
                    const newRef = push(dbRef(db, `categories/${cat}/batches/${bid}/modules`));
                    await set(newRef, { name: moduleName });
                    msg('Module added!', 'success');
                } catch (error) {
                    msg(`Error adding module: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };
            loadModules(cat, bid);
        };

        const loadModules = (catId, bId) => {
            const modulesRef = dbRef(db, `categories/${catId}/batches/${bId}/modules`);
            onValue(modulesRef, (snapshot) => {
                const modules = snapshot.val();
                const modulesList = document.getElementById(`modules-list-${bId}`);
                modulesList.innerHTML = '';
                if (modules) {
                    Object.entries(modules).forEach(([mId, module]) => {
                        const div = createModuleItem(catId, bId, mId, module);
                        modulesList.appendChild(div);
                    });
                }
            });
        };

        const createModuleItem = (catId, bId, mId, module) => {
            const div = document.createElement('div');
            div.className = 'card bg-white mb-2 ms-3';
            div.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <input class="form-control form-control-sm module-name flex-grow-1 me-2" data-cat="${catId}" data-bid="${bId}" data-mid="${mId}" value="${module.name}">
                        <button class="btn btn-sm btn-danger delete-module" data-cat="${catId}" data-bid="${bId}" data-mid="${mId}">Delete</button>
                    </div>
                    <h6 class="mb-2 text-muted ms-2">Lectures:</h6>
                    <button class="btn btn-sm btn-info add-lecture mb-2 ms-2" data-cat="${catId}" data-bid="${bId}" data-mid="${mId}">+ Add Lecture</button>
                    <div class="lectures-list ms-2" id="lectures-list-${mId}"></div>
                </div>`;
            setupModuleEvents(div);
            return div;
        };

        const setupModuleEvents = (div) => {
            const moduleNameInput = div.querySelector('.module-name');
            const { cat, bid, mid } = moduleNameInput.dataset;

            moduleNameInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}`), { name: e.target.value.trim() });
                msg('Module name updated!', 'info');
            });

            div.querySelector('.delete-module').onclick = async () => {
                const confirmDelete = await showConfirm('Delete this module and all its lectures?');
                if (confirmDelete) {
                    showLoading('Deleting module...');
                    try {
                        await remove(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}`));
                        msg('Module deleted!', 'success');
                    } catch (error) {
                        msg(`Error deleting module: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            };

            // Lecture Management
            const addLectureButton = div.querySelector('.add-lecture');
            addLectureButton.onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const lectureTitle = prompt('Enter Lecture Title:');
                if (!lectureTitle) return;
                const lectureUrl = prompt('Enter Lecture Video URL:');
                if (!lectureUrl) return;

                showLoading('Adding lecture...');
                try {
                    const newRef = push(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures`));
                    await set(newRef, { title: lectureTitle, url: lectureUrl });
                    msg('Lecture added!', 'success');
                } catch (error) {
                    msg(`Error adding lecture: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };
            loadLectures(cat, bid, mid);
        };

        const loadLectures = (catId, bId, mId) => {
            const lecturesRef = dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}/lectures`);
            onValue(lecturesRef, (snapshot) => {
                const lectures = snapshot.val();
                const lecturesList = document.getElementById(`lectures-list-${mId}`);
                lecturesList.innerHTML = '';
                if (lectures) {
                    Object.entries(lectures).forEach(([lId, lecture]) => {
                        const div = createLectureItem(catId, bId, mId, lId, lecture);
                        lecturesList.appendChild(div);
                    });
                }
            });
        };

        const createLectureItem = (catId, bId, mId, lId, lecture) => {
            const div = document.createElement('div');
            div.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            div.innerHTML = `
                <input class="form-control form-control-sm lecture-title flex-grow-1 me-2" data-cat="${catId}" data-bid="${bId}" data-mid="${mId}" data-lid="${lId}" value="${lecture.title}">
                <input type="url" class="form-control form-control-sm lecture-url flex-grow-1 me-2" data-cat="${catId}" data-bid="${bId}" data-mid="${mId}" data-lid="${lId}" value="${lecture.url}">
                <button class="btn btn-sm btn-danger delete-lecture" data-cat="${catId}" data-bid="${bId}" data-mid="${mId}" data-lid="${lId}">Delete</button>`;
            setupLectureEvents(div);
            return div;
        };

        const setupLectureEvents = (div) => {
            const lectureTitleInput = div.querySelector('.lecture-title');
            const lectureUrlInput = div.querySelector('.lecture-url');
            const { cat, bid, mid, lid } = lectureTitleInput.dataset;

            lectureTitleInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures/${lid}`), { title: e.target.value.trim() });
                msg('Lecture title updated!', 'info');
            });

            lectureUrlInput.addEventListener('change', async e => {
                await update(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures/${lid}`), { url: e.target.value.trim() });
                msg('Lecture URL updated!', 'info');
            });

            div.querySelector('.delete-lecture').onclick = async () => {
                const confirmDelete = await showConfirm('Delete this lecture?');
                if (confirmDelete) {
                    showLoading('Deleting lecture...');
                    try {
                        await remove(dbRef(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures/${lid}`));
                        msg('Lecture deleted!', 'success');
                    } catch (error) {
                        msg(`Error deleting lecture: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            };
        };

        // Initial load
        authenticateFirebase().then(() => {
            loadCategories();
            loadSiteConfig(); // Load site config on startup
            setupSiteConfigEvents(); // Setup event listeners for site config
        });
    </script>
</body>
</html>
