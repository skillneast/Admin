<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillNeast Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&family=Comfortaa:wght@700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            /* Dark Theme Colors */
            --primary-dark: #1a1a1a;
            --secondary-dark: #2c2c2c;
            --bottom-nav-bg: #000000;
            --bottom-nav-item: #ffffff;
            --bottom-nav-active: #00ADB5;
            --card-bg: #222222;
            --text-light: #f0f0f0;
            --text-muted: #b0b0b0;
            --accent-blue: #007bff;
            --accent-teal: #00ADB5;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --input-bg: #333333;
            --input-border: #444444;
            --hover-item: #3a3a3a;
            --quote-text: #E0E0E0;
            --quote-author: #FFD700;
            --highlight-gold: #FFD700;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-dark);
            color: var(--text-light);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
            padding-bottom: 70px;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            position: relative;
        }

        .section {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .section.active {
            display: block;
        }

        h2, h5 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--accent-teal);
            margin-bottom: 25px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .form-control, .form-select, textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-light);
            border-radius: 8px;
            padding: 10px 15px;
        }
        .form-control:focus, .form-select:focus, textarea:focus {
            background-color: var(--input-bg);
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 0.25rem rgba(0, 173, 181, 0.25);
            color: var(--text-light);
        }
        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .form-label {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .btn-primary, .btn-success, .btn-danger, .btn-secondary, .btn-info {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; transform: translateY(-2px); }

        .btn-success { background-color: var(--accent-green); border-color: var(--accent-green); }
        .btn-success:hover { background-color: #1e7e34; border-color: #1e7e34; transform: translateY(-2px); }

        .btn-danger { background-color: var(--accent-red); border-color: var(--accent-red); }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; transform: translateY(-2px); }

        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; transform: translateY(-2px); }

        .btn-info { background-color: var(--accent-teal); border-color: var(--accent-teal); }
        .btn-info:hover { background-color: #00939b; border-color: var(--accent-teal); transform: translateY(-2px); }


        .alert {
            margin-top: 15px;
            border-radius: 8px;
            background-color: rgba(0, 173, 181, 0.2);
            border-color: var(--accent-teal);
            color: var(--text-light);
        }
        .alert-danger { background-color: rgba(220, 53, 69, 0.2); border-color: var(--accent-red); }
        .alert-success { background-color: rgba(40, 167, 69, 0.2); border-color: var(--accent-green); }
        .alert-info { background-color: rgba(0, 123, 255, 0.2); border-color: var(--accent-blue); }
        .alert-warning { background-color: rgba(255, 193, 7, 0.2); border-color: #FFC107; color: #FFC107; }


        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        .card-body {
            padding: 20px;
        }

        .cat-name, .batch-title, .module-name, .item-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--accent-teal);
        }
        [contenteditable]:focus {
            outline: 1px solid var(--accent-blue);
            background-color: var(--input-bg);
            border-radius: 5px;
            padding: 2px 5px;
        }

        .batches-list, .modules-list, .lectures-list {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px solid var(--border-color);
        }
        .text-muted {
            color: var(--text-muted) !important;
        }
        .fst-italic {
            font-style: italic;
        }
        img.thumbnail-preview {
            border-radius: 8px;
            object-fit: cover;
            width: 100px;
            height: 70px;
            margin-right: 15px;
            border: 1px solid var(--border-color);
        }
        .item-type-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 700;
        }
        .item-type-badge.bg-primary { background-color: var(--accent-blue) !important; }
        .item-type-badge.bg-info { background-color: var(--accent-teal) !important; }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            color: var(--text-light);
            text-align: center;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }

        .login-card h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 2.2em;
            color: var(--accent-teal);
            margin-bottom: 30px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .login-card .form-control {
            margin-bottom: 20px;
            height: 50px;
            font-size: 1.1em;
        }

        .login-card .btn-primary {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
        }

        /* Home Section Styles */
        .home-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px);
            text-align: center;
        }
        .home-section h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 3em;
            color: var(--accent-teal);
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            animation: fadeInScale 1s ease-out;
        }
        .home-section .emoji-icon {
            font-size: 4em;
            margin-bottom: 30px;
            animation: bounce 1.5s infinite ease-in-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0); }
        }

        .home-quote-section {
            background-color: var(--secondary-dark);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-top: 40px;
            width: 80%;
            max-width: 600px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .home-quote-section .quote-text {
            font-family: 'Open Sans', sans-serif;
            font-style: italic;
            font-size: 1.1em;
            color: var(--quote-text);
            margin-bottom: 15px;
        }
        .home-quote-section .quote-author {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--quote-author);
            font-size: 1em;
        }

        /* Homepage Announcements List Styles (Renamed for consistency) */
        #websiteNotificationsList .home-announcement-item {
            background-color: rgba(0, 173, 181, 0.1);
            border: 1px solid var(--accent-teal);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            position: relative;
        }

        #websiteNotificationsList .home-announcement-item p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.95em;
        }

        #websiteNotificationsList .home-announcement-item a {
            color: var(--highlight-gold);
            text-decoration: underline;
            font-size: 0.9em;
            display: block;
            margin-top: 5px;
        }

        #websiteNotificationsList .home-announcement-item .announcement-controls {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        #websiteNotificationsList .home-announcement-item .announcement-controls button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.9em;
            margin-left: 5px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        #websiteNotificationsList .home-announcement-item .announcement-controls button:hover {
            color: var(--accent-red);
        }
        #websiteNotificationsList .home-announcement-item .announcement-controls button.edit-btn:hover {
            color: var(--accent-blue);
        }


        /* Custom Modal (Confirm/Alert/Type selection) Styles */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 5px 25px var(--shadow-color);
            color: var(--text-light);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .custom-modal-content h5 {
            color: var(--accent-teal);
            margin-bottom: 20px;
        }
        .custom-modal-content .modal-footer {
            justify-content: center;
            border-top: none;
            padding-top: 20px;
        }
        .custom-modal-content .modal-footer .btn {
            margin: 0 5px;
        }

        /* Loading Spinner Overlay */
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .loading-spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-teal);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loading-message {
            color: white;
            margin-top: 15px;
            font-size: 1.2em;
            font-family: 'Montserrat', sans-serif;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bottom Navigation Bar Styles */
        .bottom-navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bottom-nav-bg);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            z-index: 1000;
            color: var(--bottom-nav-item);
        }

        .bottom-navbar .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: inherit;
            font-size: 0.8em;
            font-weight: 500;
            padding: 5px 0;
            flex: 1;
            transition: color 0.2s ease, transform 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .bottom-navbar .nav-item i {
            font-size: 1.5em;
            margin-bottom: 5px;
            color: inherit;
            transition: color 0.2s ease;
        }

        .bottom-navbar .nav-item.active {
            color: var(--bottom-nav-active);
            font-weight: 700;
        }

        .bottom-navbar .nav-item.active i {
            color: var(--bottom-nav-active);
        }

        .bottom-navbar .nav-item:hover {
            transform: translateY(-2px);
            color: var(--bottom-nav-active);
        }

        .bottom-navbar .nav-item:active {
            transform: scale(0.95);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .content {
                padding: 15px;
                padding-bottom: 80px;
            }
            .home-section h1 {
                font-size: 2.2em;
            }
            .section {
                padding: 20px;
            }
            .home-quote-section {
                width: 95%;
                padding: 15px;
            }
            .website-stats-section {
                padding: 15px;
            }
            .bottom-navbar {
                padding: 8px 0;
            }
            .bottom-navbar .nav-item {
                font-size: 0.7em;
            }
            .bottom-navbar .nav-item i {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h2>SkillNeast Admin Login</h2>
            <div id="loginAlerts" class="alert alert-danger" style="display: none;"></div>
            <div class="mb-3">
                <input type="email" class="form-control" id="adminEmail" placeholder="Enter Admin Email">
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" id="adminPassword" placeholder="Enter Admin Password">
            </div>
            <button class="btn btn-primary" id="loginButton">Login</button>
        </div>
    </div>

    <div class="main-wrapper" id="mainWrapper" style="display: none;">
        <div class="content" id="content">
            <div id="home-section" class="section active home-section">
                <span class="emoji-icon">üöÄ</span>
                <h1>Welcome SkillNeast Admin Panel</h1>
                <p class="text-muted">Manage your courses, content, and users effortlessly.</p>

                <div class="home-quote-section">
                    <p class="quote-text" id="homeQuoteText"></p>
                    <p class="quote-author" id="homeQuoteAuthor"></p>
                </div>

                <div class="website-stats-section">
                    <h5>Website Analytics</h5>
                    <p>Real-time Active Users: <span id="activeUsersCount">0</span></p>
                    <p>Total Website Visits: <span id="totalVisitsCount">0</span></p>
                </div>

                <button id="logoutButton" class="btn btn-danger mt-4">Logout</button>
            </div>

            <div id="site-config-section" class="section">
                <h5>Site Configuration (Global Settings)</h5>
                <div id="alerts"></div> 

                <hr class="my-4" style="border-color: var(--border-color);">
                <h5>Telegram Channels Banner (WE NEED) Controls</h5>
                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input site-config-input" type="checkbox" role="switch" id="telegramBannerVisible" data-key="telegramBannerVisible">
                    <label class="form-check-label" for="telegramBannerVisible">Show "WE NEED" Banner</label>
                </div>
                <div class="mb-3">
                    <label for="telegramBannerTitle" class="form-label">Telegram 
                        Banner Main Title (Use <br> for new line)</label>
                    <input type="text" class="form-control site-config-input" id="telegramBannerTitle" placeholder="e.g., JOIN OUR OFFICIAL <br> TELEGRAM CHANNELS" data-key="telegramBannerTitle">
                </div>
                <div class="mb-3">
                    <label for="telegramBannerChannelList" class="form-label">Telegram Channels List (Pipe separated | for new line, supports HTML/emojis)</label>
                    <textarea class="form-control site-config-input" id="telegramBannerChannelList" rows="4" placeholder="e.g., ‚Ä¢ Study Ratna ‚ú®|‚Ä¢ RATNA Official üì£|‚Ä¢ Anime Speaks üêâ|‚Ä¢ Code with RATNA üíª" data-key="telegramBannerChannelList"></textarea>
                </div>
                <div class="mb-3">
                    <label for="telegramBannerButtonText" class="form-label">Telegram 
                        Banner Button Text</label>
                    <input type="text" class="form-control site-config-input" id="telegramBannerButtonText" placeholder="e.g., CLICK HERE!" data-key="telegramBannerButtonText">
                </div>
                <div class="mb-3">
                    <label for="telegramBannerButtonLink" class="form-label">Telegram Banner Button Link (Main Telegram Group)</label>
                    <input type="url" class="form-control site-config-input" id="telegramBannerButtonLink" placeholder="e.g., https://t.me/your_main_group" data-key="telegramBannerButtonLink">
                </div>
                <div class="mb-3">
                    <label for="telegramBannerSupportText" class="form-label">Telegram Banner Support Text</label>
                    <input type="text" class="form-control site-config-input" id="telegramBannerSupportText" placeholder="e.g., YOUR SUPPORT !!" data-key="telegramBannerSupportText">
                </div>

                <hr class="my-4" style="border-color: var(--border-color);">
                <h5>Discover Notice (Namo Buddhaya Everyone) Controls</h5>
                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input site-config-input" type="checkbox" role="switch" id="discoverNoticeVisible" data-key="discoverNoticeVisible">
                    <label class="form-check-label" for="discoverNoticeVisible">Show Discover Notice</label>
                </div>
                <div class="mb-3">
                    <label for="discoverNoticeHeaderEmoji" class="form-label">Discover Notice Header Emoji (e.g., üôè)</label>
                    <input type="text" class="form-control site-config-input" id="discoverNoticeHeaderEmoji" placeholder="e.g., üôè" data-key="discoverNoticeHeaderEmoji">
                </div>
                 <div class="mb-3">
                    <label for="discoverNoticeImageUrl" class="form-label">Discover Notice Image URL (Optional)</label>
                    <input type="url" class="form-control site-config-input" id="discoverNoticeImageUrl" placeholder="e.g., https://example.com/image.jpg" data-key="discoverNoticeImageUrl">
                    <small class="form-text text-muted">Image will appear below the header.</small>
                </div>
                <div class="mb-3">
                    <label for="discoverNoticeTitle" class="form-label">Discover Notice Main Title</label>
                    <input type="text" class="form-control site-config-input" id="discoverNoticeTitle" placeholder="e.g., DISCOVER OUR APP'S DELIGHTS!" data-key="discoverNoticeTitle">
                </div>
                <div class="mb-3">
                    <label for="discoverNoticePoints" class="form-label">Discover Notice Points (Pipe separated | for new point, supports HTML/emojis)</label>
                    <textarea class="form-control site-config-input" id="discoverNoticePoints" rows="5" placeholder="e.g., üö´ Don't buy this App from AnyOne...|ü§ù Join Us on Telegram..." data-key="discoverNoticePoints"></textarea>
                </div>

                <hr class="my-4" style="border-color: var(--border-color);">
                <h5>How to Use App Videos (Tutorials) Controls</h5>
                <div class="mb-3">
                    <label for="howToUseVideoTitle" class="form-label">Video Title</label>
                    <input type="text" class="form-control" id="howToUseVideoTitle" placeholder="e.g., App Tutorial Part 1">
                </div>
                <div class="mb-3">
                    <label for="howToUseVideoUrl" class="form-label">YouTube/Drive Video URL</label>
                    <input type="url" class="form-control" id="howToUseVideoUrl" placeholder="e.g., https://www.youtube.com/watch?v=VIDEO_ID or https://drive.google.com/file/d/FILE_ID/view">
                </div>
                <div class="mb-3">
                    <label for="howToUseVideoDescription" class="form-label">Video Description</label>
                    <textarea class="form-control" id="howToUseVideoDescription" rows="3" placeholder="Short description of the video."></textarea>
                </div>
                <button id="addHowToUseVideo" class="btn btn-primary mt-2 w-100">Add Video</button>
                <hr class="my-4" style="border-color: var(--border-color);">
                <h6 class="mb-3 text-muted">Existing How-To App Videos:</h6>
                <div id="howToUseVideosList">
                    <p class="text-muted fst-italic">No videos added yet.</p>
                </div>
                <hr class="my-4" style="border-color: var(--border-color);">
                <div class="mb-3">
                    <label for="surpriseButtonLink" class="form-label">Today's Surprise Link</label>
                    <input type="url" class="form-control site-config-input" id="surpriseButtonLink" placeholder="e.g., https://skillneast.com/surprise" data-key="surpriseButtonLink">
                    <small class="form-text text-muted">Link for the "Today's Surprise!" button on the homepage.</small>
                </div>
                <div class="mb-3">
                    <label for="telegramChannelLink" class="form-label">Telegram Channel Link</label>
                    <input type="url" class="form-control site-config-input" id="telegramChannelLink" placeholder="e.g., https://t.me/your_channel" data-key="telegramChannelLink">
                </div>
                <div class="mb-3">
                    <label for="telegramGroupLink" class="form-label">Telegram Group Link</label>
                    <input type="url" class="form-control site-config-input" id="telegramGroupLink" placeholder="e.g., https://t.me/your_group" data-key="telegramGroupLink">
                </div>
                <div class="mb-3">
                    <label for="youtubeLink" class="form-label">YouTube Link (About Me)</label>
                    <input type="url" class="form-control site-config-input" id="youtubeLink" placeholder="e.g., https://www.youtube.com/yourchannel" data-key="youtubeLink">
                </div>
                <div class="mb-3">
                    <label for="instagramLink" class="form-label">Instagram Link (About Me)</label>
                    <input type="url" class="form-control site-config-input" id="instagramLink" placeholder="e.g., https://instagram.com/your_profile" data-key="instagramLink">
                </div>
                <div class="mb-3">
                    <label for="requestCoursesLink" class="form-label">Request Courses Link</label>
                    <input type="url" class="form-control site-config-input" id="requestCoursesLink" placeholder="e.g., https://forms.google.com/your_form" data-key="requestCoursesLink">
                </div>
                <div class="mb-3">
                    <label for="profilePictureUrl" class="form-label">About Me Profile Picture URL</label>
                    <input type="url" class="form-control site-config-input" id="profilePictureUrl" placeholder="e.g., https://example.com/profile.jpg" data-key="profilePictureUrl">
                </div>
                <div class="mb-3">
                    <label for="skillNeastLogoUrl" class="form-label">SkillNeast Logo URL (Top Navbar)</label>
                    <input type="url" class="form-control site-config-input" id="skillNeastLogoUrl" placeholder="e.g., https://example.com/logo.png" data-key="skillNeastLogoUrl">
                </div>
                <div class="mb-3">
                    <label for="sliderHeaderPictureUrl" class="form-label">Slider Menu Header Picture URL</label>
                    <input type="url" class="form-control site-config-input" id="sliderHeaderPictureUrl" placeholder="e.g., https://example.com/slider_header.png" data-key="sliderHeaderPictureUrl">
                </div>
                <div class="mb-3">
                    <label for="pwLogoUrl" class="form-label">PW Logo URL (if applicable)</label>
                    <input type="url" class="form-control site-config-input" id="pwLogoUrl" placeholder="e.g., https://example.com/pw_logo.png" data-key="pwLogoUrl">
                </div>

                <hr class="my-4" style="border-color: var(--border-color);">
                <h5>Website Homepage Notifications</h5>
                <div id="website-notification-alerts"></div>

                <div class="mb-3">
                    <label for="websiteNotificationTitle" class="form-label">Notification Title</label>
                    <input type="text" class="form-control" id="websiteNotificationTitle" placeholder="e.g., Important Update!">
                </div>
                <div class="mb-3">
                    <label for="websiteNotificationBody" class="form-label">Notification Message</label>
                    <textarea class="form-control" id="websiteNotificationBody" rows="3" placeholder="e.g., Check out our new features!"></textarea>
                </div>
                <div class="mb-3">
                    <label for="websiteNotificationLink" class="form-label">Notification Link (Optional)</label>
                    <input type="url" class="form-control" id="websiteNotificationLink" placeholder="e.g., https://skillneast.com/latest-news">
                </div>
            
                <button id="addWebsiteNotificationButton" class="btn btn-primary mt-2 w-100">Add Homepage Notification</button>
                <small class="form-text text-muted mt-3">
                    These notifications will appear on your website's homepage, in the notification bell popup.
                </small>
                <hr class="my-4" style="border-color: var(--border-color);">
                <h6 class="mb-3 text-muted">Existing Homepage Notifications:</h6>
                <div id="websiteNotificationsList" class="mt-3">
                    <p class="text-muted fst-italic">No homepage notifications added yet.</p>
                </div>
            </div>

            <div id="notifications-section" class="section">
                <h5>Send Push Notification to all Users</h5>
                <div class="mb-3">
                    <label for="notificationTitle" class="form-label">Notification Title</label>
                    <input type="text" class="form-control" id="notificationTitle" placeholder="e.g., New Course Alert!">
                </div>
                <div class="mb-3">
                    <label for="notificationBody" class="form-label">Notification Body</label>
                    <textarea class="form-control" id="notificationBody" rows="3" placeholder="e.g., Check out our latest course on Web Development!"></textarea>
                </div>
                <div class="mb-3">
                    <label for="notificationLink" class="form-label">Link (Optional - where to redirect user)</label>
                    <input type="url" class="form-control" id="notificationLink" placeholder="e.g., https://skillneast.com/new-course">
                </div>
                <button id="sendNotificationButton" class="btn btn-success mt-2 w-100">Send Notification</button>
                <small class="form-text text-muted mt-3">
                    *Push notifications require Firebase Cloud Messaging (FCM) setup and server-side logic (e.g., Firebase Functions) to reach all users. This button only triggers a client-side function to initiate the process.
                </small>
            </div>

            <div id="categories-section" class="section">
                <h5>Create New Category</h5>
                <div class="mb-3">
                    <label for="categoryName" class="form-label">Category Name</label>
                    <input id="categoryName" type="text" class="form-control" placeholder="e.g., JEE Mains, NEET, Editing">
                </div>
                <div class="mb-3">
                    <label for="categoryImageUrl" class="form-label">Category Image URL</label>
                    <input type="url" class="form-control" id="categoryImageUrl" placeholder="e.g., https://example.com/image.jpg">
                </div>
                <button id="addCategory" class="btn btn-primary mt-2 w-100">Add Category</button>

                <hr class="my-4" style="border-color: var(--border-color);">

                <h5>Existing Categories & Batches</h5>
                <div id="categoriesList" class="mt-4">
                    <p class="text-muted fst-italic">Loading categories...</p>
                </div>
            </div>

            <div id="request-courses-section" class="section">
                <h5>Create New Request Course Post</h5>
                <div id="request-courses-add-section">
                    <div class="mb-3">
                        <label for="requestCourseTitle" class="form-label">Request Course Post Title</label>
                        <input type="text" class="form-control" id="requestCourseTitle" placeholder="e.g., New Course Idea: Python Basics">
                    </div>
                    <div class="mb-3">
                        <label for="requestCourseDescription" class="form-label">Request Course Post Description</label>
                        <textarea class="form-control" id="requestCourseDescription" rows="3" placeholder="Describe the course you want."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="requestCourseImageUrl" class="form-label">Request Course Post Image URL (Optional)</label>
                        <input type="url" class="form-control" id="requestCourseImageUrl" placeholder="e.g., https://example.com/course_idea.jpg">
                    </div>
                    <div class="mb-3">
                        <label for="requestCourseButtonText" class="form-label">Request Course Post Button Text (Optional)</label>
                        <input type="text" class="form-control" id="requestCourseButtonText" placeholder="e.g., Vote for this course">
                    </div>
                    <div class="mb-3">
                        <label for="requestCourseButtonLink" class="form-label">Request Course Post Button Link (Optional)</label>
                        <input type="url" class="form-control" id="requestCourseButtonLink" placeholder="e.g., https://forms.google.com/vote">
                    </div>
                    <button id="addRequestCourse" class="btn btn-primary mt-2 w-100">Add Request Course Post</button>
                </div>

                <h6 class="mt-4 text-muted">Existing Request Course Posts:</h6>
                <div id="requestCoursesAdminList" class="mt-3">
                    <p class="text-muted fst-italic">Loading user requests...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" id="customConfirmModal">
        <div class="custom-modal-content">
            <h5 id="customConfirmMessage"></h5>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="customConfirmCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="customConfirmOK">OK</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" id="addLectureResourceModal">
        <div class="custom-modal-content">
            <h5 id="addLectureResourceMessage">Select Content Type</h5>
            <div class="modal-body">
                <p>Would you like to add a Lecture or a Resource?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="addLectureButton"><i class="fas fa-video me-2"></i> Lecture</button>
                <button type="button" class="btn btn-info" id="addResourceButton"><i class="fas fa-file-alt me-2"></i> Resource</button>
                <button type="button" class="btn btn-secondary" id="cancelAddLectureResource">Cancel</button>
            </div>
        </div>
    </div>

    <div class="loading-spinner-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-message">Processing...</p>
    </div>

    <div class="bottom-navbar" id="bottomNavbar" style="display: none;">
        <a href="#" class="nav-item" data-section="categories-section">
            <i class="fas fa-th-large"></i>
            Batches
        </a>
        <a href="#" class="nav-item" data-section="site-config-section">
            <i class="fas fa-cog"></i> Settings
        </a>
        <a href="#" class="nav-item active" data-section="home-section">
            <i class="fas fa-home"></i> Home
        </a>
        <a href="#" class="nav-item" data-section="request-courses-section">
            <i class="fas fa-hand-paper"></i> Requests
        </a>
        <a href="#" class="nav-item" data-section="notifications-section">
            <i class="fas fa-users"></i> Users
        </a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as dbRef, push, set, update, remove, onValue, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"; // 'increment' added here
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        // Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyChwpbFb6M4HtG6zwjg0AXh7Lz9KjnrGZk",
            authDomain: "adminneast.firebaseapp.com",
            databaseURL: "https://adminneast-default-rtdb.firebaseio.com",
            projectId: "adminneast",
            storageBucket: "adminneast.appspot.com",
            messagingSenderId: "883877553418",
            appId: "1:883877553418:web:84ce8200f4b471bfffc6f3",
            measurementId: "G-PCH99BDF1S"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let isAuthenticated = false;
        let activeSection = 'home-section';
        const REAUTHENTICATION_INTERVAL = 4 * 60 * 60 * 1000; // 4 hours in milliseconds

        const homePageQuotes = [
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Success is not final, failure is not fatal: It is the courage to continue that counts.", author: "Winston Churchill" },
            { quote: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { quote: "The mind is everything. What you think you become.", author: "Buddha" },
            { quote: "The best way to predict the future is to create it.", author: "Peter Drucker" }
        ];
        let currentQuoteIndex = 0;

        // Custom alert/message function
        const msg = (text, type = 'success', targetId = 'alerts') => {
            const alertsDiv = document.getElementById(targetId);
            if (alertsDiv) {
                const el = document.createElement('div');
                el.className = `alert alert-${type} fade show`;
                el.textContent = text;
                alertsDiv.append(el);
                setTimeout(() => {
                    if (el && el.parentElement) {
                        el.classList.remove('show');
                        el.classList.add('fade');
                        el.addEventListener('transitionend', () => el.remove(), { once: true });
                    }
                }, 3000);
            } else {
                console.log(`Alert (${type}): ${text} (UI alert container not found)`);
            }
        };

        // Custom confirm modal
        const showConfirm = (message) => {
            return new Promise((resolve) => {
                const modalOverlay = document.getElementById('customConfirmModal');
                const modalMessage = document.getElementById('customConfirmMessage');
                const okButton = document.getElementById('customConfirmOK');
                const cancelButton = document.getElementById('customConfirmCancel');

                if (!modalOverlay || !modalMessage || !okButton || !cancelButton) { // Safety check
                    console.error("Custom confirm modal elements not found.");
                    resolve(false); // Resolve false if elements are missing
                    return;
                }

                modalMessage.textContent = message;
                modalOverlay.classList.add('active');

                const handleConfirm = () => {
                    modalOverlay.classList.remove('active');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modalOverlay.classList.remove('active');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                okButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', handleCancel);
            });
        };
        // Modal for adding lecture/resource type
        const showLectureResourceModal = () => {
            return new Promise((resolve) => {
                const modal = document.getElementById('addLectureResourceModal');
                const lectureBtn = document.getElementById('addLectureButton');
                const resourceBtn = document.getElementById('addResourceButton');
                const cancelBtn = document.getElementById('cancelAddLectureResource');

                if (!modal || !lectureBtn || !resourceBtn || !cancelBtn) { // Safety check
                    console.error("Lecture/Resource modal elements not found.");
                    resolve(null); // Resolve null if elements are missing
                    return;
                }

                modal.classList.add('active');

                const handleSelection = (type) => {
                    modal.classList.remove('active');
                    lectureBtn.removeEventListener('click', lectureClickHandler);
                    resourceBtn.removeEventListener('click', resourceClickHandler);
                    cancelBtn.removeEventListener('click', cancelClickHandler);
                    resolve(type);
                };

                const lectureClickHandler = () => handleSelection('lecture');
                const resourceClickHandler = () => handleSelection('resource');
                const cancelClickHandler = () => handleSelection(null);

                lectureBtn.addEventListener('click', lectureClickHandler);
                resourceBtn.addEventListener('click', resourceClickHandler);
                cancelBtn.addEventListener('click', cancelClickHandler);
            });
        };
        // Loading spinner
        const showLoading = (message = "Processing...") => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) { // Safety check
                loadingOverlay.querySelector('.loading-message').textContent = message;
                loadingOverlay.classList.add('active');
            }
        };

        const hideLoading = () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) { // Safety check
                loadingOverlay.classList.remove('active');
            }
        };

        // Update homepage quote
        const updateHomePageQuote = () => {
            const quoteTextEl = document.getElementById('homeQuoteText');
            const quoteAuthorEl = document.getElementById('homeQuoteAuthor');

            if (!quoteTextEl || !quoteAuthorEl) return; // Safety check

            if (homePageQuotes.length === 0) {
                quoteTextEl.textContent = "No quotes available.";
                quoteAuthorEl.textContent = "";
                return;
            }

            currentQuoteIndex = (currentQuoteIndex + 1) % homePageQuotes.length;
            const quote = homePageQuotes[currentQuoteIndex];

            quoteTextEl.textContent = `"${quote.quote}"`;
            quoteAuthorEl.textContent = `- ${quote.author}`;
        };
        // Show specific section and highlight bottom nav
        const showSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) { // Safety check
                targetSection.classList.add('active');
            }
            activeSection = sectionId;

            document.querySelectorAll('.bottom-navbar .nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });
            if (sectionId === 'home-section') {
                if (targetSection) targetSection.style.display = 'flex';
            } else {
                if (targetSection) targetSection.style.display = 'block';
            }

            // Load data specific to the section when it becomes active
            if (sectionId === 'site-config-section') {
                loadHowToUseVideos();
                loadWebsiteNotifications();
            } else if (sectionId === 'request-courses-section') {
                loadRequestCourses();
            } else if (sectionId === 'home-section') {
                listenForWebsiteStats();
            }
        };

        // Bottom navigation item click handler
        document.querySelectorAll('.bottom-navbar .nav-item').forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const targetSectionId = item.dataset.section;
                showSection(targetSectionId);
            });
        });
        // Get file extension from URL or name
        function getFileExtension(url, name) {
            if (name) {
                const nameParts = name.split('.');
                if (nameParts.length > 1) {
                    return nameParts.pop();
                }
            }
            if (url) {
                const urlParts = url.split('.');
                if (urlParts.length > 1) {
                    return urlParts.pop().split('?')[0].split('#')[0];
                }
                if (url.includes('youtube.com/') || url.includes('youtu.be/')) {
                    return 'youtube';
                }
                if (url.includes('drive.google.com/')) {
                    return 'gdrive';
                }
            }
            return '';
        }

        // Load site configuration from Firebase
        const loadSiteConfig = () => {
            const configRef = dbRef(db, 'siteConfig');
            onValue(configRef, (snapshot) => {
                const config = snapshot.val() || {};
                document.querySelectorAll('.site-config-input').forEach(input => {
                    const key = input.dataset.key;
                    if (input.type === 'checkbox') {
                        input.checked = config.hasOwnProperty(key) ? config[key] : false;
                    } else {
                        if (config.hasOwnProperty(key) && config[key] !== null) {
                            input.value = config[key];
                        } else {
                            input.value = ''; // Ensure empty string for null values
                        }
                    }
                });
            }, (error) => {
                msg(`Error loading site config: ${error.message}`, 'danger');
            });
        };

        // Setup event listeners for site configuration inputs
        const setupSiteConfigEvents = () => {
            document.querySelectorAll('.site-config-input').forEach(input => {
                if (!input.dataset.listenerAdded) {
                    input.addEventListener('change', async (e) => {
                        if (!isAuthenticated) { // Check authentication before allowing changes
                            msg('You must be logged in to make changes!', 'danger', 'alerts');
                            e.target.checked = !e.target.checked; // Revert checkbox if not authenticated
                            return;
                        }
                        const key = e.target.dataset.key;
                        let value;
                        if (e.target.type === 'checkbox') {
                            value = e.target.checked;
                        } else {
                            value = e.target.value.trim();
                        }

                        try {
                            showLoading('Updating site config...');
                            await update(dbRef(db, `siteConfig`), { [key]: value });
                            msg(`${key} updated!`, 'info');
                        } catch (error) {
                            msg(`Error updating ${key}: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    });
                    input.dataset.listenerAdded = 'true';
                }
            });

            document.getElementById('addWebsiteNotificationButton')?.addEventListener('click', addWebsiteNotification); // Optional chaining
        };
        // --- How to Use App Videos Management ---
        const howToUseVideosRef = dbRef(db, 'siteConfig/howToUseVideos');
        const loadHowToUseVideos = () => {
            const videosRef = howToUseVideosRef;
            onValue(videosRef, (snapshot) => {
                const videos = snapshot.val() || {};
                const listContainer = document.getElementById('howToUseVideosList');
                if (!listContainer) return; // Safety check

                listContainer.innerHTML = '';

                if (Object.keys(videos).length === 0) {
                    listContainer.innerHTML = '<p class="text-muted fst-italic">No videos added yet.</p>';
                    return;
                }

                Object.entries(videos).forEach(([videoId, video]) => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'how-to-use-video-item card card-body mb-2';
                    videoItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>Title:</strong> <span contenteditable="true" data-id="${videoId}" data-field="title" class="video-title">${video.title || 'Untitled Video'}</span><br>
                                <strong>URL:</strong> <a href="${video.url}" target="_blank">${video.url || 'No URL'}</a><br>
                                <strong>Description:</strong> <span contenteditable="true" data-id="${videoId}" data-field="description" class="video-description">${video.description || 'No description'}</span>
                            </div>
                            <div class="video-controls">
                                <button class="btn btn-sm btn-info edit-how-to-use-video" data-id="${videoId}">Edit URL</button>
                                <button class="btn btn-sm btn-danger delete-how-to-use-video" data-id="${videoId}">Delete</button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(videoItem);

                    videoItem.querySelector('.video-title')?.addEventListener('blur', (e) => updateHowToUseVideo(videoId, 'title', e.target.textContent)); // Optional chaining for safety
                    videoItem.querySelector('.video-description')?.addEventListener('blur', (e) => updateHowToUseVideo(videoId, 'description', e.target.textContent)); // Optional chaining for safety
                    videoItem.querySelector('.edit-how-to-use-video')?.addEventListener('click', () => { // Optional chaining for safety
                        const newUrl = prompt('Enter new video URL:', video.url);
                        if (newUrl !== null) {
                            updateHowToUseVideo(videoId, 'url', newUrl.trim());
                        }
                    });
                    videoItem.querySelector('.delete-how-to-use-video')?.addEventListener('click', () => deleteHowToUseVideo(videoId)); // Optional chaining for safety
                });
            }, (error) => {
                msg(`Error loading how-to-use videos: ${error.message}`, 'danger');
            });
        };

        // Add how-to-use video
        const addHowToUseVideo = async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const titleInput = document.getElementById('howToUseVideoTitle');
            const urlInput = document.getElementById('howToUseVideoUrl');
            const descriptionInput = document.getElementById('howToUseVideoDescription');

            if (!titleInput || !urlInput || !descriptionInput) { // Safety check
                msg('Video input fields not found!', 'danger');
                return;
            }

            const title = titleInput.value.trim();
            const url = urlInput.value.trim();
            const description = descriptionInput.value.trim();

            if (!title || !url) {
                msg('Video title and URL are required!', 'warning');
                return;
            }

            showLoading('Adding video...');
            try {
                const newRef = push(howToUseVideosRef);
                await set(newRef, { title: title, url: url, description: description });
                msg('Video added successfully!', 'success');
                titleInput.value = '';
                urlInput.value = '';
                descriptionInput.value = '';
            } catch (error) {
                msg(`Error adding video: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Update how-to-use video
        const updateHowToUseVideo = async (videoId, field, value) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            showLoading('Updating video...');
            try {
                await update(dbRef(db, `siteConfig/howToUseVideos/${videoId}`), { [field]: value });
                msg('Video updated!', 'info');
            } catch (error) {
                msg(`Error updating video: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Delete how-to-use video
        const deleteHowToUseVideo = async (videoId) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const confirm = await showConfirm('Are you sure you want to delete this video?');
            if (confirm) {
                showLoading('Deleting video...');
                try {
                    await remove(dbRef(db, `siteConfig/howToUseVideos/${videoId}`));
                    msg('Video deleted!', 'danger');
                } catch (error) {
                    msg(`Error deleting video: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            }
        };
        document.getElementById('addHowToUseVideo')?.addEventListener('click', addHowToUseVideo); // Optional chaining for safety

        // --- Push Notification Management (for bell icon notifications sent to all users) ---
        const sendNotification = async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

            const titleInput = document.getElementById('notificationTitle');
            const bodyInput = document.getElementById('notificationBody');
            const linkInput = document.getElementById('notificationLink');

            if (!titleInput || !bodyInput || !linkInput) { // Safety check
                msg('Notification input fields not found!', 'danger');
                return;
            }

            const title = titleInput.value.trim();
            const body = bodyInput.value.trim();
            const link = linkInput.value.trim();

            if (!title || !body) {
                msg('Notification title and body are required!', 'warning');
                return;
            }

            showLoading('Sending notification...');
            try {
                // This pushes to the /notifications node, which the website listens to for the bell icon
                await push(dbRef(db, 'notifications'), {
                    title: title,
                    body: body,
                    link: link || null,
                    timestamp: serverTimestamp()
                });
                console.log("Notification sent to Firebase Realtime Database:", { title, body, link });
                msg('Notification sent!', 'success');

                titleInput.value = '';
                bodyInput.value = '';
                linkInput.value = '';
            } catch (error) {
                msg(`Error sending notification: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };
        document.getElementById('sendNotificationButton')?.addEventListener('click', sendNotification); // Optional chaining for safety
        // NEW: Website Homepage Notifications Management (replaces old homeAnnouncements)
        const websiteNotificationsRef = dbRef(db, 'notifications');
        const addWebsiteNotification = async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

            const titleInput = document.getElementById('websiteNotificationTitle');
            const bodyInput = document.getElementById('websiteNotificationBody');
            const linkInput = document.getElementById('websiteNotificationLink');

            if (!titleInput || !bodyInput || !linkInput) { // Safety check
                msg('Website Notification input fields not found!', 'danger');
                return;
            }

            const title = titleInput.value.trim();
            const body = bodyInput.value.trim();
            const link = linkInput.value.trim();

            if (!title || !body) {
                msg('Notification title and message are required!', 'warning');
                return;
            }

            showLoading('Adding Homepage Notification...');
            try {
                await push(websiteNotificationsRef, {
                    title: title,
                    body: body,
                    link: link || null,
                    timestamp: serverTimestamp()
                });
                msg('Homepage Notification added successfully!', 'success');
                titleInput.value = '';
                bodyInput.value = '';
                linkInput.value = '';
            } catch (error) {
                msg(`Error adding Homepage Notification: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        const loadWebsiteNotifications = () => {
            onValue(websiteNotificationsRef, (snapshot) => {
                const notifications = snapshot.val() || {};
                renderWebsiteNotifications(notifications);
            }, (error) => {
                msg(`Error loading homepage notifications: ${error.message}`, 'danger');
            });
        };

        const renderWebsiteNotifications = (notifications) => {
            const listContainer = document.getElementById('websiteNotificationsList');
            if (!listContainer) return; // Safety check

            listContainer.innerHTML = '';
            if (Object.keys(notifications).length === 0) {
                listContainer.innerHTML = '<p class="text-muted fst-italic">No homepage notifications added yet.</p>';
                return;
            }

            const sortedNotifications = Object.entries(notifications).sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0));
            sortedNotifications.forEach(([id, notification]) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'home-announcement-item card card-body mb-2';
                itemDiv.dataset.id = id;

                itemDiv.innerHTML = `
                    <p><strong>Title:</strong> <span contenteditable="true" data-field="title">${notification.title || 'Untitled'}</span></p>
                    <p><strong>Message:</strong> <span contenteditable="true" data-field="body">${notification.body || 'No message'}</span></p>
                    <p><strong>Link:</strong> <input type="url" class="form-control form-control-sm mt-1 mb-1" data-field="link" value="${notification.link || ''}" placeholder="Optional Link"></p>
                    <div class="announcement-controls mt-2">
                        <button class="btn btn-sm btn-danger delete-website-notification" data-id="${id}">Delete</button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);

                itemDiv.querySelector('[contenteditable][data-field="title"]')?.addEventListener('blur', (e) => updateWebsiteNotification(id, 'title', e.target.textContent));
                itemDiv.querySelector('[contenteditable][data-field="body"]')?.addEventListener('blur', (e) => updateWebsiteNotification(id, 'body', e.target.textContent));
                itemDiv.querySelector('input[type="url"][data-field="link"]')?.addEventListener('change', (e) => updateWebsiteNotification(id, 'link', e.target.value));
                itemDiv.querySelector('.delete-website-notification')?.addEventListener('click', () => deleteWebsiteNotification(id));
            });
        };

        const updateWebsiteNotification = async (id, field, value) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            showLoading('Updating notification...');
            try {
                await update(dbRef(db, `notifications/${id}`), { [field]: value || null });
                msg('Homepage Notification updated!', 'info');
            }
            catch (error) {
                msg(`Error updating notification: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        const deleteWebsiteNotification = async (id) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const confirm = await showConfirm('Are you sure you want to delete this homepage notification?');
            if (confirm) {
                showLoading('Deleting notification...');
                try {
                    await remove(dbRef(db, `notifications/${id}`));
                    msg('Homepage Notification deleted!', 'danger');
                } catch (error) {
                    msg(`Error deleting notification: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            }
        };
        const websiteStatsRef = dbRef(db, 'websiteStats');
        const listenForWebsiteStats = () => {
            onValue(websiteStatsRef, (snapshot) => {
                const stats = snapshot.val() || { activeUsers: {}, totalVisits: 0 }; // Default activeUsers to empty object
                const activeUsersCount = stats.activeUsers ? Object.keys(stats.activeUsers).length : 0; // Correctly count active users
                
                const activeUsersSpan = document.getElementById('activeUsersCount');
                const totalVisitsSpan = document.getElementById('totalVisitsCount');

                if (activeUsersSpan) activeUsersSpan.textContent = activeUsersCount;
                if (totalVisitsSpan) totalVisitsSpan.textContent = stats.totalVisits || 0;
            }, (error) => {
                console.error("Error listening for website stats:", error);
                const activeUsersSpan = document.getElementById('activeUsersCount');
                const totalVisitsSpan = document.getElementById('totalVisitsCount');
                if (activeUsersSpan) activeUsersSpan.textContent = 'N/A';
                if (totalVisitsSpan) totalVisitsSpan.textContent = 'N/A';
            });
        };

        // --- Request Courses Post Management ---
        const requestCoursesRef = dbRef(db, 'requestCourses');
        const loadRequestCourses = () => {
            onValue(requestCoursesRef, (snapshot) => {
                const requests = snapshot.val() || {};
                renderRequestCourses(requests);
            }, (error) => {
                msg(`Error loading request courses: ${error.message}`, 'danger');
            });
        };
        const renderRequestCourses = (requests) => {
            const listContainer = document.getElementById('requestCoursesAdminList');
            if (!listContainer) return; // Safety check

            listContainer.innerHTML = '';
            if (Object.keys(requests).length === 0) {
                listContainer.innerHTML = '<p class="text-muted fst-italic">No request course posts added yet.</p>';
                return;
            }

            const sortedRequests = Object.entries(requests).sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0));
            sortedRequests.forEach(([requestId, request]) => {
                const requestItem = document.createElement('div');
                requestItem.className = 'card mb-2';
                requestItem.innerHTML = `
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 contenteditable="true" data-id="${requestId}" data-field="title" class="request-title flex-grow-1 me-2">${request.title || 'Untitled Request'}</h6>
                            <button class="btn btn-danger btn-sm delete-request" data-id="${requestId}">Delete</button>
                        </div>
                        ${request.imageUrl ? `<img src="${request.imageUrl}" alt="Request Image" class="thumbnail-preview mb-2">` : ''}
                        <div class="mb-2">
                            <label class="form-label">Description:</label>
                            <textarea class="form-control form-control-sm request-description" rows="2" data-id="${requestId}" data-field="description">${request.description || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Image URL:</label>
                            <input type="url" class="form-control form-control-sm request-image-url" data-id="${requestId}" data-field="imageUrl" value="${request.imageUrl || ''}" placeholder="Image URL">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Button Text:</label>
                            <input type="text" class="form-control form-control-sm request-button-text" data-id="${requestId}" data-field="buttonText" value="${request.buttonText || ''}" placeholder="Button Text (e.g., Vote Here)">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Button Link:</label>
                            <input type="url" class="form-control form-control-sm request-button-link" data-id="${requestId}" data-field="buttonLink" value="${request.buttonLink || ''}" placeholder="Button Link">
                        </div>
                        <div class="mt-2 text-muted">
                            Reactions: ‚ù§Ô∏è ${request.reactions?.["‚ù§Ô∏è"] || 0} | üòÇ ${request.reactions?.["üòÇ"] || 0} | üëç ${request.reactions?.["üëç"] || 0} | üåü ${request.reactions?.["üåü"] || 0}
                        </div>
                    </div>
                `;
                listContainer.appendChild(requestItem);

                // Attach event listeners for inline editing and deletion
                requestItem.querySelector('.request-title')?.addEventListener('blur', (e) => updateRequestCourse(requestId, 'title', e.target.textContent));
                requestItem.querySelector('.request-description')?.addEventListener('blur', (e) => updateRequestCourse(requestId, 'description', e.target.value));
                requestItem.querySelector('.request-image-url')?.addEventListener('change', (e) => updateRequestCourse(requestId, 'imageUrl', e.target.value));
                requestItem.querySelector('.request-button-text')?.addEventListener('blur', (e) => updateRequestCourse(requestId, 'buttonText', e.target.value));
                requestItem.querySelector('.request-button-link')?.addEventListener('change', (e) => updateRequestCourse(requestId, 'buttonLink', e.target.value));
                requestItem.querySelector('.delete-request')?.addEventListener('click', () => deleteRequestCourse(requestId));
            });
        };
        const addRequestCourse = async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

            const titleInput = document.getElementById('requestCourseTitle');
            const descriptionInput = document.getElementById('requestCourseDescription');
            const imageUrlInput = document.getElementById('requestCourseImageUrl');
            const buttonTextInput = document.getElementById('requestCourseButtonText');
            const buttonLinkInput = document.getElementById('requestCourseButtonLink');

            if (!titleInput || !descriptionInput || !imageUrlInput || !buttonTextInput || !buttonLinkInput) { // Safety check
                msg('Request Course input fields not found!', 'danger');
                return;
            }

            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const imageUrl = imageUrlInput.value.trim();
            const buttonText = buttonTextInput.value.trim();
            const buttonLink = buttonLinkInput.value.trim();
            if (!title) { msg('Request Course Title is required!', 'warning'); return; }

            showLoading('Adding request course...');
            try {
                const newRef = push(requestCoursesRef);
                await set(newRef, {
                    title,
                    description: description || null,
                    imageUrl: imageUrl || null,
                    buttonText: buttonText || null,
                    buttonLink: buttonLink || null,
                    timestamp: serverTimestamp(),
                    reactions: { "‚ù§Ô∏è": 0, "üòÇ": 0, "üëç": 0, "üåü": 0 }
                });
                msg('Request course added successfully!', 'success');
                // Clear fields after successful addition
                titleInput.value = '';
                descriptionInput.value = '';
                imageUrlInput.value = '';
                buttonTextInput.value = '';
                buttonLinkInput.value = '';
            } catch (error) {
                msg(`Error adding request course: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        const updateRequestCourse = async (requestId, field, value) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            showLoading('Updating request course...');
            try {
                // Firebase sets null for empty strings when using update, which is fine.
                await update(dbRef(db, `requestCourses/${requestId}`), { [field]: value || null });
                msg('Request course updated!', 'info');
            } catch (error) {
                msg(`Error updating request course: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        const deleteRequestCourse = async (requestId) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const confirmDelete = await showConfirm('Are you sure you want to delete this request course post?');
            if (confirmDelete) {
                showLoading('Deleting request course...');
                try {
                    await remove(dbRef(db, `requestCourses/${requestId}`));
                    msg('Request course deleted!', 'danger');
                } catch (error) {
                    msg(`Error deleting request course: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            }
        };
        document.getElementById('addRequestCourse')?.addEventListener('click', addRequestCourse);


        // Load and display categories
        const loadCategories = () => {
            const catRef = dbRef(db, 'categories');
            onValue(catRef, (snapshot) => {
                const data = snapshot.val() || {};
                renderCategories(data);
            }, (error) => {
                msg(`Error loading categories: ${error.message}`, 'danger');
            });
        };

        const renderCategories = (cats) => {
            const container = document.getElementById('categoriesList');
            if (!container) return; // Safety check

            container.innerHTML = '';
            if (Object.keys(cats).length === 0) {
                container.innerHTML = '<p class="text-muted fst-italic">No categories added yet. Start by creating one above!</p>';
                return;
            }
            Object.entries(cats).forEach(([catId, cat]) => {
                const card = document.createElement('div');
                card.className = "card mb-3";
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 contenteditable="true" data-id="${catId}" class="cat-name flex-grow-1 me-2">${cat.name}</h5>
                            <button class="btn btn-danger btn-sm delete-cat" data-id="${catId}">Delete Category</button>
                        </div>
                        <div class="mb-3">
                            <label for="categoryImageUrl-${catId}" class="form-label">Category Image URL:</label>
                            ${cat.imageUrl ? `<img src="${cat.imageUrl}" alt="Category Image" class="thumbnail-preview">` : '<p class="text-muted">No image selected.</p>'}
                            <input type="url" class="form-control form-control-sm mt-2 category-image-url" id="categoryImageUrl-${catId}" data-id="${catId}" value="${cat.imageUrl || ''}" placeholder="e.g., https://example.com/image.jpg">
                        </div>
                        <hr>
                        <h6 class="mb-2 text-muted">Batches:</h6>
                        <div>
                            <button class="btn btn-secondary btn-sm mb-2 add-batch" data-id="${catId}">+ Add Batch</button>
                            <div class="batches-list" id="batches-list-${catId}"></div>
                        </div>
                    </div>`;
                setupCategoryEvents(card, catId, cat.imageUrl);
                container.append(card);
            });
        };

        const setupCategoryEvents = (card, catId, currentImageUrl) => {
            const nameEl = card.querySelector('.cat-name');
            if (nameEl) { // Safety check
                nameEl.addEventListener('blur', async () => {
                    if (!isAuthenticated) { // Check authentication before allowing changes
                        msg('You must be logged in to make changes!', 'danger');
                        if (nameEl.dataset.originalName) { // Check if originalName exists
                            nameEl.textContent = nameEl.dataset.originalName;
                        }
                        return;
                    }
                    const newName = nameEl.textContent.trim();
                    if (newName && newName !== nameEl.dataset.originalName) {
                        try {
                            await update(dbRef(db, `categories/${catId}`), { name: newName });
                            msg('Category name updated', 'info');
                        } catch (error) {
                            msg(`Error updating category name: ${error.message}`, 'danger');
                        }
                    }
                    nameEl.dataset.originalName = newName;
                });
            }

            const imageUrlInput = card.querySelector('.category-image-url');
            if (imageUrlInput) { // Safety check
                imageUrlInput.addEventListener('change', async (e) => {
                    if (!isAuthenticated) { // Check authentication before allowing changes
                        msg('You must be logged in to make changes!', 'danger');
                        e.target.value = currentImageUrl; // Revert changes
                        return;
                    }
                    const newImageUrl = e.target.value.trim();
                    try {
                        await update(dbRef(db, `categories/${catId}`), { imageUrl: newImageUrl });
                        msg('Category image URL updated successfully!', 'success');
                    } catch (error) {
                        msg(`Error updating category image URL: ${error.message}`, 'danger');
                    }
                });
            }
            
            card.querySelector('.delete-cat')?.addEventListener('click', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                const confirmDelete = await showConfirm('Are you sure you want to delete this category and all its contents (batches, modules, lectures)?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting category and content...');
                        await remove(dbRef(db, `categories/${catId}`));
                        msg('Category and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting category: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            card.querySelector('.add-batch')?.addEventListener('click', async () => { // Optional chaining
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const batchTypeChoice = await showConfirm('Is this a Direct Link Batch? (OK for Direct Link, Cancel for Regular Modules/Lectures)');
                let title = prompt('Enter Batch title:');
                if (!title) { msg('Batch title is required!', 'warning'); return; }

                const thumbnailUrl = prompt('Enter Thumbnail URL (e.g., https://via.placeholder.com/150):');
                if (!thumbnailUrl) { msg('Thumbnail URL is required!', 'warning'); return; }

                const description = prompt('Enter Batch description (max 100 words):');
                if (!description) { msg('Batch description is required!', 'warning'); return; }
                if (description.split(/\s+/).length > 100) { msg('Description exceeds 100 words! Please re-enter.', 'warning'); return; }

                let isContentDirectLink = batchTypeChoice;
                let directDriveLink = null;
                let modules = null;

                if (isContentDirectLink) {
                    directDriveLink = prompt('Enter Direct Link (for redirection):');
                    if (!directDriveLink) {
                        msg('Direct Link is required for this batch type! Batch not added.', 'warning');
                        return;
                    }
                    modules = null;
                } else {
                    modules = {};
                }

                let originalPrice = null;
                let discountedPrice = null;
                let isFree = false;

                if (!isContentDirectLink) {
                    originalPrice = prompt('Enter Original Price (e.g., 999 or leave empty if free):');
                    discountedPrice = prompt('Enter Discounted Price (e.g., 499 or 0 for FREE):');

                    originalPrice = originalPrice ? parseFloat(originalPrice) : null;
                    discountedPrice = discountedPrice ? parseFloat(discountedPrice) : null;
                    isFree = (discountedPrice === 0) || (originalPrice === null && discountedPrice === null);
                } else {
                    isFree = true;
                    discountedPrice = 0;
                }

                // NEW: isPublic property for batches, default to true
                const isPublic = await showConfirm('Should this batch be Public (visible on website)? (OK for Public, Cancel for Private)');
                try {
                    showLoading('Adding batch...');
                    const newRef = push(dbRef(db, `categories/${catId}/batches`));
                    await set(newRef, {
                        title,
                        thumbnail: thumbnailUrl,
                        description,
                        originalPrice: originalPrice,
                        discountedPrice: discountedPrice,
                        isFree: isFree,
                        isNew: true, // This is key for 'new' notification on website
                        isContentDirectLink: isContentDirectLink,
                        modules: modules,
                        directDriveLink: directDriveLink,
                        isPublic: isPublic, // NEW: Add isPublic property
                        timestamp: serverTimestamp() // This is key for sorting and detecting 'new' or 'updated'
                    });
                    msg('Batch added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding batch: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            });

            const batchesListContainer = card.querySelector(`#batches-list-${catId}`);
            if (batchesListContainer) { // Safety check
                onValue(dbRef(db, `categories/${catId}/batches`), (snapshot) => {
                    batchesListContainer.innerHTML = '';
                    const batchData = snapshot.val() || {};
                    if (Object.keys(batchData).length === 0) {
                        batchesListContainer.innerHTML = '<p class="text-muted fst-italic">No batches in this category.</p>';
                    }
                    Object.entries(batchData).forEach(([bId, batch]) => {
                        const item = createBatchItem(catId, bId, batch);
                        batchesListContainer.append(item);
                    });
                },
                (error) => {
                    msg(`Error loading batches: ${error.message}`, 'danger');
                });
            }
        };

        const setupBatchEvents = (card, catId, bId, currentBatch) => {
            // Batch title editing
            card.querySelector('.batch-title')?.addEventListener('blur', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.textContent = currentBatch.title; return; }
                const newTitle = e.target.textContent.trim();
                if (newTitle && newTitle !== currentBatch.title) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { title: newTitle });
                        msg('Batch title updated', 'info');
                    } catch (error) {
                        msg(`Error updating batch title: ${error.message}`, 'danger');
                    }
                }
            });
            // Batch thumbnail URL
            card.querySelector('.batch-thumbnail-url')?.addEventListener('change', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.value = currentBatch.thumbnail; return; }
                const newThumbnail = e.target.value.trim();
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { thumbnail: newThumbnail });
                    msg('Batch thumbnail updated', 'info');
                } catch (error) {
                    msg(`Error updating batch thumbnail: ${error.message}`, 'danger');
                }
            });
            // Batch description
            card.querySelector('.batch-description')?.addEventListener('blur', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.value = currentBatch.description; return; }
                const newDescription = e.target.value.trim();
                if (newDescription && newDescription !== currentBatch.description) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { description: newDescription });
                        msg('Batch description updated', 'info');
                    } catch (error) {
                        msg(`Error updating batch description: ${error.message}`, 'danger');
                    }
                }
            });
            // Batch original price
            card.querySelector('.batch-original-price')?.addEventListener('change', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.value = currentBatch.originalPrice || ''; return; }
                const newPrice = e.target.value === '' ? null : parseFloat(e.target.value);
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { originalPrice: newPrice });
                    msg('Original price updated', 'info');
                }  catch (error) {
                    msg(`Error updating original price: ${error.message}`, 'danger');
                }
            });
            // Batch discounted price
            card.querySelector('.batch-discounted-price')?.addEventListener('change', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.value = currentBatch.discountedPrice || ''; return; }
                const newPrice = e.target.value === '' ? null : parseFloat(e.target.value);
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { discountedPrice: newPrice });
                    msg('Discounted price updated', 'info');
                } catch (error) {
                    msg(`Error updating discounted price: ${error.message}`, 'danger');
                }
            });
            
            // "Batch Updated" Button:
            card.querySelector('.update-batch-notification')?.addEventListener('click', async () => { // Optional chaining
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const confirmUpdate = await showConfirm('Are you sure you want to send an "Updated" notification for this batch?');
                if (confirmUpdate) {
                    showLoading('Sending update notification...');
                    try {
                        // Ensure isNew is false when manually sending an update notification
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { 
                            isNew: false, // Mark as NOT new for update notification
                            timestamp: serverTimestamp() // Update timestamp to trigger "updated" notification
                        });
                        msg('Batch update notification sent!', 'success');
                    } catch (error) {
                        msg(`Error sending update notification: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            // Mark as New/Old buttons (NEWLY ADDED Logic)
            card.querySelector('.mark-as-new-batch')?.addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const confirmMark = await showConfirm('Are you sure you want to mark this batch as NEW? This will display a "NEW!" tag and potentially trigger a notification on the website.');
                if (confirmMark) {
                    showLoading('Marking batch as NEW...');
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { 
                            isNew: true, 
                            timestamp: serverTimestamp() // Update timestamp to make it appear newest
                        });
                        msg('Batch marked as NEW!', 'success');
                    } catch (error) {
                        msg(`Error marking batch as new: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            card.querySelector('.mark-as-old-batch')?.addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const confirmMark = await showConfirm('Are you sure you want to mark this batch as OLD? This will remove the "NEW!" tag on the website.');
                if (confirmMark) {
                    showLoading('Marking batch as OLD...');
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { 
                            isNew: false // Simply set isNew to false
                        });
                        msg('Batch marked as OLD!', 'info');
                    } catch (error) {
                        msg(`Error marking batch as old: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            // Mark as Free/Paid buttons (NEWLY ADDED Logic)
            card.querySelector('.mark-as-free-batch')?.addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const confirmMark = await showConfirm('Are you sure you want to mark this batch as FREE?');
                if (confirmMark) {
                    showLoading('Marking batch as FREE...');
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { 
                            isFree: true,
                            discountedPrice: 0, // Set discounted price to 0 if free
                            originalPrice: null // Clear original price if free
                        });
                        msg('Batch marked as FREE!', 'success');
                    } catch (error) {
                        msg(`Error marking batch as free: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            card.querySelector('.mark-as-paid-batch')?.addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const confirmMark = await showConfirm('Are you sure you want to mark this batch as PAID?');
                if (confirmMark) {
                    showLoading('Marking batch as PAID...');
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { 
                            isFree: false // Set to false if paid
                        });
                        msg('Batch marked as PAID!', 'info');
                    } catch (error) {
                        msg(`Error marking batch as paid: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            // Toggle isContentDirectLink status
            const toggleIsContentDirectLink = card.querySelector('.toggle-iscontentdirectlink');
            if (toggleIsContentDirectLink) {
                toggleIsContentDirectLink.addEventListener('click', async () => {
                    if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                    const newValue = !currentBatch.isContentDirectLink;
                    const confirm = await showConfirm(`Are you sure you want to change this batch to ${newValue ? 'Direct Link' : 'Normal Modules'}? This will reset content structure.`);
                    if (confirm) {
                        showLoading('Updating batch type...');
                        try {
                            const updates = {
                                isContentDirectLink: newValue,
                                modules: null,
                                directDriveLink: null,
                                originalPrice: null,
                                discountedPrice: 0,
                                isFree: true
                            };
                            await update(dbRef(db, `categories/${catId}/batches/${bId}`), updates);
                            msg('Batch type updated and content reset. Please re-enter details.', 'info');
                        } catch (error) {
                            msg(`Error updating batch type: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                });
            }

            // NEW: Toggle isPublic status for batches
            const toggleIsPublic = card.querySelector('.toggle-ispublic');
            if (toggleIsPublic) {
                toggleIsPublic.addEventListener('click', async () => {
                    if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                    const newValue = !currentBatch.isPublic;
                    const confirmMsg = newValue 
                        ? 'Are you sure you want to make this batch PUBLIC? It will become visible on the website.'
                        : 'Are you sure you want to make this batch PRIVATE? It will be hidden from the website.';
                    const confirm = await showConfirm(confirmMsg);
                    if (confirm) {
                        showLoading('Updating batch visibility...');
                        try {
                            const updates = { isPublic: newValue };
                            
                            // Logic for Homepage Batch Notification based on Public/Private toggle
                            if (newValue === true && currentBatch.isPublic === false) { // If making public AND it was previously private
                                // If it was just added as new, keep it new. Else, mark as updated.
                                if (currentBatch.isNew !== true) { // If it's NOT already explicitly new, treat as update
                                    updates.isNew = false; // Ensure it's not marked as "new" for public batch notification
                                    updates.timestamp = serverTimestamp(); // Update timestamp to trigger "updated" notification
                                } else { // It's a new batch made public. Timestamp should be updated.
                                    updates.timestamp = serverTimestamp(); 
                                }
                            } else if (newValue === false && currentBatch.isPublic === true) { // If making private
                                updates.isNew = false; // When private, it's definitely not "new" for public display
                                // Timestamp is not critical here, as it's hidden.
                            } else if (newValue === true && currentBatch.isPublic === true && currentBatch.isNew === true) {
                                // If it's already public AND still marked as new (meaning it was just added publically),
                                // and admin clicks again (e.g., to make private then public quickly),
                                // we can reset isNew to false so it doesn't keep showing as NEW every time.
                                updates.isNew = false;
                            }

                            await update(dbRef(db, `categories/${catId}/batches/${bId}`), updates);
                            msg(`Batch visibility changed to ${newValue ? 'PUBLIC' : 'PRIVATE'}!`, 'info');
                        } catch (error) {
                            msg(`Error updating batch visibility: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                });
            }


            // Delete Batch
            card.querySelector('.delete-batch')?.addEventListener('click', async (e) => { // Optional chaining
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                const confirmDelete = await showConfirm('Are you sure you want to delete this batch and all its modules/lectures?');
                if (confirmDelete) {
                    showLoading('Deleting batch and content...');
                    try {
                        await remove(dbRef(db, `categories/${catId}/batches/${bId}`));
                        msg('Batch and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting batch: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });
            // --- Direct Link Specific Events ---
            const directDriveLinkInput = card.querySelector('.direct-drive-link');
            if (directDriveLinkInput) {
                directDriveLinkInput.addEventListener('change', async (e) => {
                    if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.value = currentBatch.directDriveLink || ''; return; }
                    const newLink = e.target.value.trim();
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { directDriveLink: newLink });
                        msg('Direct Link updated!', 'info');
                    } catch (error) {
                        msg(`Error updating Direct Link: ${error.message}`, 'danger');
                    }
                });
            }

            // Handle "Add Module" for NORMAL batches
            card.querySelector('.add-module')?.addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const moduleName = prompt('Enter Module Name:');
                if (!moduleName) { msg('Module name is required!', 'warning'); return; }

                // NEW: Ask for public/private status for new modules
                const isModulePublic = await showConfirm('Should this module be Public (visible on website)? (OK for Public, Cancel for Private)');

                showLoading('Adding module...');
                try {
                    const newModuleRef = push(dbRef(db, `categories/${catId}/batches/${bId}/modules`));
                    await set(newModuleRef, { 
                        name: moduleName, 
                        lectures: {},
                        isPublic: isModulePublic // NEW: Add isPublic property for modules
                    });
                    msg('Module added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding module: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            });
            // Listen for changes in modules for NORMAL batches
            const modulesListContainer = card.querySelector(`#modules-list-${bId}`);
            if (modulesListContainer) { // Safety check
                onValue(dbRef(db, `categories/${catId}/batches/${bId}/modules`), (snapshot) => {
                    modulesListContainer.innerHTML = '';
                    const modulesData = snapshot.val() || {};
                    if (Object.keys(modulesData).length === 0) {
                        modulesListContainer.innerHTML = '<p class="text-muted fst-italic">No modules in this batch.</p>';
                    }
                    Object.entries(modulesData).forEach(([modId, module]) => {
                        const item = createModuleItem(catId, bId, modId, module);
                        modulesListContainer.append(item);
                    });
                });
            }
        };

        const createBatchItem = (catId, bId, batch) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 bg-dark'; // Changed bg-light to bg-dark

            const displayPrice = (batch.isFree || (batch.originalPrice === null && batch.discountedPrice === null)) ?
                '<span class="fw-bold text-success">FREE</span>' :
                (batch.discountedPrice !== null ? `‚Çπ${batch.discountedPrice}` : (batch.originalPrice !== null ? `‚Çπ${batch.originalPrice}` : 'Price N/A'));
            const originalPriceStrikethrough = (batch.originalPrice !== null && batch.discountedPrice !== null && batch.discountedPrice < batch.originalPrice) ? `<s class="text-muted ms-2">‚Çπ${batch.originalPrice}</s>` : '';
            const normalContentSectionDisplay = (!batch.isContentDirectLink) ? 'block' : 'none';
            const directLinkSectionDisplay = (batch.isContentDirectLink) ? 'block' : 'none';
            
            // Batch Type Tag (Free/Paid) - NEWLY ADDED for website visibility
            const batchTypeTag = batch.isFree ? 
                                `<span class="badge bg-success ms-2">FREE</span>` :
                                (batch.discountedPrice !== null && batch.discountedPrice === 0 ? // If discounted price is 0, also show FREE
                                `<span class="badge bg-success ms-2">FREE</span>` :
                                `<span class="badge bg-danger ms-2">PAID</span>`); // Otherwise, it's paid

            // Check if isNew is explicitly true
            const isNewBadge = batch.isNew === true ?
                '<span class="badge bg-warning ms-2">NEW!</span>' : '';

            // Check if batch is public or private
            const isPublicBadge = batch.isPublic === true ?
                '<span class="badge bg-success ms-2">PUBLIC</span>' : 
                '<span class="badge bg-secondary ms-2">PRIVATE</span>';
            const batchItem = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="batch-title flex-grow-1 me-2" contenteditable="true">${batch.title || 'Untitled Batch'}</h6>
                    <div>
                        ${batchTypeTag} ${isNewBadge}
                        ${isPublicBadge}
                        <button class="btn btn-sm btn-outline-info toggle-ispublic" data-id="${bId}" data-public="${batch.isPublic}">
                            ${batch.isPublic ? 'Make Private' : 'Make Public'}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img src="${batch.thumbnail || 'https://via.placeholder.com/100x70?text=No+Thumb'}" alt="Thumbnail" class="thumbnail-preview">
                        <div>
                            <small class="text-muted">Thumbnail URL:</small>
                            <input type="url" class="form-control form-control-sm batch-thumbnail-url" value="${batch.thumbnail || ''}" placeholder="Image URL">
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Description:</small>
                        <textarea class="form-control form-control-sm batch-description" rows="2" placeholder="Batch Description (max 100 words)">${batch.description || ''}</textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <small class="text-muted">Original Price:</small>
                            <input type="number" step="0.01" class="form-control form-control-sm batch-original-price" value="${batch.originalPrice !== null ? batch.originalPrice : ''}" placeholder="e.g., 999">
                        </div>
                        <div class="col">
                            <small class="text-muted">Discounted Price:</small>
                            <input type="number" step="0.01" class="form-control form-control-sm batch-discounted-price" value="${batch.discountedPrice !== null ? batch.discountedPrice : ''}" placeholder="e.g., 499 (0 for Free)">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap"> <button class="btn btn-sm btn-info toggle-iscontentdirectlink mb-2">
                            ${batch.isContentDirectLink ? 'Change to Modules' : 'Change to Direct Link'}
                        </button>
                        <button class="btn btn-sm btn-primary update-batch-notification mb-2" data-id="${bId}">Send Update Notification</button>
                        <button class="btn btn-sm btn-primary mark-as-new-batch mb-2" data-id="${bId}">Mark as NEW</button>
                        <button class="btn btn-sm btn-warning mark-as-old-batch mb-2" data-id="${bId}">Mark as OLD</button>
                        <button class="btn btn-sm btn-success mark-as-free-batch mb-2" data-id="${bId}">Mark as FREE</button> <button class="btn btn-sm btn-info mark-as-paid-batch mb-2" data-id="${bId}">Mark as PAID</button> <button class="btn btn-sm btn-danger delete-batch mb-2" data-id="${bId}">Delete Batch</button>
                    </div>

                    <div style="display: ${directLinkSectionDisplay};">
                        <hr>
                        <h6 class="mb-2 text-muted">Direct Content Link:</h6>
                        <input type="url" class="form-control form-control-sm direct-drive-link" value="${batch.directDriveLink || ''}" placeholder="Google Drive/External Link">
                    </div>

                    <div style="display: ${normalContentSectionDisplay};">
                        <hr>
                        <h6 class="mb-2 text-muted">Modules:</h6>
                        <button class="btn btn-secondary btn-sm mb-2 add-module" data-id="${bId}">+ Add Module</button>
                        <div class="modules-list" id="modules-list-${bId}"></div>
                    </div>
                </div>
            `;
            div.innerHTML = batchItem;
            setupBatchEvents(div, catId, bId, batch);
            return div;
        };
        
        const createModuleItem = (catId, bId, modId, module) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 ms-3'; // Indent modules
            
            // Filter lectures for display (only public ones)
            // Note: This filtering is for website, not admin panel. Admin panel shows all.
            const lecturesCount = Object.values(module.lectures || {}).filter(item => item.type === 'lecture').length;
            const resourcesCount = Object.values(module.lectures || {}).filter(item => item.type === 'resource').length;
            let countsText = '';
            if (lecturesCount > 0 && resourcesCount > 0) {
                countsText = `<span>${lecturesCount} Lectures</span> | <span>${resourcesCount} Resources</span>`;
            } else if (lecturesCount > 0) {
                countsText = `<span>${lecturesCount} Lectures</span>`;
            } else if (resourcesCount > 0) {
                countsText = `<span>${resourcesCount} Resources</span>`;
            } else {
                countsText = `<span>No Content</span>`;
            }

            const isPublicBadge = module.isPublic === true ?
                '<span class="badge bg-success ms-2">PUBLIC</span>' : 
                '<span class="badge bg-secondary ms-2">PRIVATE</span>';
            div.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="module-name flex-grow-1 me-2" contenteditable="true">${module.name || 'Untitled Module'}</h6>
                    <div>
                        ${isPublicBadge}
                        <button class="btn btn-sm btn-outline-info toggle-ispublic-module" data-id="${modId}" data-public="${module.isPublic}">
                            ${module.isPublic ? 'Make Private' : 'Make Public'}
                        </button>
                        <button class="btn btn-sm btn-danger delete-module" data-id="${modId}">Delete Module</button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted fst-italic">Content: ${countsText}</p>
                    <button class="btn btn-primary btn-sm mb-2 add-lecture" data-id="${modId}">+ Add Lecture/Resource</button>
                    <div class="lectures-list" id="lectures-list-${modId}"></div>
                </div>
            `;
            setupModuleEvents(div, catId, bId, modId, module);
            return div;
        };

        const setupModuleEvents = (card, catId, bId, modId, currentModule) => {
            // Module name editing
            card.querySelector('.module-name')?.addEventListener('blur', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.textContent = currentModule.name; return; }
                const newName = e.target.textContent.trim();
                if (newName && newName !== currentModule.name) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}`), { name: newName });
                        msg('Module name updated', 'info');
                    } catch (error) {
                        msg(`Error updating module name: ${error.message}`, 'danger');
                    }
                }
            });
            // NEW: Toggle isPublic status for modules
            card.querySelector('.toggle-ispublic-module')?.addEventListener('click', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                const newValue = !currentModule.isPublic;
                const confirmMsg = newValue 
                    ? 'Are you sure you want to make this module PUBLIC? It will become visible on the website.'
                    : 'Are you sure you want to make this module PRIVATE? It will be hidden from the website.';
                const confirm = await showConfirm(confirmMsg);
                if (confirm) {
                    showLoading('Updating module visibility...');
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}`), { isPublic: newValue });
                        msg(`Module visibility changed to ${newValue ? 'PUBLIC' : 'PRIVATE'}!`, 'info');
                    } catch (error) {
                        msg(`Error updating module visibility: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });
            // Delete Module
            card.querySelector('.delete-module')?.addEventListener('click', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                const confirmDelete = await showConfirm('Are you sure you want to delete this module and all its lectures/resources?');
                if (confirmDelete) {
                    showLoading('Deleting module and content...');
                    try {
                        await remove(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}`));
                        msg('Module and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting module: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });
            // Add Lecture/Resource
            card.querySelector('.add-lecture')?.addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const contentType = await showLectureResourceModal();
                if (!contentType) return; // User cancelled

                const name = prompt(`Enter ${contentType === 'lecture' ? 'Lecture Title' : 'Resource Name'}:`);
                if (!name) { msg('Name is required!', 'warning'); return; }

                const url = prompt(`Enter ${contentType === 'lecture' ? 'YouTube/Drive Video URL' : 'File/Link URL'}:`);
                if (!url) { msg('URL is required!', 'warning'); return; }

                // NEW: Ask for public/private status for new lectures/resources
                const isLectureResourcePublic = await showConfirm(`Should this ${contentType} be Public (visible on website)? (OK for Public, Cancel for Private)`);

                showLoading(`Adding ${contentType}...`);
                try {
                    const newRef = push(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}/lectures`));
                    await set(newRef, { 
                        name: name, 
                        url: url, 
                        type: contentType,
                        isPublic: isLectureResourcePublic // NEW: Add isPublic property
                    });
                    msg(`${contentType} added successfully!`, 'success');
                } catch (error) {
                    msg(`Error adding ${contentType}: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            });
            // Listen for changes in lectures for current module
            const lecturesListContainer = card.querySelector(`#lectures-list-${modId}`);
            if (lecturesListContainer) { // Safety check
                onValue(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}/lectures`), (snapshot) => {
                    lecturesListContainer.innerHTML = '';
                    const lecturesData = snapshot.val() || {};
                    if (Object.keys(lecturesData).length === 0) {
                        lecturesListContainer.innerHTML = '<p class="text-muted fst-italic">No lectures or resources in this module.</p>';
                    }
                    Object.entries(lecturesData).forEach(([itemId, item]) => {
                        const lectureItem = createLectureResourceItem(catId, bId, modId, itemId, item);
                        lecturesListContainer.append(lectureItem);
                    });
                });
            }
        };

        const createLectureResourceItem = (catId, bId, modId, itemId, item) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 ms-4'; // Indent lectures/resources further

            const typeBadgeClass = item.type === 'lecture' ? 'bg-primary' : 'bg-info';
            const typeText = item.type === 'lecture' ? 'Lecture' : 'Resource';

            const isPublicBadge = item.isPublic === true ?
                '<span class="badge bg-success ms-2">PUBLIC</span>' : 
                '<span class="badge bg-secondary ms-2">PRIVATE</span>';
            div.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="item-name flex-grow-1 me-2" contenteditable="true">${item.name || 'Untitled Item'}</h6>
                        <div>
                            <span class="badge ${typeBadgeClass}">${typeText}</span>
                            ${isPublicBadge}
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">URL:</small>
                        <input type="url" class="form-control form-control-sm item-url" value="${item.url || ''}" placeholder="Content URL">
                    </div>
                    <div class="item-controls d-flex justify-content-end gap-2">
                        <button class="btn btn-sm btn-outline-info toggle-ispublic-item" data-id="${itemId}" data-public="${item.isPublic}">
                            ${item.isPublic ? 'Make Private' : 'Make Public'}
                        </button>
                        <button class="btn btn-sm btn-danger delete-item" data-id="${itemId}">Delete</button>
                    </div>
                </div>
            `;
            setupLectureResourceEvents(div, catId, bId, modId, itemId, item);
            return div;
        };
        const setupLectureResourceEvents = (card, catId, bId, modId, itemId, currentItem) => {
            // Item name editing
            card.querySelector('.item-name')?.addEventListener('blur', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.textContent = currentItem.name; return; }
                const newName = e.target.textContent.trim();
                if (newName && newName !== currentItem.name) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}/lectures/${itemId}`), { name: newName });
                        msg('Item name updated', 'info');
                    } catch (error) {
                        msg(`Error updating item name: ${error.message}`, 'danger');
                    }
                }
            });
            // Item URL editing
            card.querySelector('.item-url')?.addEventListener('change', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); e.target.value = currentItem.url; return; }
                const newUrl = e.target.value.trim();
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}/lectures/${itemId}`), { url: newUrl });
                    msg('Item URL updated', 'info');
                } catch (error) {
                    msg(`Error updating item URL: ${error.message}`, 'danger');
                }
            });

            // NEW: Toggle isPublic status for lecture/resource items
            card.querySelector('.toggle-ispublic-item')?.addEventListener('click', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                const newValue = !currentItem.isPublic;
                const confirmMsg = newValue 
                    ? `Are you sure you want to make this ${currentItem.type} PUBLIC? It will become visible on the website.`
                    : `Are you sure you want to make this ${currentItem.type} PRIVATE? It will be hidden from the website.`;
                const confirm = await showConfirm(confirmMsg);
                if (confirm) {
                    showLoading(`Updating ${currentItem.type} visibility...`);
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}/lectures/${itemId}`), { isPublic: newValue });
                        msg(`${currentItem.type} visibility changed to ${newValue ? 'PUBLIC' : 'PRIVATE'}!`, 'info');
                    } catch (error) {
                        msg(`Error updating ${currentItem.type} visibility: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });
            // Delete Item
            card.querySelector('.delete-item')?.addEventListener('click', async (e) => {
                if (!isAuthenticated) { msg('You must be logged in to make changes!', 'danger'); return; }
                const confirmDelete = await showConfirm(`Are you sure you want to delete this ${currentItem.type}?`);
                if (confirmDelete) {
                    showLoading(`Deleting ${currentItem.type}...`);
                    try {
                        await remove(dbRef(db, `categories/${catId}/batches/${bId}/modules/${modId}/lectures/${itemId}`));
                        msg(`${currentItem.type} deleted!`, 'danger');
                    } catch (error) {
                        msg(`Error deleting ${currentItem.type}: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });
        };


        // Firebase Authentication State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAuthenticated = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainWrapper').style.display = 'flex';
                document.getElementById('bottomNavbar').style.display = 'flex';
                loadCategories();
                loadSiteConfig();
                setupSiteConfigEvents();
                // Initially show home section and analytics
                showSection('home-section');
            } else {
                isAuthenticated = false;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainWrapper').style.display = 'none';
                document.getElementById('bottomNavbar').style.display = 'none';
            }
        });
        document.getElementById('loginButton')?.addEventListener('click', async () => {
            const email = document.getElementById('adminEmail')?.value;
            const password = document.getElementById('adminPassword')?.value;
            const loginAlerts = document.getElementById('loginAlerts');
            if(!loginAlerts) return; // Safety check

            loginAlerts.style.display = 'none';

            if (!email || !password) {
                loginAlerts.textContent = 'Please enter both email and password!';
                loginAlerts.style.display = 'block';
                return;
            }

            showLoading('Logging in...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                msg('Logged in successfully!', 'success', 'loginAlerts');
                // The onAuthStateChanged listener will handle UI update
            } catch (error) {
                loginAlerts.textContent = `Login failed: ${error.message}`;
                loginAlerts.style.display = 'block';
                console.error("Login Error:", error);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('logoutButton')?.addEventListener('click', async () => {
            const confirmLogout = await showConfirm('Are you sure you want to log out?');
            if (confirmLogout) {
                showLoading('Logging out...');
                try {
                    await signOut(auth);
                    msg('Logged out successfully!', 'info');
                    // The onAuthStateChanged listener will handle UI update
                } catch (error) {
                    msg(`Logout failed: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            }
        });
        // Initial setup calls
        document.addEventListener('DOMContentLoaded', () => {
            // No need to call loadCategories, loadSiteConfig, setupSiteConfigEvents here
            // as onAuthStateChanged handles it after successful login.
            // But we can setup default quote
            updateHomePageQuote();
            setInterval(updateHomePageQuote, 5000); // Update quote every 5 seconds
        });
    </script>
</body>
</html>
