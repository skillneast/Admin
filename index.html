<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillNeast Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            padding: 10px;
            background-color: #f0f2f5;
            font-family: 'Open Sans', sans-serif;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h2, h5 {
            color: #007bff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 20px;
            padding: 8px 20px;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            border-radius: 15px;
            padding: 5px 12px;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            border-radius: 15px;
            padding: 5px 12px;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            border-radius: 15px;
            padding: 5px 12px;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            border-radius: 15px;
            padding: 5px 12px;
        }
        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }
        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .alert {
            margin-top: 15px;
            border-radius: 8px;
        }
        .card {
            border-radius: 10px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
            background-color: #fdfdfd;
        }
        .card-body {
            padding: 20px;
        }
        .cat-name, .batch-title, .module-name {
            cursor: text;
            font-weight: 600;
        }
        .batches-list, .modules-list, .lectures-list {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 3px solid #e9ecef;
            margin-top: 10px;
        }
        img.thumbnail-preview {
            border-radius: 8px;
            object-fit: cover;
            width: 100px;
            height: 70px;
            margin-right: 15px;
            border: 1px solid #ddd;
        }
        input.form-control-sm {
            max-width: 300px;
        }
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        /* Custom Modal Styling (for alert/confirm replacements) */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060; /* Higher than Bootstrap modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-modal-content h5 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #343a40;
        }
        .custom-modal-content .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        /* Loading Spinner */
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1070;
            color: white;
            font-size: 1.2em;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .loading-spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-message {
            margin-top: 10px;
        }

        /* New styles for how-to-use videos */
        .how-to-use-video-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 8px;
        }
        .how-to-use-video-item div {
            flex-grow: 1;
        }
        .how-to-use-video-item .video-controls {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        .drive-content-list-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .drive-content-list-item:last-child {
            border-bottom: none;
        }
        .drive-content-list-item i {
            margin-right: 10px;
            font-size: 1.2em;
            color: #666;
            min-width: 20px;
            text-align: center;
        }
        .drive-content-list-item span {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .drive-content-preview {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
        }
        /* Style for editable span/input for drive content list */
        .drive-content-name-editable,
        .drive-content-url-editable {
            display: inline-block;
            border: 1px solid transparent;
            padding: 2px 5px;
            border-radius: 3px;
            min-width: 50px;
        }

        .drive-content-name-editable:focus,
        .drive-content-url-editable:focus {
            border-color: #007bff;
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">SkillNeast Admin Panel</h2>
        <div id="alerts"></div>

        <div class="mb-3 p-3 border rounded bg-light">
            <h5>Site Configuration (Global Settings)</h5>
            <div class="mb-3">
                <label for="surpriseButtonLink" class="form-label">Today's Surprise Link</label>
                <input type="url" class="form-control site-config-input" id="surpriseButtonLink" data-key="surpriseButtonLink" placeholder="e.g., https://skillneast.com/surprise">
                <small class="form-text text-muted">Link for the "Today's Surprise!" button on the homepage.</small>
            </div>
            <div class="mb-3">
                <label for="telegramChannelLink" class="form-label">Telegram Channel Link</label>
                <input type="url" class="form-control site-config-input" id="telegramChannelLink" data-key="telegramChannelLink" placeholder="e.g., https://t.me/your_channel">
            </div>
            <div class="mb-3">
                <label for="telegramGroupLink" class="form-label">Telegram Group Link</label>
                <input type="url" class="form-control site-config-input" id="telegramGroupLink" data-key="telegramGroupLink" placeholder="e.g., https://t.me/your_group">
            </div>
            <div class="mb-3">
                <label for="youtubeLink" class="form-label">YouTube Link (About Me)</label>
                <input type="url" class="form-control site-config-input" id="youtubeLink" data-key="youtubeLink" placeholder="e.g., https://www.youtube.com/yourchannel">
            </div>
            <div class="mb-3">
                <label for="instagramLink" class="form-label">Instagram Link (About Me)</label>
                <input type="url" class="form-control site-config-input" id="instagramLink" data-key="instagramLink" placeholder="e.g., https://instagram.com/your_profile">
            </div>
            <div class="mb-3">
                <label for="requestCoursesLink" class="form-label">Request Courses Link</label>
                <input type="url" class="form-control site-config-input" id="requestCoursesLink" data-key="requestCoursesLink" placeholder="e.g., https://forms.google.com/your_form">
            </div>
            <div class="mb-3">
                <label for="profilePictureUrl" class="form-label">About Me Profile Picture URL</label>
                <input type="url" class="form-control site-config-input" id="profilePictureUrl" data-key="profilePictureUrl" placeholder="e.g., https://example.com/profile.jpg">
            </div>
            <div class="mb-3">
                <label for="skillNeastLogoUrl" class="form-label">SkillNeast Logo URL (Top Navbar)</label>
                <input type="url" class="form-control site-config-input" id="skillNeastLogoUrl" data-key="skillNeastLogoUrl" placeholder="e.g., https://example.com/logo.png">
            </div>
            <div class="mb-3">
                <label for="sliderHeaderPictureUrl" class="form-label">Slider Menu Header Picture URL</label>
                <input type="url" class="form-control site-config-input" id="sliderHeaderPictureUrl" data-key="sliderHeaderPictureUrl" placeholder="e.g., https://example.com/slider_header.png">
            </div>
            <div class="mb-3">
                <label for="pwLogoUrl" class="form-label">PW Logo URL (if applicable)</label>
                <input type="url" class="form-control site-config-input" id="pwLogoUrl" data-key="pwLogoUrl" placeholder="e.g., https://example.com/pw_logo.png">
            </div>
        </div>

        <div class="mb-3 p-3 border rounded bg-light">
            <h5>How to Use App Videos</h5>
            <div class="mb-3">
                <label for="howToUseVideoTitle" class="form-label">Video Title</label>
                <input type="text" class="form-control" id="howToUseVideoTitle" placeholder="e.g., App Tutorial Part 1">
            </div>
            <div class="mb-3">
                <label for="howToUseVideoUrl" class="form-label">YouTube/Drive Video URL</label>
                <input type="url" class="form-control" id="howToUseVideoUrl" placeholder="e.g., https://youtu.be/video_id or https://drive.google.com/file/d/FILE_ID/view">
            </div>
            <div class="mb-3">
                <label for="howToUseVideoDescription" class="form-label">Video Description</label>
                <textarea class="form-control" id="howToUseVideoDescription" rows="3" placeholder="Short description of the video."></textarea>
            </div>
            <button id="addHowToUseVideo" class="btn btn-primary mt-2 w-100">Add Video</button>
            <hr>
            <h6 class="mb-2 text-muted">Existing Videos:</h6>
            <div id="howToUseVideosList">
                <p class="text-muted fst-italic">No videos added yet.</p>
            </div>
        </div>

        <div class="mb-3 p-3 border rounded bg-light">
            <h5>Create Category</h5>
            <div class="mb-3">
                <label for="categoryName" class="form-label">Category Name</label>
                <input id="categoryName" type="text" class="form-control" placeholder="e.g., JEE Mains, NEET, Editing">
            </div>
            <div class="mb-3">
                <label for="categoryImageUrl" class="form-label">Category Image URL</label>
                <input type="url" class="form-control" id="categoryImageUrl" placeholder="e.g., https://example.com/image.jpg">
            </div>
            <button id="addCategory" class="btn btn-primary mt-2 w-100">Add Category</button>
        </div>


        <div id="categoriesList" class="mt-4"></div>
    </div>

    <div class="custom-modal-overlay" id="customConfirmModal">
        <div class="custom-modal-content">
            <h5 id="customConfirmMessage"></h5>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="customConfirmCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="customConfirmOK">OK</button>
            </div>
        </div>
    </div>

    <div class="loading-spinner-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-message">Processing...</p>
    </div>

    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as dbRef, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyChwpbFb6M4HtG6zwjg0AXh7Lz9KjnrGZk",
          authDomain: "adminneast.firebaseapp.com",
          databaseURL: "https://adminneast-default-rtdb.firebaseio.com",
          projectId: "adminneast",
          storageBucket: "adminneast.appspot.com",
          messagingSenderId: "883877553418",
          appId: "1:883877553418:web:84ce8200f4b471bfffc6f3",
          measurementId: "G-PCH99BDF1S"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        // --- GOOGLE DRIVE API CONFIGURATION ---
        const GOOGLE_API_KEY = "AIzaSyBlrXftrF9CQezB1risdPilBvmDpNUb_R8"; // Replace with your actual API Key
        const GOOGLE_CLIENT_ID = "809797969413-ttaor2t8nomil5rvfbt9rrd728pn2tc1.apps.googleusercontent.com"; // Replace with your actual Client ID

        let isAuthenticated = false;
        // Global variable for GIS Token Client
        let tokenClient; 
        // Flag to check if gapi.client is initialized
        let gapiClientInitialized = false;
        // Promise resolver for pending authorization request
        let pendingAuthPromiseResolve = null; 

        const authenticateFirebase = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    isAuthenticated = true;
                    console.log("Admin Panel: Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    isAuthenticated = true;
                    console.log("Admin Panel: Signed in anonymously.");
                }
            } catch (error) {
                console.error("Admin Panel Firebase authentication error:", error);
                msg(`Authentication failed: ${error.message}. Please check Firebase config & authorized domains.`, 'danger');
                isAuthenticated = false;
            }
        };

        const msg = (text, type = 'success') => {
            const alertsDiv = document.getElementById('alerts');
            const el = document.createElement('div');
            el.className = `alert alert-${type} fade show`;
            el.textContent = text;
            alertsDiv.append(el);
            setTimeout(() => {
                el.classList.remove('show');
                el.classList.add('fade');
                el.addEventListener('transitionend', () => el.remove(), { once: true });
            }, 3000);
        };

        const showConfirm = (message) => {
            return new Promise((resolve) => {
                const modalOverlay = document.getElementById('customConfirmModal');
                const modalMessage = document.getElementById('customConfirmMessage');
                const okButton = document.getElementById('customConfirmOK');
                const cancelButton = document.getElementById('customConfirmCancel');

                modalMessage.textContent = message;
                modalOverlay.classList.add('active');

                const handleConfirm = () => {
                    modalOverlay.classList.remove('active');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modalOverlay.classList.remove('active');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                okButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', handleCancel);
            });
        };

        const showLoading = (message = "Processing...") => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.querySelector('.loading-message').textContent = message;
            loadingOverlay.classList.add('active');
        };

        const hideLoading = () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('active');
        };

        // --- Site Configuration (Global Links & Assets) Management ---
        const loadSiteConfig = () => {
            const configRef = dbRef(db, 'siteConfig');
            onValue(configRef, (snapshot) => {
                const config = snapshot.val() || {};
                document.querySelectorAll('.site-config-input').forEach(input => {
                    const key = input.dataset.key;
                    if (config.hasOwnProperty(key) && config[key] !== null) {
                        input.value = config[key];
                    }
                });
            }, (error) => {
                msg(`Error loading site config: ${error.message}`, 'danger');
            });
        };

        const setupSiteConfigEvents = () => {
            document.querySelectorAll('.site-config-input').forEach(input => {
                if (!input.dataset.listenerAdded) {
                    input.addEventListener('change', async (e) => {
                        const key = e.target.dataset.key;
                        const value = e.target.value.trim();
                        try {
                            showLoading('Updating site config...');
                            await update(dbRef(db, `siteConfig`), { [key]: value });
                            msg(`${key} updated!`, 'info');
                        } catch (error) {
                            msg(`Error updating ${key}: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    });
                    input.dataset.listenerAdded = 'true';
                }
            });
        };

        // --- GOOGLE DRIVE API INTEGRATION FUNCTIONS WITH GIS ---
        async function initGapiClient() {
            if (gapiClientInitialized) {
                console.log('gapi.client already initialized.');
                return;
            }

            // Load gapi client library if not already loaded by GIS
            // gapi.load('client') only loads client library; auth2 is handled by GIS
            await new Promise(resolve => gapi.load('client', resolve)); 

            // Initialize gapi.client (this initializes the client, not authorizes it)
            await gapi.client.init({
                apiKey: GOOGLE_API_KEY, 
                clientId: GOOGLE_CLIENT_ID, // Use for gapi.client.init setup
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                scope: 'https://www.googleapis.com/auth/drive.readonly'
            });

            // Initialize GIS Token Client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, // Use your client ID here for GIS
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (tokenResponse) => {
                    // This callback fires when requestAccessToken() completes
                    if (tokenResponse.error) {
                        console.error('GIS Token request failed:', tokenResponse.error, tokenResponse.error_description);
                        msg(`GIS Authorization failed: ${tokenResponse.error_description || tokenResponse.error}. Please ensure your OAuth consent screen is configured.`, 'danger');
                        gapiClientInitialized = false; 
                        if (pendingAuthPromiseResolve) {
                            pendingAuthPromiseResolve(false); // Resolve with false on error
                            pendingAuthPromiseResolve = null;
                        }
                    } else {
                        // Set the received access token to gapi.client for subsequent API calls
                        gapi.client.setToken(tokenResponse);
                        console.log('GIS token obtained and gapi.client updated.');
                        gapiClientInitialized = true; 
                        if (pendingAuthPromiseResolve) {
                            pendingAuthPromiseResolve(true); // Resolve with true on success
                            pendingAuthPromiseResolve = null;
                        }
                    }
                },
                error_callback: (error) => { // This callback is for errors during initTokenClient setup itself
                    console.error('GIS initTokenClient error_callback:', error);
                    msg(`GIS Token Client initialization error: ${error.type}. Check your Client ID and consent screen.`, 'danger');
                    gapiClientInitialized = false;
                    if (pendingAuthPromiseResolve) {
                        pendingAuthPromiseResolve(false); // Resolve with false on error
                        pendingAuthPromiseResolve = null;
                    }
                }
            });
            console.log('GIS Token Client initialized.');
        }

        // Function to ensure authorization before API call
        async function ensureGoogleAuthorization() {
            // First, ensure gapi.client and tokenClient are initialized
            if (!gapiClientInitialized || !tokenClient) {
                try {
                    await initGapiClient(); // Initialize them if not already
                } catch (error) {
                    console.error("Initialization failed prior to authorization:", error);
                    throw new Error('Google API Client initialization failed prior to authorization request.');
                }
            }

            // Request a new access token if none is available or it's expired
            if (!gapi.client.getToken() || gapi.client.getToken().expires_at < Date.now()) {
                console.log('Requesting new access token...');
                
                // Create a new Promise that will resolve when tokenClient.callback is called
                const authPromise = new Promise(resolve => {
                    pendingAuthPromiseResolve = resolve; // Store the resolve function globally
                });

                // This call will trigger the GIS consent pop-up if user is not already authorized
                tokenClient.requestAccessToken(); 
                
                // Wait for the authPromise to resolve (meaning tokenClient.callback has fired)
                const success = await authPromise;
                if (!success) {
                    throw new Error('Failed to obtain Google access token. User might have denied consent.');
                }
            }
        }

        // Function to fetch contents of a Google Drive folder
        async function fetchDriveFolderContents(folderId) {
            if (!folderId) return [];
            try {
                // Ensure authorization before fetching content
                await ensureGoogleAuthorization();

                // Double check if token is available after authorization
                if (!gapi.client.getToken() || gapi.client.getToken().expires_at < Date.now()) {
                    throw new Error('Google access token not available after authorization attempt. (Pre-API call check)');
                }

                let allFiles = [];
                // Recursive helper function to traverse folders
                async function fetchFilesRecursive(currentFolderId) {
                    let currentPageToken = null;
                    do {
                        // List files within the current folder
                        const response = await gapi.client.drive.files.list({
                            'q': `'${currentFolderId}' in parents and trashed = false`, // Query for files in the current folder, not trashed
                            'fields': 'nextPageToken, files(id, name, mimeType, webContentLink, webViewLink, exportLinks, parents)', // Request specific fields including parents
                            'pageSize': 100, // Number of files per page
                            'pageToken': currentPageToken // Token for pagination
                        });
                        const files = response.result.files;
                        if (files && files.length > 0) {
                            for (const file of files) {
                                let type = 'file';
                                let url = file.webViewLink; // Default view link

                                // Handle folders recursively
                                if (file.mimeType === 'application/vnd.google-apps.folder') {
                                    type = 'folder';
                                    url = file.webViewLink;
                                    allFiles.push({ // Store folder info
                                        id: file.id,
                                        name: file.name,
                                        type: type,
                                        mimeType: file.mimeType,
                                        url: url,
                                        parents: file.parents || []
                                    });
                                    await fetchFilesRecursive(file.id); // Recurse into sub-folder
                                } else {
                                    // Determine file type and appropriate URL for embedding/downloading
                                    if (file.mimeType.startsWith('video/')) {
                                        type = 'video';
                                        url = `https://drive.google.com/uc?export=preview&id=${file.id}`; // Embeddable format for videos
                                    } else if (file.mimeType === 'application/pdf') {
                                        type = 'pdf';
                                        url = file.exportLinks?.['application/pdf'] || file.webContentLink || file.webViewLink;
                                    } else if (file.mimeType.startsWith('image/')) {
                                        type = 'image';
                                        url = file.webContentLink || file.webViewLink;
                                    } else if (file.mimeType.includes('zip') || file.mimeType.includes('rar') || file.mimeType.includes('tar')) {
                                        type = 'archive';
                                        url = file.webContentLink || file.webViewLink;
                                    } else if (file.mimeType.includes('application/octet-stream') || !file.mimeType) {
                                        type = 'gem'; // Generic type for other files
                                        url = file.webContentLink || file.webViewLink;
                                    }

                                    // Fallback URL if specific content/export links are missing
                                    if (!url) url = file.webViewLink;

                                    allFiles.push({
                                        id: file.id,
                                        name: file.name,
                                        type: type,
                                        mimeType: file.mimeType,
                                        url: url,
                                        parents: file.parents || []
                                    });
                                }
                            }
                        }
                        currentPageToken = response.result.nextPageToken; // Get next page token for pagination
                    } while (currentPageToken); // Continue until no more pages
                }

                await fetchFilesRecursive(folderId); // Start recursive fetch from the initial folderId

                // Filter out duplicate files (can happen with recursive fetches)
                const uniqueFiles = [];
                const seenIds = new Set();
                for (const file of allFiles) {
                    if (!seenIds.has(file.id)) {
                        uniqueFiles.push(file);
                        seenIds.add(file.id);
                    }
                }
                return uniqueFiles;

            } catch (error) {
                console.error("Error fetching Google Drive folder contents:", error);
                const errorDetails = error.details || error.message || 'unknown error';
                msg(`Error fetching Google Drive contents: ${errorDetails}. Check folder ID and sharing permissions.`, 'danger');
                throw error; // Re-throw the error for higher-level error handling
            }
        }


        // --- How to Use App Videos Management ---
        const loadHowToUseVideos = () => {
            const videosRef = dbRef(db, 'siteConfig/howToUseVideos');
            onValue(videosRef, (snapshot) => {
                const videos = snapshot.val() || {};
                const listContainer = document.getElementById('howToUseVideosList');
                listContainer.innerHTML = '';

                if (Object.keys(videos).length === 0) {
                    listContainer.innerHTML = '<p class="text-muted fst-italic">No videos added yet.</p>';
                    return;
                }

                Object.entries(videos).forEach(([videoId, video]) => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'how-to-use-video-item';
                    videoItem.innerHTML = `
                        <div>
                            <strong>Title:</strong> <span contenteditable="true" data-id="${videoId}" data-field="title" class="video-title">${video.title || 'Untitled Video'}</span><br>
                            <strong>URL:</strong> <a href="${video.url}" target="_blank">${video.url || 'No URL'}</a><br>
                            <strong>Description:</strong> <span contenteditable="true" data-id="${videoId}" data-field="description" class="video-description">${video.description || 'No description'}</span>
                        </div>
                        <div class="video-controls">
                            <button class="btn btn-sm btn-info edit-how-to-use-video" data-id="${videoId}">Edit URL</button>
                            <button class="btn btn-sm btn-danger delete-how-to-use-video" data-id="${videoId}">Delete</button>
                        </div>
                    `;
                    listContainer.appendChild(videoItem);

                    videoItem.querySelector('.video-title').addEventListener('blur', (e) => updateHowToUseVideo(videoId, 'title', e.target.textContent));
                    videoItem.querySelector('.video-description').addEventListener('blur', (e) => updateHowToUseVideo(videoId, 'description', e.target.textContent));
                    videoItem.querySelector('.edit-how-to-use-video').addEventListener('click', () => {
                        const newUrl = prompt('Enter new video URL:', video.url);
                        if (newUrl !== null) { 
                             updateHowToUseVideo(videoId, 'url', newUrl.trim());
                        }
                    });
                    videoItem.querySelector('.delete-how-to-use-video').addEventListener('click', () => deleteHowToUseVideo(videoId));
                });
            }, (error) => {
                msg(`Error loading how-to-use videos: ${error.message}`, 'danger');
            });
        };

        const addHowToUseVideo = async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const title = document.getElementById('howToUseVideoTitle').value.trim();
            const url = document.getElementById('howToUseVideoUrl').value.trim();
            const description = document.getElementById('howToUseVideoDescription').value.trim();

            if (!title || !url) {
                msg('Video title and URL are required!', 'warning');
                return;
            }

            showLoading('Adding video...');
            try {
                const newRef = push(dbRef(db, `siteConfig/howToUseVideos`));
                await set(newRef, { title, url, description });
                msg('Video added successfully!', 'success');
                document.getElementById('howToUseVideoTitle').value = '';
                document.getElementById('howToUseVideoUrl').value = '';
                document.getElementById('howToUseVideoDescription').value = '';
            } catch (error) {
                msg(`Error adding video: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        const updateHowToUseVideo = async (videoId, field, value) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            showLoading('Updating video...');
            try {
                await update(dbRef(db, `siteConfig/howToUseVideos/${videoId}`), { [field]: value });
                msg('Video updated!', 'info');
            } catch (error) {
                msg(`Error updating video: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        };

        const deleteHowToUseVideo = async (videoId) => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const confirm = await showConfirm('Are you sure you want to delete this video?');
            if (confirm) {
                showLoading('Deleting video...');
                try {
                    await remove(dbRef(db, `siteConfig/howToUseVideos/${videoId}`));
                    msg('Video deleted!', 'danger');
                } catch (error) {
                    msg(`Error deleting video: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            }
        };
        document.getElementById('addHowToUseVideo').addEventListener('click', addHowToUseVideo);

        // Load and display categories
        const loadCategories = () => {
            const catRef = dbRef(db, 'categories');
            onValue(catRef, snapshot => {
                const data = snapshot.val() || {};
                renderCategories(data);
            }, (error) => {
                msg(`Error loading categories: ${error.message}`, 'danger');
            });
        };

        const renderCategories = (cats) => {
            const container = document.getElementById('categoriesList');
            container.innerHTML = '';
            if (Object.keys(cats).length === 0) {
                container.innerHTML = '<p class="text-muted fst-italic">No categories added yet. Start by creating one above!</p>';
                return;
            }
            Object.entries(cats).forEach(([catId, cat]) => {
                const card = document.createElement('div');
                card.className = "card mb-3";
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 contenteditable="true" data-id="${catId}" class="cat-name flex-grow-1 me-2">${cat.name}</h5>
                            <button class="btn btn-danger btn-sm delete-cat" data-id="${catId}">Delete Category</button>
                        </div>
                        <div class="mb-3">
                            <label for="categoryImageUrl-${catId}" class="form-label">Category Image URL:</label>
                            ${cat.imageUrl ? `<img src="${cat.imageUrl}" alt="Category Image" class="thumbnail-preview">` : '<p class="text-muted">No image selected.</p>'}
                            <input type="url" class="form-control form-control-sm mt-2 category-image-url" id="categoryImageUrl-${catId}" data-id="${catId}" value="${cat.imageUrl || ''}" placeholder="e.g., https://example.com/image.jpg">
                        </div>
                        <hr>
                        <h6 class="mb-2 text-muted">Batches:</h6>
                        <div>
                            <button class="btn btn-secondary btn-sm mb-2 add-batch" data-id="${catId}">+ Add Batch</button>
                            <div class="batches-list" id="batches-list-${catId}"></div>
                        </div>
                    </div>`;
                setupCategoryEvents(card, catId, cat.imageUrl);
                container.append(card);
            });
        };

        const setupCategoryEvents = (card, catId, currentImageUrl) => {
            const nameEl = card.querySelector('.cat-name');
            nameEl.addEventListener('blur', async () => {
                const newName = nameEl.textContent.trim();
                if (newName && newName !== nameEl.dataset.originalName) {
                    try {
                        await update(dbRef(db, `categories/${catId}`), { name: newName });
                        msg('Category name updated', 'info');
                    } catch (error) {
                        msg(`Error updating category name: ${error.message}`, 'danger');
                    }
                }
                nameEl.dataset.originalName = newName;
            });

            const imageUrlInput = card.querySelector('.category-image-url');
            imageUrlInput.addEventListener('change', async (e) => {
                const newImageUrl = e.target.value.trim();
                try {
                    await update(dbRef(db, `categories/${catId}`), { imageUrl: newImageUrl });
                    msg('Category image URL updated successfully!', 'success');
                } catch (error) {
                    msg(`Error updating category image URL: ${error.message}`, 'danger');
                }
            });
            card.querySelector('.delete-cat').addEventListener('click', async (e) => {
                const confirmDelete = await showConfirm('Are you sure you want to delete this category and all its contents (batches, modules, lectures)?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting category and content...');
                        await remove(dbRef(db, `categories/${catId}`));
                        msg('Category and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting category: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            card.querySelector('.add-batch').onclick = async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }

                const batchTypeChoice = await showConfirm('Is this a Google Drive Content batch? (OK for Drive, Cancel for Regular Modules/Lectures)');
                let title = prompt('Enter Batch title:');
                if (!title) { msg('Batch title is required!', 'warning'); return; }
                
                const thumbnailUrl = prompt('Enter Thumbnail URL (e.g., https://via.placeholder.com/150):');
                if (!thumbnailUrl) { msg('Thumbnail URL is required!', 'warning'); return; }

                const description = prompt('Enter Batch description (max 100 words):');
                if (!description) { msg('Batch description is required!', 'warning'); return; }
                if (description.split(/\s+/).length > 100) { msg('Description exceeds 100 words! Please re-enter.', 'warning'); return; }

                let isContentDirectLink = batchTypeChoice;
                let googleDriveFolderId = null;
                let modules = {};
                let driveContent = null;

                if (isContentDirectLink) {
                    googleDriveFolderId = prompt('Enter Google Drive Folder ID:');
                    if (!googleDriveFolderId) {
                        msg('Google Drive Folder ID is required for this batch type! Batch not added.', 'warning');
                        return;
                    }

                    showLoading('Fetching Drive contents...');
                    try {
                        const fetchedDriveItems = await fetchDriveFolderContents(googleDriveFolderId);
                        if (!fetchedDriveItems || fetchedDriveItems.length === 0) {
                            msg('Failed to fetch Drive contents or folder is empty. Batch not added. Check folder ID or permissions.', 'danger');
                            return;
                        }

                        const directFiles = fetchedDriveItems.filter(item =>
                            item.parents.includes(googleDriveFolderId) && item.type !== 'folder'
                        );
                        const subFolders = fetchedDriveItems.filter(item =>
                            item.parents.includes(googleDriveFolderId) && item.type === 'folder'
                        );

                        if (subFolders.length > 0) {
                            for (const folder of subFolders) {
                                const moduleId = push(dbRef(db, 'dummy')).key;
                                const moduleLectures = fetchedDriveItems.filter(item =>
                                    item.parents.includes(folder.id) && item.type !== 'folder'
                                ).map(item => ({
                                    id: item.id,
                                    name: item.name,
                                    url: item.url,
                                    type: item.type,
                                    mimeType: item.mimeType
                                }));
                                modules[moduleId] = {
                                    name: folder.name,
                                    driveId: folder.id,
                                    lectures: moduleLectures.sort((a,b) => (a.name || '').localeCompare(b.name || '')),
                                    type: 'drive-module'
                                };
                            }
                        } else {
                            const moduleId = push(dbRef(db, 'dummy')).key;
                            modules[moduleId] = {
                                name: `${title} Content`,
                                isAutoGenerated: true,
                                lectures: directFiles.map(item => ({
                                    id: item.id,
                                    name: item.name,
                                    url: item.url,
                                    type: item.type,
                                    mimeType: item.mimeType
                                })).sort((a,b) => (a.name || '').localeCompare(b.name || '')),
                                type: 'drive-module-single'
                            };
                        }

                        msg('Drive contents fetched and structured into modules!', 'success');
                    } catch (err) {
                        console.error('Error fetching Drive content on add:', err);
                        msg(`Error fetching Drive content: ${err.message}. Batch not added. Check browser console.`, 'danger');
                        return;
                    } finally {
                        hideLoading();
                    }
                }

                let originalPrice = null;
                let discountedPrice = null;
                let isFree = false;

                if (!isContentDirectLink) {
                    originalPrice = prompt('Enter Original Price (e.g., 999 or leave empty if free):');
                    discountedPrice = prompt('Enter Discounted Price (e.g., 499 or 0 for FREE):');
                    
                    originalPrice = originalPrice ? parseFloat(originalPrice) : null;
                    discountedPrice = discountedPrice ? parseFloat(discountedPrice) : null;
                    isFree = (discountedPrice === 0) || (originalPrice === null && discountedPrice === null);
                } else { 
                    isFree = true;
                    discountedPrice = 0;
                }

                try {
                    showLoading('Adding batch...');
                    const newRef = push(dbRef(db, `categories/${catId}/batches`));
                    await set(newRef, { 
                        title, 
                        thumbnail: thumbnailUrl, 
                        description,
                        originalPrice: originalPrice, 
                        discountedPrice: discountedPrice, 
                        isFree: isFree, 
                        isNew: true,
                        isContentDirectLink: isContentDirectLink, 
                        googleDriveFolderId: isContentDirectLink ? googleDriveFolderId : null, 
                        driveContent: null,
                        modules: modules
                    });
                    msg('Batch added successfully!', 'success');
                } catch (error) {
                    msg(`Error adding batch: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            };

            const batchesListContainer = card.querySelector(`#batches-list-${catId}`);
            onValue(dbRef(db, `categories/${catId}/batches`), snapshot => {
                batchesListContainer.innerHTML = '';
                const batchData = snapshot.val() || {};
                if (Object.keys(batchData).length === 0) {
                    batchesListContainer.innerHTML = '<p class="text-muted fst-italic">No batches in this category.</p>';
                }
                Object.entries(batchData).forEach(([bId, batch]) => {
                    const item = createBatchItem(catId, bId, batch);
                    batchesListContainer.append(item);
                });
            }, 
            (error) => {
                msg(`Error loading batches: ${error.message}`, 'danger');
            });
        };

        const createBatchItem = (catId, bId, batch) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 bg-light';
            
            const displayPrice = (batch.isFree || (batch.originalPrice === null && batch.discountedPrice === null)) ?
                                 '<span class="fw-bold text-success">FREE</span>' :
                                 (batch.discountedPrice !== null ? `${batch.discountedPrice}` : (batch.originalPrice !== null ? `${batch.originalPrice}` : 'Price N/A'));
            const originalPriceStrikethrough = (batch.originalPrice !== null && batch.discountedPrice !== null && batch.discountedPrice < batch.originalPrice) ? `<s class="text-muted ms-2">${batch.originalPrice}</s>` : '';
            const normalContentSectionDisplay = (!batch.isContentDirectLink) ? 'block' : 'none';
            const googleDriveSectionDisplay = (batch.isContentDirectLink) ? 'block' : 'none';

            let dynamicContentHtml = '';
            if (batch.isContentDirectLink) {
                let driveContentPreviewHtml = '<p class="text-muted fst-italic">No Drive contents or modules found for this batch.</p>';

                if (batch.modules && Object.keys(batch.modules).length > 0) {
                    driveContentPreviewHtml = '<ul class="list-unstyled mt-2 drive-content-preview-list">';
                    const sortedModules = Object.entries(batch.modules).sort(([, modA], [, modB]) => (modA.name || '').localeCompare(modB.name || ''));

                    sortedModules.forEach(([moduleId, module], modIndex) => {
                        driveContentPreviewHtml += `
                            <li class="drive-content-list-item">
                                <i class="fas fa-folder text-info"></i>
                                <strong>Module:</strong> <span contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-modid="${moduleId}" data-field="name" class="drive-content-name-editable">${module.name || 'Untitled Module'}</span>
                                <button class="btn btn-sm btn-secondary ms-2 view-module-contents" data-cat="${catId}" data-bid="${bId}" data-modid="${moduleId}">View Contents</button>
                                <button class="btn btn-sm btn-danger ms-2 delete-module" data-cat="${catId}" data-bid="${bId}" data-modid="${moduleId}">Delete Module</button>
                            </li>
                        `;
                        driveContentPreviewHtml += `<ul class="list-unstyled ms-4 mt-2 mb-2 drive-module-lectures-list" id="module-lectures-${moduleId}" style="display: none;">`;
                        if (module.lectures && module.lectures.length > 0) {
                             const sortedLectures = module.lectures.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                            sortedLectures.forEach((lecture, lecIndex) => {
                                let lectureIcon = '';
                                let lectureColor = '';
                                if (lecture.type === 'video') { lectureIcon = 'fas fa-video'; lectureColor = 'text-primary'; }
                                else if (lecture.type === 'pdf') { lectureIcon = 'fas fa-file-pdf'; lectureColor = 'text-danger'; }
                                else if (lecture.type === 'image') { lectureIcon = 'fas fa-image'; lectureColor = 'text-success'; }
                                else if (lecture.type === 'archive') { lectureIcon = 'fas fa-file-archive'; lectureColor = 'text-warning'; }
                                else { lectureIcon = 'fas fa-file'; lectureColor = 'text-secondary'; }

                                driveContentPreviewHtml += `
                                    <li class="drive-content-list-item">
                                        <i class="${lectureIcon} ${lectureColor}"></i>
                                        <span contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-modid="${moduleId}" data-idx="${lecIndex}" data-field="name" class="drive-content-name-editable">${lecture.name || 'Untitled Lecture'}</span>
                                        <input type="url" contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-modid="${moduleId}" data-idx="${lecIndex}" data-field="url" class="form-control form-control-sm ms-2 drive-content-url-editable" value="${lecture.url || ''}" placeholder="URL">
                                        <button class="btn btn-sm btn-danger ms-2 delete-lecture-from-module" data-cat="${catId}" data-bid="${bId}" data-modid="${moduleId}" data-idx="${lecIndex}">Delete</button>
                                    </li>
                                `;
                            });
                        } else {
                            driveContentPreviewHtml += '<li class="text-muted fst-italic">No lectures in this module.</li>';
                        }
                        driveContentPreviewHtml += `</ul>`;
                    });
                    driveContentPreviewHtml += '</ul>';
                }
                else if (batch.driveContent && batch.driveContent.length > 0) {
                    driveContentPreviewHtml = '<ul class="list-unstyled mt-2 drive-content-preview-list">';
                    const driveContentArray = Array.isArray(batch.driveContent)
                                              ? batch.driveContent
                                              : Object.values(batch.driveContent);

                    const sortedContents = driveContentArray.sort((a, b) => {
                        if (a.type === 'folder' && b.type !== 'folder') return -1;
                        if (a.type !== 'folder' && b.type === 'folder') return 1;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    sortedContents.forEach((item, index) => {
                        let itemIcon = '';
                        let itemColor = '';
                        if (item.type === 'folder') { itemIcon = 'fas fa-folder'; itemColor = 'text-info'; }
                        else if (item.type === 'video') { itemIcon = 'fas fa-video'; itemColor = 'text-primary'; }
                        else if (item.type === 'pdf') { itemIcon = 'fas fa-file-pdf'; lectureColor = 'text-danger'; }
                        else if (item.type === 'image') { itemIcon = 'fas fa-image'; lectureColor = 'text-success'; }
                        else if (item.type === 'archive') { itemIcon = 'fas fa-file-archive'; lectureColor = 'text-warning'; }
                        else { itemIcon = 'fas fa-file'; lectureColor = 'text-secondary'; }

                        driveContentPreviewHtml += `
                            <li class="drive-content-list-item">
                                <i class="${itemIcon} ${itemColor}"></i>
                                <span contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-idx="${index}" data-field="name" class="drive-content-name-editable">${item.name || 'Untitled'}</span>
                                <input type="url" contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-idx="${index}" data-field="url" class="form-control form-control-sm ms-2 drive-content-url-editable" value="${item.url || ''}" placeholder="URL">
                                <button class="btn btn-sm btn-danger ms-2 delete-drive-content-item" data-cat="${catId}" data-bid="${bId}" data-idx="${index}">Delete</button>
                            </li>`;
                    });
                    driveContentPreviewHtml += '</ul>';
                }

                dynamicContentHtml = `
                    <div class="mb-3 google-drive-folder-id-container" style="display: ${googleDriveSectionDisplay};">
                        <label for="googleDriveFolderId-${bId}-input" class="form-label">Google Drive Folder ID:</label>
                        <input type="text" class="form-control form-control-sm google-drive-folder-id" id="googleDriveFolderId-${bId}-input" data-cat="${catId}" data-bid="${bId}" value="${batch.googleDriveFolderId || ''}" placeholder="e.g., 1_abcdefg1234567890">
                        <small class="form-text text-muted">Copy the folder ID from your Google Drive URL. Ex: drive.google.com/drive/folders/<span class="fw-bold">FOLDER_ID</span></small>
                        <button class="btn btn-sm btn-info mt-2 refresh-drive-content" data-cat="${catId}" data-bid="${bId}">Refresh Drive Content</button>
                        <div class="mt-2 p-2 border rounded drive-content-preview">
                            <h6>Drive Contents:</h6>
                            ${driveContentPreviewHtml}
                        </div>
                    </div>
                `;
            } else {
                dynamicContentHtml = `
                    <div class="mb-3 normal-content-sections" style="display: ${normalContentSectionDisplay};">
                        <label for="telegramCourseLink-${bId}" class="form-label">Telegram Course Link (Optional):</label>
                        <input type="url" class="form-control form-control-sm mb-2 telegram-course-link" id="telegramCourseLink-${bId}" data-cat="${catId}" data-bid="${bId}" value="${batch.telegramCourseLink || ''}" placeholder="e.g., https://t.me/your_course_channel">
                        <small class="form-text text-muted">If this is not a free batch, the "Let's Roar" button will open this link.</small>
                        <h6 class="mt-3 mb-2 text-muted">Modules:</h6>
                        <div>
                            <button class="btn btn-secondary btn-sm mb-2 add-module" data-cat="${catId}" data-bid="${bId}">+ Add Module</button>
                            <div class="modules-list" id="modules-list-${bId}"></div>
                        </div>
                    </div>
                `;
            }


            div.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 contenteditable="true" data-cat="${catId}" data-id="${bId}" class="batch-title flex-grow-1 me-2">${batch.title}</h6>
                        <span class="badge ${batch.isNew ? 'bg-success' : 'bg-secondary'} me-2 toggle-isnew" style="cursor:pointer;" data-cat="${catId}" data-bid="${bId}">${batch.isNew ? 'NEW' : 'OLD'}</span>
                        <span class="badge ${batch.isFree ? 'bg-info' : 'bg-warning'} me-2 toggle-isfree" style="cursor:pointer;" data-cat="${catId}" data-bid="${bId}">${batch.isFree ? 'FREE' : 'PAID'}</span>
                        <span class="badge ${batch.isContentDirectLink ? 'bg-primary' : 'bg-secondary'} me-2 toggle-iscontentdirectlink" style="cursor:pointer;" data-cat="${catId}" data-bid="${bId}">${batch.isContentDirectLink ? 'DRIVE' : 'NORMAL'}</span>
                        <button class="btn btn-danger btn-sm delete-batch" data-cat="${catId}" data-id="${bId}">Delete Batch</button>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Thumbnail URL:</label>
                        ${batch.thumbnail ? `<img src="${batch.thumbnail}" alt="Batch Thumbnail" class="thumbnail-preview">` : '<p class="text-muted">No thumbnail.}</p>'}
                        <input type="url" class="form-control form-control-sm mt-1 batch-thumbnail-url" data-cat="${catId}" data-bid="${bId}" value="${batch.thumbnail || ''}" placeholder="Thumbnail URL">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Description:</label>
                        <textarea class="form-control form-control-sm batch-description" rows="2" data-cat="${catId}" data-bid="${bId}">${batch.description || ''}</textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Price:</label>
                        <div class="d-flex align-items-center">
                            <input type="number" step="0.01" class="form-control form-control-sm me-2 batch-original-price" data-cat="${catId}" data-bid="${bId}" value="${batch.originalPrice !== null ? batch.originalPrice : ''}" placeholder="Original Price" style="width: 120px; display: ${batch.isFree || batch.isContentDirectLink ? 'none' : 'block'};">
                            <input type="number" step="0.01" class="form-control form-control-sm me-2 batch-discounted-price" data-cat="${catId}" data-bid="${bId}" value="${batch.discountedPrice !== null ? batch.discountedPrice : ''}" placeholder="Discounted Price" style="width: 120px; display: ${batch.isFree || batch.isContentDirectLink ? 'none' : 'block'};">
                            ${displayPrice} ${originalPriceStrikethrough}
                        </div>
                    </div>
                    ${dynamicContentHtml}
                </div>
            `;
            // Add event listeners for new elements
            setupBatchEvents(div, catId, bId, batch);
            return div;
        };

        const setupBatchEvents = (card, catId, bId, currentBatch) => {
            // Batch title editing
            card.querySelector('.batch-title').addEventListener('blur', async (e) => {
                const newTitle = e.target.textContent.trim();
                if (newTitle && newTitle !== currentBatch.title) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { title: newTitle });
                        msg('Batch title updated', 'info');
                    } catch (error) {
                        msg(`Error updating batch title: ${error.message}`, 'danger');
                    }
                }
            });

            // Batch thumbnail URL
            card.querySelector('.batch-thumbnail-url').addEventListener('change', async (e) => {
                const newThumbnail = e.target.value.trim();
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { thumbnail: newThumbnail });
                    msg('Batch thumbnail updated', 'info');
                } catch (error) {
                    msg(`Error updating batch thumbnail: ${error.message}`, 'danger');
                }
            });

            // Batch description
            card.querySelector('.batch-description').addEventListener('blur', async (e) => {
                const newDescription = e.target.value.trim();
                if (newDescription && newDescription !== currentBatch.description) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { description: newDescription });
                        msg('Batch description updated', 'info');
                    } catch (error) {
                        msg(`Error updating batch description: ${error.message}`, 'danger');
                    }
                }
            });

            // Batch original price
            card.querySelector('.batch-original-price').addEventListener('change', async (e) => {
                const newPrice = e.target.value === '' ? null : parseFloat(e.target.value);
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { originalPrice: newPrice });
                    msg('Original price updated', 'info');
                } catch (error) { 
                    msg(`Error updating original price: ${error.message}`, 'danger');
                }
            });

            // Batch discounted price
            card.querySelector('.batch-discounted-price').addEventListener('change', async (e) => {
                const newPrice = e.target.value === '' ? null : parseFloat(e.target.value);
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { discountedPrice: newPrice });
                    msg('Discounted price updated', 'info');
                } catch (error) {
                    msg(`Error updating discounted price: ${error.message}`, 'danger');
                }
            });

            // Toggle isNew status
            card.querySelector('.toggle-isnew').addEventListener('click', async (e) => {
                const newValue = !currentBatch.isNew;
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { isNew: newValue });
                    msg(`Batch status changed to ${newValue ? 'NEW' : 'OLD'}`, 'info');
                } catch (error) {
                    msg(`Error updating isNew status: ${error.message}`, 'danger');
                }
            });

            // Toggle isFree status
            card.querySelector('.toggle-isfree').addEventListener('click', async (e) => {
                const newValue = !currentBatch.isFree;
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}`), { isFree: newValue });
                    msg(`Batch status changed to ${newValue ? 'FREE' : 'PAID'}`, 'info');
                } catch (error) {
                    msg(`Error updating isFree status: ${error.message}`, 'danger');
                }
            });

            // Toggle isContentDirectLink status
            const toggleIsContentDirectLink = card.querySelector('.toggle-iscontentdirectlink');
            if (toggleIsContentDirectLink) {
                toggleIsContentDirectLink.addEventListener('click', async () => {
                    const newValue = !currentBatch.isContentDirectLink;
                    const confirm = await showConfirm(`Are you sure you want to change this batch to ${newValue ? 'Google Drive Content' : 'Normal Modules'}? This will reset modules/driveContent structure.`);
                    if (confirm) {
                        showLoading('Updating batch type...');
                        try {
                            const updates = {
                                isContentDirectLink: newValue,
                                googleDriveFolderId: null,
                                driveContent: null,
                                modules: null,
                                originalPrice: null,
                                discountedPrice: 0,
                                isFree: true
                            };
                            await update(dbRef(db, `categories/${catId}/batches/${bId}`), updates);
                            msg('Batch type updated and content reset. Please re-enter details.', 'info');
                        } catch (error) {
                            msg(`Error updating batch type: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                });
            }

            // Delete Batch
            card.querySelector('.delete-batch').addEventListener('click', async (e) => {
                const confirmDelete = await showConfirm('Are you sure you want to delete this batch and all its modules/lectures?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting batch and content...');
                        await remove(dbRef(db, `categories/${catId}/batches/${bId}`));
                        msg('Batch and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting batch: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            // --- Google Drive Specific Events ---
            const googleDriveFolderIdInput = card.querySelector('.google-drive-folder-id');
            if (googleDriveFolderIdInput) {
                googleDriveFolderIdInput.addEventListener('change', async (e) => {
                    const newFolderId = e.target.value.trim();
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), { googleDriveFolderId: newFolderId });
                        msg('Google Drive Folder ID updated!', 'info');
                    } catch (error) {
                        msg(`Error updating Google Drive Folder ID: ${error.message}`, 'danger');
                    }
                });
            }

            const refreshDriveContentButton = card.querySelector('.refresh-drive-content');
            if (refreshDriveContentButton) {
                refreshDriveContentButton.addEventListener('click', async () => {
                    const folderIdInput = card.querySelector(`.google-drive-folder-id[data-cat="${catId}"][data-bid="${bId}"]`);
                    const folderId = folderIdInput.value.trim();
                    if (!folderId) {
                        msg('Google Drive Folder ID is required to refresh contents!', 'warning');
                        return;
                    }
                    showLoading('Refreshing Drive contents...');
                    try {
                        const fetchedDriveItems = await fetchDriveFolderContents(folderId);
                        if (!fetchedDriveItems || fetchedDriveItems.length === 0) {
                            msg('Failed to fetch Drive contents or folder is empty. Check folder ID or permissions.', 'danger');
                            await update(dbRef(db, `categories/${catId}/batches/${bId}`), { modules: null, driveContent: null });
                            return;
                        }

                        let newModules = {};
                        const directFiles = fetchedDriveItems.filter(item =>
                            item.parents.includes(folderId) && item.type !== 'folder'
                        );
                        const subFolders = fetchedDriveItems.filter(item =>
                            item.parents.includes(folderId) && item.type === 'folder'
                        );

                        if (subFolders.length > 0) {
                            for (const folder of subFolders) {
                                const moduleId = push(dbRef(db, 'dummy')).key;
                                const moduleLectures = fetchedDriveItems.filter(item =>
                                    item.parents.includes(folder.id) && item.type !== 'folder'
                                ).map(item => ({
                                    id: item.id,
                                    name: item.name,
                                    url: item.url,
                                    type: item.type,
                                    mimeType: item.mimeType
                                }));
                                newModules[moduleId] = {
                                    name: folder.name,
                                    driveId: folder.id,
                                    lectures: moduleLectures.sort((a,b) => (a.name || '').localeCompare(b.name || '')),
                                    type: 'drive-module'
                                };
                            }
                        } else {
                            const moduleId = push(dbRef(db, 'dummy')).key;
                            newModules[moduleId] = {
                                name: `${currentBatch.title} Content`,
                                isAutoGenerated: true,
                                lectures: directFiles.map(item => ({
                                    id: item.id,
                                    name: item.name,
                                    url: item.url,
                                    type: item.type,
                                    mimeType: item.mimeType
                                })).sort((a,b) => (a.name || '').localeCompare(b.name || '')),
                                type: 'drive-module-single'
                            };
                        }

                        await update(dbRef(db, `categories/${catId}/batches/${bId}`), {
                            googleDriveFolderId: folderId,
                            modules: newModules,
                            driveContent: null
                        });
                        msg('Drive contents refreshed and modules updated!', 'success');
                    } catch (error) {
                        msg(`Error refreshing Drive content: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                });
            }

            // Handle "View Contents" button clicks for modules
            card.querySelectorAll('.view-module-contents').forEach(button => {
                button.addEventListener('click', (e) => {
                    const moduleId = e.target.dataset.modid;
                    const lecturesList = card.querySelector(`#module-lectures-${moduleId}`);
                    if (lecturesList) {
                        lecturesList.style.display = lecturesList.style.display === 'none' ? 'block' : 'none';
                        e.target.textContent = lecturesList.style.display === 'none' ? 'View Contents' : 'Hide Contents';
                    }
                });
            });

            // Update module name (if contenteditable)
            card.querySelectorAll('.drive-content-name-editable[data-modid]').forEach(el => {
                el.addEventListener('blur', async (e) => {
                    const newName = e.target.textContent.trim();
                    const moduleId = e.target.dataset.modid;

                    if (newName && newName !== e.target.dataset.originalValue) {
                        showLoading('Updating module name...');
                        try {
                            await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${moduleId}`), { name: newName });
                            msg('Module name updated!', 'info');
                        } catch (error) {
                            msg(`Error updating module name: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                    e.target.dataset.originalValue = newName;
                });
                el.addEventListener('focus', (e) => {
                    e.target.dataset.originalValue = e.target.textContent.trim();
                });
            });

            // Update lecture name/URL within modules
            card.querySelectorAll('.drive-content-name-editable[data-idx][data-modid], .drive-content-url-editable[data-idx][data-modid]').forEach(el => {
                el.addEventListener('blur', async (e) => {
                    const newValue = e.target.tagName === 'INPUT' ? e.target.value.trim() : e.target.textContent.trim();
                    const lectureIndex = parseInt(e.target.dataset.idx);
                    const moduleId = e.target.dataset.modid;
                    const field = e.target.dataset.field;

                    if (newValue && newValue !== e.target.dataset.originalValue) {
                        showLoading('Updating lecture details...');
                        try {
                            const lecturesRef = dbRef(db, `categories/${catId}/batches/${bId}/modules/${moduleId}/lectures`);
                            const snapshot = await new Promise(resolve => onValue(lecturesRef, resolve, { onlyOnce: true }));
                            const currentLectures = snapshot.val() || [];
                            if (currentLectures[lectureIndex]) {
                                currentLectures[lectureIndex][field] = newValue;
                                await set(lecturesRef, currentLectures);
                                msg('Lecture updated!', 'info');
                            }
                        } catch (error) {
                            msg(`Error updating lecture: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                    e.target.dataset.originalValue = newValue;
                });
                el.addEventListener('focus', (e) => {
                    e.target.dataset.originalValue = e.target.tagName === 'INPUT' ? e.target.value.trim() : e.target.textContent.trim();
                });
            });

            // Delete module (for Drive batches)
            card.querySelectorAll('.delete-module').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const moduleId = e.target.dataset.modid;
                    const confirm = await showConfirm('Are you sure you want to delete this module and all its lectures?');
                    if (confirm) {
                        showLoading('Deleting module...');
                        try {
                            await remove(dbRef(db, `categories/${catId}/batches/${bId}/modules/${moduleId}`));
                            msg('Module deleted!', 'danger');
                        } catch (error) {
                            msg(`Error deleting module: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                });
            });

            // Delete lecture from module (for Drive batches)
            card.querySelectorAll('.delete-lecture-from-module').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const lectureIndex = parseInt(e.target.dataset.idx);
                    const moduleId = e.target.dataset.modid;
                    const confirm = await showConfirm('Are you sure you want to delete this lecture?');
                    if (confirm) {
                        showLoading('Deleting lecture...');
                        try {
                            const lecturesRef = dbRef(db, `categories/${catId}/batches/${bId}/modules/${moduleId}/lectures`);
                            const snapshot = await new Promise(resolve => onValue(lecturesRef, resolve, { onlyOnce: true }));
                            const currentLectures = snapshot.val() || [];
                            if (currentLectures[lectureIndex]) {
                                currentLectures.splice(lectureIndex, 1);
                                await set(lecturesRef, currentLectures);
                                msg('Lecture deleted!', 'danger');
                            }
                        } catch (error) {
                            msg(`Error deleting lecture: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                });
            });

            // --- Normal Batch Modules and Lectures (old structure) ---
            const modulesListContainer = card.querySelector(`#modules-list-${bId}`);
            if (modulesListContainer) {
                // Load modules for this batch (if it's a normal batch)
                onValue(dbRef(db, `categories/${catId}/batches/${bId}/modules`), snapshot => {
                    modulesListContainer.innerHTML = '';
                    const moduleData = snapshot.val() || {};
                    if (Object.keys(moduleData).length === 0) {
                        modulesListContainer.innerHTML = '<p class="text-muted fst-italic">No modules in this batch.</p>';
                    }
                    Object.entries(moduleData).forEach(([mId, module]) => {
                        const moduleItem = createModuleItem(catId, bId, mId, module);
                        modulesListContainer.append(moduleItem);
                    });
                });

                card.querySelector('.add-module').addEventListener('click', async () => {
                    if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                    const moduleName = prompt('Enter Module Name:');
                    if (moduleName) {
                        try {
                            showLoading('Adding module...');
                            const newRef = push(dbRef(db, `categories/${catId}/batches/${bId}/modules`));
                            await set(newRef, { name: moduleName });
                            msg('Module added!', 'success');
                        } catch (error) {
                            msg(`Error adding module: ${error.message}`, 'danger');
                        } finally {
                            hideLoading();
                        }
                    }
                });
            }
        };

        const createModuleItem = (catId, bId, mId, module) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 bg-secondary text-white'; // Slightly different style for modules
            div.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-id="${mId}" class="module-name flex-grow-1 me-2">${module.name}</h6>
                        <button class="btn btn-danger btn-sm delete-module" data-cat="${catId}" data-bid="${bId}" data-id="${mId}">Delete Module</button>
                    </div>
                    <hr class="border-white-50">
                    <h6 class="mb-2">Lectures:</h6>
                    <div>
                        <button class="btn btn-info btn-sm mb-2 add-lecture" data-cat="${catId}" data-bid="${bId}" data-id="${mId}">+ Add Lecture</button>
                        <div class="lectures-list" id="lectures-list-${mId}"></div>
                    </div>
                </div>
            `;
            setupModuleEvents(div, catId, bId, mId, module);
            return div;
        };

        const setupModuleEvents = (card, catId, bId, mId, currentModule) => {
            // Module name editing
            card.querySelector('.module-name').addEventListener('blur', async (e) => {
                const newName = e.target.textContent.trim();
                if (newName && newName !== currentModule.name) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}`), { name: newName });
                        msg('Module name updated', 'info');
                    } catch (error) {
                        msg(`Error updating module name: ${error.message}`, 'danger');
                    }
                }
            });

            // Delete Module (for normal batches)
            card.querySelector('.delete-module').addEventListener('click', async (e) => {
                const confirmDelete = await showConfirm('Are you sure you want to delete this module and all its lectures?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting module and content...');
                        await remove(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}`));
                        msg('Module and its contents deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting module: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });

            // Add Lecture
            card.querySelector('.add-lecture').addEventListener('click', async () => {
                if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
                const lectureTitle = prompt('Enter Lecture Title:');
                if (!lectureTitle) { msg('Lecture title is required!', 'warning'); return; }

                const lectureUrl = prompt('Enter Video/Content URL (e.g., YouTube embed URL, GDrive shareable link):');
                if (!lectureUrl) { msg('Lecture URL is required!', 'warning'); return; }

                try {
                    showLoading('Adding lecture...');
                    const newRef = push(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}/lectures`));
                    await set(newRef, { title: lectureTitle, url: lectureUrl });
                    msg('Lecture added!', 'success');
                } catch (error) {
                    msg(`Error adding lecture: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            });

            // Load and display lectures for this module
            const lecturesListContainer = card.querySelector(`#lectures-list-${mId}`);
            onValue(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}/lectures`), snapshot => {
                lecturesListContainer.innerHTML = '';
                const lectureData = snapshot.val() || {};
                if (Object.keys(lectureData).length === 0) {
                    lecturesListContainer.innerHTML = '<p class="text-muted fst-italic">No lectures in this module.</p>';
                }
                Object.entries(lectureData).forEach(([lId, lecture]) => {
                    const lectureItem = createLectureItem(catId, bId, mId, lId, lecture);
                    lecturesListContainer.append(lectureItem);
                });
            });
        };

        const createLectureItem = (catId, bId, mId, lId, lecture) => {
            const div = document.createElement('div');
            div.className = 'd-flex justify-content-between align-items-center mb-1 py-1 px-2 border rounded bg-white text-dark'; // Style for lecture item
            div.innerHTML = `
                <span contenteditable="true" data-cat="${catId}" data-bid="${bId}" data-modid="${mId}" data-id="${lId}" class="lecture-title flex-grow-1 me-2">${lecture.title}</span>
                <input type="url" class="form-control form-control-sm me-2 lecture-url" data-cat="${catId}" data-bid="${bId}" data-modid="${mId}" data-id="${lId}" value="${lecture.url || ''}" placeholder="Lecture URL">
                <button class="btn btn-danger btn-sm delete-lecture" data-cat="${catId}" data-bid="${bId}" data-modid="${mId}" data-id="${lId}">Delete</button>
            `;
            setupLectureEvents(div, catId, bId, mId, lId, lecture);
            return div;
        };

        const setupLectureEvents = (card, catId, bId, mId, lId, currentLecture) => {
            // Lecture title editing
            card.querySelector('.lecture-title').addEventListener('blur', async (e) => {
                const newTitle = e.target.textContent.trim();
                if (newTitle && newTitle !== currentLecture.title) {
                    try {
                        await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}/lectures/${lId}`), { title: newTitle });
                        msg('Lecture title updated', 'info');
                    } catch (error) {
                        msg(`Error updating lecture title: ${error.message}`, 'danger');
                    }
                }
            });

            // Lecture URL editing
            card.querySelector('.lecture-url').addEventListener('change', async (e) => {
                const newUrl = e.target.value.trim();
                try {
                    await update(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}/lectures/${lId}`), { url: newUrl });
                    msg('Lecture URL updated', 'info');
                } catch (error) {
                    msg(`Error updating lecture URL: ${error.message}`, 'danger');
                }
            });

            // Delete Lecture
            card.querySelector('.delete-lecture').addEventListener('click', async (e) => {
                const confirmDelete = await showConfirm('Are you sure you want to delete this lecture?');
                if (confirmDelete) {
                    try {
                        showLoading('Deleting lecture...');
                        await remove(dbRef(db, `categories/${catId}/batches/${bId}/modules/${mId}/lectures/${lId}`));
                        msg('Lecture deleted!', 'danger');
                    } catch (error) {
                        msg(`Error deleting lecture: ${error.message}`, 'danger');
                    } finally {
                        hideLoading();
                    }
                }
            });
        };


        // Initial calls
        document.addEventListener('DOMContentLoaded', async () => {
            await authenticateFirebase();
            // Initialize GIS and gapi client for Google Drive API calls
            try {
                await initGapiClient(); 
            } catch (error) {
                console.error("Initial GIS/gapi.client setup failed:", error);
                // Error message is already shown by msg() in initGapiClient
            }

            loadSiteConfig();
            setupSiteConfigEvents();
            loadHowToUseVideos();
            loadCategories();
        });

        // Add Category button event listener
        document.getElementById('addCategory').addEventListener('click', async () => {
            if (!isAuthenticated) { msg('Please authenticate first!', 'danger'); return; }
            const categoryName = document.getElementById('categoryName').value.trim();
            const categoryImageUrl = document.getElementById('categoryImageUrl').value.trim();
            if (categoryName) {
                try {
                    showLoading('Adding category...');
                    const newRef = push(dbRef(db, 'categories'));
                    await set(newRef, { name: categoryName, imageUrl: categoryImageUrl || null });
                    msg('Category added!', 'success');
                    document.getElementById('categoryName').value = '';
                    document.getElementById('categoryImageUrl').value = '';
                } catch (error) {
                    msg(`Error adding category: ${error.message}`, 'danger');
                } finally {
                    hideLoading();
                }
            } else {
                msg('Category name cannot be empty!', 'warning');
            }
        });
    </script>
</body>
</html>
