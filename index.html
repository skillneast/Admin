<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkillNeast Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 10px; background-color: #f8f9fa; } /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    .container { max-width: 900px; margin-top: 20px; }
    .card { border: 1px solid #dee2e6; margin-bottom: 20px; }
    .card-body { padding: 1.25rem; }
    .form-control { border-radius: .25rem; }
    .btn { border-radius: .25rem; }
    .alert { margin-top: 15px; } /* ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§ï‡•á ‡§ä‡§™‡§∞ ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§ó‡§π */

    /* Nested items ‡§ï‡•ã ‡§¨‡•á‡§π‡§§‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡§ø‡§Ç‡§ó */
    .modules-list, .lectures-list {
      border-left: 2px solid #e9ecef; /* ‡§π‡§≤‡•ç‡§ï‡•á ‡§∞‡§Ç‡§ó ‡§ï‡§æ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
      padding-left: 15px;
      margin-top: 10px;
      padding-top: 5px;
    }
    .batch-title, .module-name, .lecture-name {
        min-width: 150px; /* ‡§á‡§®‡§™‡•Å‡§ü ‡§´‡§º‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§ï‡•ã ‡§µ‡§ø‡§ú‡§º‡§ø‡§¨‡§≤ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
        flex-grow: 1; /* ‡§§‡§æ‡§ï‡§ø ‡§µ‡•á ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ú‡§ó‡§π ‡§≤‡•á ‡§∏‡§ï‡•á‡§Ç */
    }
    .d-flex button { /* ‡§¨‡§ü‡§®‡•ã‡§Ç ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§ó‡§π */
      margin-left: 5px;
      white-space: nowrap; /* ‡§§‡§æ‡§ï‡§ø ‡§¨‡§ü‡§® ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§∞‡§π‡•á‡§Ç */
    }
    .d-flex button:first-child {
        margin-left: 0;
    }
    .cat-name, .batch-title, .module-name, .lecture-name {
        font-weight: 600;
    }
    .cat-name:focus, .batch-title:focus, .module-name:focus, .lecture-name:focus {
        outline: 1px solid #007bff; /* ‡§´‡•ã‡§ï‡§∏ ‡§™‡§∞ ‡§¨‡•ç‡§≤‡•Ç ‡§Ü‡§â‡§ü‡§≤‡§æ‡§á‡§® */
        background-color: #e2f2ff; /* ‡§´‡•ã‡§ï‡§∏ ‡§™‡§∞ ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    }
    img.rounded {
        object-fit: cover; /* ‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§∏‡•á ‡§´‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
    }
    .text-muted {
        font-style: italic;
        font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4 text-primary">SkillNeast Course Admin Panel</h2>
    <div id="alerts"></div>

    <div class="card mb-4 p-3 shadow-sm">
      <h5 class="card-title text-success">‡§®‡§à Category ‡§¨‡§®‡§æ‡§è‡§Å</h5>
      <div class="mb-3">
        <label for="categoryName" class="form-label">Category ‡§ï‡§æ ‡§®‡§æ‡§Æ:</label>
        <input id="categoryName" type="text" class="form-control" placeholder="Category ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§ú‡•à‡§∏‡•á: Editing, Programming)">
      </div>
      <button id="addCategory" class="btn btn-success mt-2 w-100">Category ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    </div>

    <div class="card mb-4 p-3 shadow-sm">
        <h5 class="card-title text-primary">‡§®‡§Ø‡§æ Batch ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h5>
        <div class="mb-3">
            <label for="newBatchCategory" class="form-label">Category ‡§ö‡•Å‡§®‡•á‡§Ç:</label>
            <select id="newBatchCategory" class="form-select" disabled>
                <option value="">-- ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à --</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="newBatchTitle" class="form-label">Batch ‡§ï‡§æ Title:</label>
            <input id="newBatchTitle" type="text" class="form-control" placeholder="Batch ‡§ï‡§æ Title (‡§ú‡•à‡§∏‡•á: Advanced Editing Batch)">
        </div>
        <div class="mb-3">
            <label for="newBatchThumbnail" class="form-label">Thumbnail URL:</label>
            <input id="newBatchThumbnail" type="text" class="form-control" placeholder="Thumbnail URL (‡§ú‡•à‡§∏‡•á: https://example.com/image.png)">
        </div>
        <button id="addGlobalBatch" class="btn btn-primary mt-2 w-100">‡§®‡§Ø‡§æ Batch ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    </div>

    <h4 class="mb-3 text-info">‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ Categories ‡§Æ‡•à‡§®‡•á‡§ú ‡§ï‡§∞‡•á‡§Ç</h4>
    <div id="categoriesList"></div>
  </div>

  <script type="module">
    // 'firebase-config.js' ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡•á 'db' ‡§ï‡•ã ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
    // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø firebase-config.js ‡§â‡§∏‡•Ä ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§π‡•à ‡§ú‡§π‡§æ‡§Å ‡§Ø‡§π HTML ‡§´‡§º‡§æ‡§á‡§≤ ‡§π‡•à
    import { db } from './firebase-config.js';
    import { ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§Æ‡•à‡§∏‡•á‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
    const msg = (text, type = 'success') => {
      const el = document.createElement('div');
      el.className = `alert alert-${type} alert-dismissible fade show`;
      el.setAttribute('role', 'alert');
      el.innerHTML = `
        ${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.getElementById('alerts').append(el);
      setTimeout(() => el.remove(), 4000); // 4 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
    };

    // Categories ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§î‡§∞ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§ï‡§∞‡•á‡§Ç
    const loadCategories = () => {
      const catRef = ref(db, 'categories');
      onValue(catRef, snapshot => {
        const data = snapshot.val() || {};
        renderCategories(data); // ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
        populateCategoryDropdown(data); // ‡§®‡§Ø‡§æ ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§â‡§® ‡§™‡•â‡§™‡•Å‡§≤‡•á‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
      });
    };

    const renderCategories = (cats) => {
      const container = document.getElementById('categoriesList');
      container.innerHTML = '';
      if (Object.keys(cats).length === 0) {
          container.innerHTML = '<p class="text-muted text-center mt-3">‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à category ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à ‡§π‡•à.</p>';
          return;
      }
      Object.entries(cats).forEach(([catId, cat]) => {
        const card = document.createElement('div');
        card.className = "card mb-3 shadow-sm";
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 contenteditable="true" data-id="${catId}" class="cat-name flex-grow-1 me-2">${cat.name || 'Untitled Category'}</h5>
              <button class="btn btn-outline-danger btn-sm delete-cat" data-id="${catId}">Category ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å</button>
            </div>
            <hr>
            <div>
              <button class="btn btn-secondary btn-sm mb-2 add-batch-in-category w-100" data-id="${catId}">‡§á‡§∏ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§Æ‡•á‡§Ç Batch ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
              <div class="batches-list"></div>
            </div>
          </div>`;
        setupCategoryEvents(card);
        container.append(card);
      });
    };

    const setupCategoryEvents = (card) => {
      const nameEl = card.querySelector('.cat-name');
      const catId = nameEl.dataset.id;

      // ‡§ú‡§¨ ‡§®‡§æ‡§Æ ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á ‡§´‡§º‡•ã‡§ï‡§∏ ‡§π‡§ü‡•á, ‡§§‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
      nameEl.addEventListener('blur', () => {
        if (nameEl.textContent.trim() !== (nameEl.dataset.originalName || '')) {
            update(ref(db, `categories/${catId}`), { name: nameEl.textContent.trim() })
                .then(() => msg('Category ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ'))
                .catch(error => msg(`Category ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        }
      });
      // ‡§´‡§º‡•ã‡§ï‡§∏ ‡§Ü‡§®‡•á ‡§™‡§∞ ‡§ì‡§∞‡§ø‡§ú‡§ø‡§®‡§≤ ‡§®‡§æ‡§Æ ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡•á‡§Ç
      nameEl.addEventListener('focus', () => {
          nameEl.dataset.originalName = nameEl.textContent.trim();
      });

      // Category ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å
      card.querySelector('.delete-cat').addEventListener('click', () => {
        if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à "${nameEl.textContent}" Category ‡§î‡§∞ ‡§â‡§∏‡§ï‡•á ‡§∏‡§≠‡•Ä contents ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π undo ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ.`)) {
          remove(ref(db, `categories/${catId}`))
            .then(() => msg('Category ‡§î‡§∞ ‡§â‡§∏‡§ï‡•á contents ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è!'))
            .catch(error => msg(`Category ‡§Æ‡§ø‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        }
      });

      // Batches ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§Æ‡•à‡§®‡•á‡§ú ‡§ï‡§∞‡•á‡§Ç
      const batchesList = card.querySelector('.batches-list');
      onValue(ref(db, `categories/${catId}/batches`), snapshot => {
        batchesList.innerHTML = '';
        const batchData = snapshot.val() || {};
        if (Object.keys(batchData).length === 0) {
            batchesList.innerHTML = '<p class="text-muted text-center mt-2 mb-0">‡§á‡§∏ category ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à batch ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à.</p>';
        }
        Object.entries(batchData).forEach(([bId, batch]) => {
          const item = createBatchItem(catId, bId, batch);
          batchesList.append(item);
        });
      });

      // ‡§á‡§∏ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§Æ‡•á‡§Ç Batch ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡§æ ‡§¨‡§ü‡§® ‡§á‡§µ‡•á‡§Ç‡§ü
      card.querySelector('.add-batch-in-category').onclick = () => {
        const title = prompt('Batch ‡§ï‡§æ Title ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:');
        const thumb = prompt('Thumbnail URL ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (‡§â‡§¶‡§æ‡§π‡§∞‡§£: https://example.com/image.png):');
        if (title && thumb) {
          const newRef = push(ref(db, `categories/${catId}/batches`));
          set(newRef, { title, thumbnail: thumb })
            .then(() => msg('Batch ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!'))
            .catch(error => msg(`Batch ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        } else {
            msg('Batch ‡§ï‡§æ Title ‡§î‡§∞ Thumbnail ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡§Ç!', 'warning');
        }
      };
    };

    // Batch ‡§Ü‡§á‡§ü‡§Æ ‡§¨‡§®‡§æ‡§è‡§Å
    const createBatchItem = (catId, bId, batch) => {
      const div = document.createElement('div');
      div.className = 'card card-body bg-light mb-2 p-2'; // ‡§®‡•á‡§∏‡•ç‡§ü‡•á‡§° ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ú‡•à‡§∏‡§æ ‡§¶‡§ø‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <img src="${batch.thumbnail || 'https://via.placeholder.com/60x40?text=No+Img'}" width="60" height="40" class="me-2 rounded" onerror="this.onerror=null;this.src='https://via.placeholder.com/60x40?text=Error';" />
          <input class="form-control form-control-sm me-2 batch-title" data-cat="${catId}" data-bid="${bId}" value="${batch.title || 'Untitled Batch'}">
          <button class="btn btn-sm btn-danger delete-batch me-2" data-cat="${catId}" data-bid="${bId}">Batch ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å</button>
          <button class="btn btn-sm btn-primary add-module" data-cat="${catId}" data-bid="${bId}">+ Module</button>
        </div>
        <div class="modules-list mt-2"></div>`;
      setupBatchEvents(div);
      return div;
    };

    // Batch ‡§á‡§µ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§∏‡•á‡§ü ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç
    const setupBatchEvents = (div) => {
      const titleInput = div.querySelector('.batch-title');
      const { cat, bid } = titleInput.dataset;

      titleInput.addEventListener('change', e => {
        update(ref(db, `categories/${cat}/batches/${bid}`), { title: e.target.value })
          .then(() => msg('Batch ‡§ï‡§æ Title ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ'))
          .catch(error => msg(`Batch Title ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
      });

      div.querySelector('.delete-batch').onclick = () => {
        if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à "${titleInput.value}" Batch ‡§î‡§∞ ‡§â‡§∏‡§ï‡•á ‡§∏‡§≠‡•Ä modules/lectures ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
          remove(ref(db, `categories/${cat}/batches/${bid}`))
            .then(() => msg('Batch ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!'))
            .catch(error => msg(`Batch ‡§Æ‡§ø‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        }
      };

      // Module ‡§∏‡•á‡§ï‡•ç‡§∂‡§®
      const modulesList = div.querySelector('.modules-list');
      div.querySelector('.add-module').onclick = () => {
        const moduleName = prompt('Module ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:');
        if (moduleName) {
          const newMod = push(ref(db, `categories/${cat}/batches/${bid}/modules`));
          set(newMod, { name: moduleName })
            .then(() => msg('Module ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!'))
            .catch(error => msg(`Module ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        } else {
            msg('Module ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!', 'warning');
        }
      };

      onValue(ref(db, `categories/${cat}/batches/${bid}/modules`), snap => {
        modulesList.innerHTML = '';
        const mods = snap.val() || {};
        if (Object.keys(mods).length === 0) {
            modulesList.innerHTML = '<p class="text-muted text-center mt-2 mb-0">‡§á‡§∏ Batch ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à module ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à.</p>';
        }
        Object.entries(mods).forEach(([mId, mod]) => {
          const modEl = createModuleItem(cat, bid, mId, mod);
          modulesList.append(modEl);
        });
      });
    };

    // Module ‡§Ü‡§á‡§ü‡§Æ ‡§¨‡§®‡§æ‡§è‡§Å
    const createModuleItem = (cat, bid, mid, mod) => {
      const d = document.createElement('div');
      d.className = 'card card-body bg-white mb-2 ps-4 p-2 shadow-sm-sm'; /* ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡§ø‡§Ç‡§ó ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à */
      d.innerHTML = `
        <div class="d-flex align-items-center mb-2">
          <input class="form-control form-control-sm module-name flex-grow-1 me-2" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" value="${mod.name || 'Untitled Module'}">
          <button class="btn btn-sm btn-danger delete-module me-2" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}">Module ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å</button>
          <button class="btn btn-sm btn-info add-lecture" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}">+ Lecture</button>
        </div>
        <div class="lectures-list mt-1"></div>`;
      setupModuleEvents(d);
      return d;
    };

    // Module ‡§á‡§µ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§∏‡•á‡§ü ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç
    const setupModuleEvents = (d) => {
      const inp = d.querySelector('.module-name');
      const { cat, bid, mid } = inp.dataset;

      inp.addEventListener('change', () => {
        update(ref(db, `categories/${cat}/batches/${bid}/modules/${mid}`), { name: inp.value })
          .then(() => msg('Module ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ'))
          .catch(error => msg(`Module ‡§®‡§æ‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
      });

      d.querySelector('.delete-module').onclick = () => {
        if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à "${inp.value}" Module ‡§î‡§∞ ‡§â‡§∏‡§ï‡•á ‡§∏‡§≠‡•Ä lectures ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
          remove(ref(db, `categories/${cat}/batches/${bid}/modules/${mid}`))
            .then(() => msg('Module ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!'))
            .catch(error => msg(`Module ‡§Æ‡§ø‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        }
      };

      // Lectures ‡§≤‡§ø‡§∏‡•ç‡§ü
      const lecturesList = d.querySelector('.lectures-list');
      d.querySelector('.add-lecture').onclick = () => {
        const lname = prompt('Lecture ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:');
        const link = prompt('Google Drive / YouTube ‡§≤‡§ø‡§Ç‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (‡§â‡§¶‡§æ‡§π‡§∞‡§£: https://drive.google.com/file/d/ID/preview ‡§Ø‡§æ https://www.youtube.com/watch?v=ID):');
        if (lname && link) {
          const newL = push(ref(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures`));
          set(newL, { name: lname, link })
            .then(() => msg('Lecture ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!'))
            .catch(error => msg(`Lecture ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
        } else {
            msg('Lecture ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡§Ç!', 'warning');
        }
      };

      onValue(ref(db, `categories/${cat}/batches/${bid}/modules/${mid}/lectures`), snap => {
        lecturesList.innerHTML = '';
        const lcs = snap.val() || {};
        if (Object.keys(lcs).length === 0) {
            lecturesList.innerHTML = '<p class="text-muted text-center mt-2 mb-0">‡§á‡§∏ Module ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à lecture ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à.</p>';
        }
        Object.entries(lcs).forEach(([lId, lec]) => {
          const item = document.createElement('div');
          item.className = 'd-flex align-items-center mb-1 bg-light p-2 rounded shadow-sm-sm'; /* ‡§≤‡•á‡§ï‡•ç‡§ö‡§∞ ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡§ø‡§Ç‡§ó ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à */
          item.innerHTML = `
            <input class="form-control form-control-sm me-2 lecture-name" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" data-lid="${lId}" value="${lec.name || 'Untitled Lecture'}">
            <a href="${lec.link}" target="_blank" class="btn btn-sm btn-secondary me-2" title="‡§≤‡§ø‡§Ç‡§ï ‡§ñ‡•ã‡§≤‡•á‡§Ç">üîó</a>
            <button class="btn btn-sm btn-danger delete-lecture" data-cat="${cat}" data-bid="${bid}" data-mid="${mid}" data-lid="${lId}">‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å</button>
          `;

          // ‡§≤‡•á‡§ï‡•ç‡§ö‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡§®‡•á ‡§™‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
          item.querySelector('.lecture-name').addEventListener('change', e => {
              const ds = e.target.dataset;
              update(ref(db, `categories/${ds.cat}/batches/${ds.bid}/modules/${ds.mid}/lectures/${ds.lid}`), { name: e.target.value })
                  .then(() => msg('Lecture ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ'))
                  .catch(error => msg(`Lecture ‡§®‡§æ‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
          });

          item.querySelector('.delete-lecture').onclick = e => {
            const ds = e.target.dataset;
            if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à "${item.querySelector('.lecture-name').value}" Lecture ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
              remove(ref(db, `categories/${ds.cat}/batches/${ds.bid}/modules/${ds.mid}/lectures/${ds.lid}`))
                .then(() => msg('Lecture ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!'))
                .catch(error => msg(`Lecture ‡§Æ‡§ø‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
            }
          };
          lecturesList.append(item);
        });
      });
    };

    // Category ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§¨‡§ü‡§® ‡§ï‡§æ ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞
    document.getElementById('addCategory').onclick = () => {
      const name = document.getElementById('categoryName').value.trim();
      if (!name) {
        return msg('Category ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ!', 'warning');
      }
      const newRef = push(ref(db, 'categories'));
      set(newRef, { name })
        .then(() => {
          msg('Category ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º ‡§¶‡•Ä ‡§ó‡§à!');
          document.getElementById('categoryName').value = ''; // ‡§á‡§®‡§™‡•Å‡§ü ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
        })
        .catch(error => msg(`Category ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
    };

    // ‡§®‡§Ø‡§æ ‡§¨‡•à‡§ö ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§¨‡§ü‡§® ‡§ï‡§æ ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞
    const populateCategoryDropdown = (categoriesData) => {
        const dropdown = document.getElementById('newBatchCategory');
        dropdown.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§ë‡§™‡•ç‡§∂‡§Ç‡§∏ ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç

        if (Object.keys(categoriesData).length === 0) {
            dropdown.innerHTML = '<option value="">‡§ï‡•ã‡§à ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</option>';
            dropdown.disabled = true;
            return;
        }
        dropdown.disabled = false;

        // ‡§è‡§ï ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§ë‡§™‡•ç‡§∂‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "-- ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --";
        defaultOption.selected = true;
        defaultOption.disabled = true;
        dropdown.appendChild(defaultOption);

        Object.entries(categoriesData).forEach(([catId, cat]) => {
            const option = document.createElement('option');
            option.value = catId;
            option.textContent = cat.name;
            dropdown.appendChild(option);
        });
    };

    document.getElementById('addGlobalBatch').onclick = () => {
        const selectedCatId = document.getElementById('newBatchCategory').value;
        const batchTitle = document.getElementById('newBatchTitle').value.trim();
        const batchThumbnail = document.getElementById('newBatchThumbnail').value.trim();

        if (!selectedCatId) {
            return msg('‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•à‡§ö ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!', 'warning');
        }
        if (!batchTitle) {
            return msg('‡§¨‡•à‡§ö ‡§ï‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤ ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!', 'warning');
        }
        if (!batchThumbnail) {
            return msg('‡§¨‡•à‡§ö ‡§ï‡•á ‡§≤‡§ø‡§è ‡§•‡§Ç‡§¨‡§®‡•á‡§≤ URL ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!', 'warning');
        }

        const newRef = push(ref(db, `categories/${selectedCatId}/batches`));
        set(newRef, { title: batchTitle, thumbnail: batchThumbnail })
            .then(() => {
                msg('‡§®‡§Ø‡§æ ‡§¨‡•à‡§ö ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
                document.getElementById('newBatchTitle').value = '';
                document.getElementById('newBatchThumbnail').value = '';
                // ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§â‡§® ‡§ï‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§™‡§∞ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                document.getElementById('newBatchCategory').value = "";
            })
            .catch(error => msg(`‡§¨‡•à‡§ö ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç error: ${error.message}`, 'danger'));
    };


    // ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§™‡§∞ Categories ‡§ï‡•ã ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
    loadCategories();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
